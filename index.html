<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#928981">
<title>Al√©rgenos ¬∑ Meli√°</title>
<link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Al%C3%A9rgenos%20Meli%C3%A1%22%2C%22short_name%22%3A%22Al%C3%A9rgenos%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23F3F2F2%22%2C%22theme_color%22%3A%22%23928981%22%7D">
<link href="https://fonts.googleapis.com/css2?family=Libre+Caslon+Text:wght@400;700&display=swap" rel="stylesheet">
<link href="https://use.typekit.net/fvb1vnf.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --warm8:#928981;--warm8-80:#A29B97;--warm8-60:#B9B4B1;--warm8-40:#D1CDCB;
  --warm8-20:#E8E6E5;--warm8-10:#F3F2F2;--warm8-05:#F8F7F6;--warm4:#B4ACA7;--gray-comp:#E2E5E5;
  --bg:#F3F2F2;--white:#fff;--text:#3a3632;--text2:var(--warm8);--text3:var(--warm8-60);
  --green:#5a7a5a;--red:#8c3a3a;--radius:8px;
  --serif:'Libre Caslon Text',Georgia,'Times New Roman',serif;
  --sans:graphik,'Graphik Web',-apple-system,Arial,Helvetica,sans-serif;
  --card-shadow:0 2px 8px rgba(58,54,50,.06);--card-radius:12px;
}
html,body{height:100%;font-family:var(--sans);background:var(--bg);color:var(--text);overflow:hidden;font-size:14px}

/* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
#loginScreen{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center}
#loginScreen.hidden{display:none}
.login-box{width:90%;max-width:340px;text-align:center;padding:20px}
.login-logo{font-family:var(--serif);font-size:13px;letter-spacing:4px;color:var(--warm8);margin-bottom:12px;text-transform:uppercase;font-weight:400}
.login-title{font-family:var(--serif);font-size:32px;font-weight:400;color:var(--text);margin-bottom:8px;letter-spacing:-0.5px}
.login-sub{font-size:13px;color:var(--text3);margin-bottom:36px;letter-spacing:0.3px}
.login-field{width:100%;padding:13px 14px;border:1px solid var(--warm8-40);border-radius:var(--radius);font-size:14px;font-family:var(--sans);color:var(--text);outline:none;margin-bottom:10px;background:var(--white);transition:border-color .2s}
.login-field:focus{border-color:var(--warm8)}
.login-field::placeholder{color:var(--warm8-60)}
.login-btn{width:100%;padding:14px;border-radius:var(--radius);border:none;background:var(--warm8);color:#fff;font-size:14px;font-weight:500;font-family:var(--sans);cursor:pointer;letter-spacing:0.5px;margin-top:4px;transition:opacity .15s}
.login-btn:active{opacity:.8}
.login-error{font-size:12px;color:var(--red);margin-top:10px;min-height:18px}
.login-version{font-size:10px;color:var(--warm8-60);margin-top:32px;letter-spacing:0.5px}

/* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
#app{display:none;flex-direction:column;height:100dvh;max-width:500px;margin:0 auto;position:relative}
#app.show{display:flex}
.hdr{padding:24px 16px 0;flex-shrink:0;background:var(--bg)}
.hdr-row{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:18px}
.hdr h1{font-family:var(--serif);font-size:26px;font-weight:400;letter-spacing:-0.3px;color:var(--text)}
.hdr-right{display:flex;align-items:center;gap:10px}
.hdr-count{font-size:11px;color:var(--text3);font-weight:400;letter-spacing:0.8px;text-transform:uppercase}
.hdr-btn{width:44px;height:50px;border-radius:var(--radius);background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:var(--warm8);transition:background .15s;margin-left:6px}
.hdr-btn:active{background:var(--warm8-10)}
.btn-icon{font-size:20px;line-height:1}
.btn-label{font-size:9px;font-weight:500;letter-spacing:0.3px;text-transform:uppercase}
.search{position:relative;margin-bottom:10px}
.search svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:15px;height:15px;color:var(--warm8-60);pointer-events:none}
.search input{width:100%;background:var(--white);border:1px solid var(--warm8-40);border-radius:var(--radius);padding:11px 40px 11px 36px;font-size:14px;color:var(--text);font-family:var(--sans);outline:none;transition:border-color .2s}
.search input:focus{border-color:var(--warm8)}
.search input::placeholder{color:var(--warm8-60)}
.x-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:20px;height:20px;border-radius:50%;background:var(--warm8-20);border:none;color:var(--warm8);font-size:12px;cursor:pointer;display:none;align-items:center;justify-content:center}
.x-btn.on{display:flex}
.filter-row{display:flex;gap:4px;align-items:center;overflow-x:auto;padding:0 0 14px;scrollbar-width:thin;scrollbar-color:var(--warm8-60) var(--warm8-20)}
.filter-row::-webkit-scrollbar{display:block;height:8px}
.filter-row::-webkit-scrollbar-track{background:var(--warm8-20);border-radius:4px}
.filter-row::-webkit-scrollbar-thumb{background:var(--warm8-60);border-radius:4px}
.filter-row::-webkit-scrollbar-thumb:hover{background:var(--warm8)}
.ftag{flex-shrink:0;width:36px;height:36px;border-radius:var(--radius);border:1px solid var(--warm8-40);background:var(--white);cursor:pointer;padding:4px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.ftag img{width:100%;height:100%;object-fit:contain}
.ftag.active{border-color:var(--warm8);background:var(--warm8-20);box-shadow:0 0 0 1px var(--warm8-60)}
.ftag-sin{flex-shrink:0;height:36px;padding:0 10px;border-radius:var(--radius);border:1px solid var(--warm8-40);background:var(--white);cursor:pointer;font-size:11px;font-weight:600;color:var(--text2);font-family:var(--sans);display:flex;align-items:center;gap:4px;transition:all .15s;letter-spacing:0.3px}
.ftag-sin.active{border-color:var(--green);background:var(--green);color:#fff}
.ftag-clear{flex-shrink:0;height:36px;padding:0 8px;border-radius:var(--radius);border:1px solid var(--warm8-40);background:var(--white);cursor:pointer;font-size:10px;color:var(--warm8-60);font-family:var(--sans);display:none;align-items:center;letter-spacing:0.3px}
.ftag-clear.show{display:flex}
.list{flex:1;overflow-y:auto;padding:0 16px 20px;-webkit-overflow-scrolling:touch;position:relative}
.ptr-indicator{position:absolute;top:-50px;left:50%;transform:translateX(-50%);width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;transition:top .2s,opacity .2s;opacity:0;pointer-events:none}
.ptr-indicator.active{top:10px;opacity:1}
.card{background:var(--white);border:1px solid var(--warm8-20);border-radius:var(--radius);padding:12px 14px;margin-bottom:6px;cursor:pointer;transition:all .2s}
.card:active{background:var(--warm8-10)}
.card.highlight{border-color:var(--warm8);box-shadow:0 0 0 2px var(--warm8-60);transition:all .3s}
.card.audit-high{border-color:#e53e3e;box-shadow:0 0 0 2px rgba(229,62,62,.25)}
.card.audit-medium{border-color:#dd6b20;box-shadow:0 0 0 2px rgba(221,107,32,.2)}
.audit-section-header{font-size:12px;font-weight:600;color:#c53030;letter-spacing:.5px;text-transform:uppercase;padding:8px 2px 4px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.audit-section-header span{background:#e53e3e;color:#fff;border-radius:10px;padding:1px 7px;font-size:11px}
.audit-separator{border:none;border-top:1px solid var(--warm8-20);margin:10px 0 8px}
.audit-badge{display:inline-block;font-size:10px;font-weight:600;padding:1px 6px;border-radius:8px;margin-left:6px;vertical-align:middle}
.audit-badge.high{background:#fff5f5;color:#c53030;border:1px solid #fc8181}
.audit-badge.medium{background:#fffaf0;color:#c05621;border:1px solid #f6ad55}
.audit-dismiss-btn{width:100%;padding:10px;border-radius:var(--radius);border:1.5px solid var(--warm8-40);background:transparent;color:var(--text2);font-size:13px;font-family:var(--sans);cursor:pointer;margin-top:8px}
.audit-dismiss-btn:active{background:var(--warm8-10)}
.audit-running-overlay{position:fixed;inset:0;background:rgba(58,54,50,.5);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
.audit-running-box{background:#fff;border-radius:16px;padding:28px 32px;text-align:center;max-width:300px}
.audit-running-box p{font-size:14px;color:var(--text);margin:0}
.audit-spinner{width:32px;height:32px;border:3px solid var(--warm8-20);border-top-color:var(--warm8);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.card-name{font-size:14px;font-weight:500;line-height:1.4;margin-bottom:6px;color:var(--text);letter-spacing:-0.1px}
.card-name mark{background:var(--warm8-20);color:var(--text);border-radius:2px;padding:0 2px}
.icons-row{display:flex;flex-wrap:wrap;gap:5px;align-items:center}
.a-icon{width:28px;height:28px;object-fit:contain}
.safe{color:var(--green);font-size:12px;font-weight:500;letter-spacing:0.2px}
.a-count{font-size:11px;color:var(--text3);margin-top:6px;letter-spacing:0.2px}
.empty{text-align:center;padding:60px 20px;color:var(--text3);font-size:13px;font-family:var(--serif);font-style:italic}
.bottom-bar{display:flex;gap:8px;padding:10px 16px;flex-shrink:0;background:var(--bg);border-top:1px solid var(--warm8-20)}
.add-btn{flex:1;height:46px;border-radius:var(--radius);background:var(--warm8);border:none;color:#fff;font-size:13px;font-weight:500;font-family:var(--sans);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:transform .1s;letter-spacing:0.5px}
.add-btn:active{transform:scale(0.97)}
.cancel-review-btn{flex:1;height:46px;border-radius:var(--radius);background:var(--warm8-20);border:1px solid var(--warm8-40);color:var(--text);font-size:12px;font-weight:600;font-family:var(--sans);cursor:pointer;display:none;align-items:center;justify-content:center;gap:6px;letter-spacing:0.5px}
.cancel-review-btn:active{background:var(--warm8-10)}
.queue-bar{display:none;padding:8px 16px;background:var(--warm8-10);border-top:1px solid var(--warm8-20);flex-shrink:0}
.queue-bar.show{display:flex;align-items:center;gap:8px}
.queue-dot{width:7px;height:7px;border-radius:50%;background:var(--warm8);flex-shrink:0}
.queue-dot.pulse{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.queue-text{font-size:11px;font-weight:500;color:var(--warm8);flex:1}
.queue-action{font-size:10px;font-weight:600;color:var(--warm8);background:none;border:1px solid var(--warm8);border-radius:4px;padding:4px 10px;cursor:pointer;font-family:var(--sans);letter-spacing:0.5px;text-transform:uppercase}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);padding:12px 20px;border-radius:var(--radius);font-size:13px;font-weight:500;z-index:200;transition:transform .3s ease;max-width:90%;text-align:center;line-height:1.4;color:#fff;font-family:var(--sans)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast-update{background:var(--warm8)}.toast-new{background:var(--green)}.toast-queue{background:#5d4d44}.toast-info{background:var(--text)}
.modal-bg{position:fixed;inset:0;background:rgba(58,54,50,.35);z-index:100;display:none;align-items:flex-end;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:var(--white);border-radius:12px 12px 0 0;width:100%;max-width:500px;max-height:92vh;overflow-y:auto;padding:24px 16px 32px;animation:slideUp .25s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal h2{font-family:var(--serif);font-size:22px;font-weight:400;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;color:var(--text);letter-spacing:-0.3px}
.modal-close{width:28px;height:28px;border-radius:50%;background:var(--warm8-10);border:none;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--warm8)}
.methods{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:18px}
.method-btn{padding:16px 10px;border-radius:var(--radius);border:1px solid var(--warm8-40);background:var(--white);cursor:pointer;text-align:center;font-family:var(--sans);transition:all .15s}
.method-btn.active{border-color:var(--warm8);background:var(--warm8-10)}
.method-btn .m-icon{font-size:22px;margin-bottom:6px}
.method-btn .m-label{font-size:11px;font-weight:600;color:var(--text2);letter-spacing:0.5px;text-transform:uppercase}
.method-btn .m-desc{font-size:10px;color:var(--text3);margin-top:4px;line-height:1.3}
.form-section{display:none}.form-section.show{display:block}
.form-label{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px;display:block;letter-spacing:0.5px;text-transform:uppercase}
.form-input{width:100%;padding:11px 12px;border:1px solid var(--warm8-40);border-radius:var(--radius);font-size:14px;font-family:var(--sans);color:var(--text);outline:none;margin-bottom:14px}
.form-input:focus{border-color:var(--warm8)}
.allergen-grid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:18px}
.ag-item{width:40px;height:40px;border-radius:var(--radius);border:1px solid var(--warm8-40);background:var(--white);cursor:pointer;padding:5px;transition:all .15s;display:flex;align-items:center;justify-content:center}
.ag-item img{width:100%;height:100%;object-fit:contain;opacity:.3;transition:opacity .15s}
.ag-item.sel{border-color:var(--warm8);background:var(--warm8-10)}
.ag-item.sel img{opacity:1}
.save-btn{width:100%;padding:14px;border-radius:var(--radius);border:none;background:var(--warm8);color:#fff;font-size:13px;font-weight:500;font-family:var(--sans);cursor:pointer;transition:opacity .15s;letter-spacing:0.8px;text-transform:uppercase}
.save-btn:disabled{opacity:.35;cursor:not-allowed}
.btn-row{display:flex;gap:8px;margin-top:10px}
.btn-delete{width:100%;padding:13px;border-radius:var(--radius);border:1px solid var(--red);background:none;color:var(--red);font-size:12px;font-weight:600;font-family:var(--sans);cursor:pointer;letter-spacing:0.5px;text-transform:uppercase}
.match-box{background:var(--warm8-10);border:1px solid var(--warm8-40);border-radius:var(--radius);padding:12px;margin-bottom:14px;display:none}
.match-box.show{display:block}
.match-title{font-size:11px;font-weight:600;color:var(--warm8);margin-bottom:4px;letter-spacing:0.3px;text-transform:uppercase}
.match-name{font-size:13px;font-weight:500;margin-bottom:2px}
.match-detail{font-size:11px;color:var(--text2);line-height:1.5}
.cam-area{text-align:center}
.photo-pair{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.photo-slot{aspect-ratio:3/4;border-radius:var(--radius);border:1.5px dashed var(--warm8-40);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative;background:var(--warm8-10)}
.photo-slot.filled{border-style:solid;border-color:var(--warm8-60)}
.photo-slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:calc(var(--radius) - 2px)}
.photo-slot .slot-label{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;z-index:1}
.photo-slot .slot-icon{font-size:20px;margin-bottom:4px;z-index:1}
.photo-slot.filled .slot-label,.photo-slot.filled .slot-icon{display:none}
.cam-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.cam-btn{padding:14px;border-radius:var(--radius);border:1px solid var(--warm8-40);background:var(--white);font-family:var(--sans);font-size:12px;font-weight:600;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
.cam-btn:active{background:var(--warm8-10)}
.cam-input{display:none}
.ai-status{font-size:12px;color:var(--text2);padding:12px;border-radius:var(--radius);background:var(--warm8-10);margin-bottom:14px;display:none;line-height:1.5}
.ai-status.show{display:block}
.spinner{display:inline-block;width:12px;height:12px;border:2px solid var(--warm8-40);border-top-color:var(--warm8);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.ai-result{display:none}.ai-result.show{display:block}
.ai-warn{font-size:11px;color:var(--warm8);margin-bottom:8px;font-weight:500}
.offline-banner{display:none;padding:6px 16px;background:var(--warm8-20);text-align:center;font-size:11px;font-weight:600;color:var(--red);flex-shrink:0;letter-spacing:0.3px}
.offline-banner.show{display:block}

/* ‚îÄ‚îÄ‚îÄ SETTINGS MODAL (tarjetas estilo Meli√°) ‚îÄ‚îÄ‚îÄ */
#settingsBg .modal{background:var(--bg);padding:20px 16px 28px}
#settingsBg .modal h2{font-family:var(--serif);font-size:24px;font-weight:400;letter-spacing:-0.3px;color:var(--text);margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--warm8-20)}
.settings-section{background:var(--white);border-radius:var(--card-radius);box-shadow:var(--card-shadow);border:1px solid var(--warm8-20);padding:18px 16px;margin-bottom:12px}
.settings-section:last-of-type{margin-bottom:16px}
.settings-section h3{font-family:var(--serif);font-size:16px;font-weight:400;letter-spacing:0.2px;color:var(--text);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--warm8-10);display:flex;align-items:center;gap:8px}
.settings-info{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:12px;font-family:var(--sans)}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;min-height:44px}
.settings-row:not(:last-child){border-bottom:1px solid var(--warm8-10)}
.settings-label{font-size:13px;color:var(--text);font-family:var(--sans)}
.settings-val{font-size:13px;color:var(--text2);font-weight:500;font-family:var(--sans)}
.settings-section .save-btn,.settings-section .api-key-save{margin-top:12px;height:44px;border-radius:var(--radius);font-size:12px;letter-spacing:0.5px;display:flex;align-items:center;justify-content:center;gap:8px}
.settings-section .btn-row{display:flex;gap:8px;margin-top:12px}
.settings-section .btn-row .save-btn{flex:1;margin-top:0;height:44px}
.api-key-input{width:100%;padding:12px 14px;border:1px solid var(--warm8-40);border-radius:var(--radius);font-size:13px;font-family:monospace;color:var(--text);outline:none;margin-bottom:8px}
.api-key-input:focus{border-color:var(--warm8)}
.api-key-save{padding:0 20px;height:44px;border-radius:var(--radius);border:none;background:var(--warm8);color:#fff;font-size:12px;font-family:var(--sans);cursor:pointer;font-weight:500}
.api-key-status{font-size:12px;margin-top:8px;font-weight:500;font-family:var(--sans)}
.api-key-status.ok{color:var(--green)}
.api-key-status.no{color:var(--warm8-60)}
#settingsBg .settings-section [id^="syncStatusPanel"],#settingsBg .settings-section [id="syncManualStatus"],#settingsBg .settings-section [id="appStatus"]{margin-top:12px;padding:14px;background:var(--warm8-05);border-radius:var(--radius);font-size:12px;line-height:1.7;border:1px solid var(--warm8-10)}
#settingsBg #logContainer{background:var(--warm8-05);border-radius:var(--radius);padding:14px;margin:12px 0;max-height:280px;overflow-y:auto;font-family:monospace;font-size:11px;line-height:1.8;border:1px solid var(--warm8-10)}
.logout-btn{width:100%;padding:14px;border-radius:var(--card-radius);border:1px solid var(--red);background:var(--white);color:var(--red);font-size:13px;font-weight:500;font-family:var(--sans);cursor:pointer;margin-top:8px;box-shadow:var(--card-shadow);transition:background .15s,color .15s}
.logout-btn:active{background:var(--red);color:#fff}
.sync-status-grid{display:grid;grid-template-columns:1fr;gap:2px}
.sync-status-grid div{padding:4px 0;border-bottom:1px solid var(--warm8-10);font-size:12px}
.sync-status-grid div:last-child{border-bottom:none}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">MELI√Å</div>
    <div class="login-title">Al√©rgenos</div>
    <div class="login-sub">Gesti√≥n de al√©rgenos alimentarios</div>
    <input class="login-field" id="loginUser" type="text" placeholder="Usuario" autocomplete="username" autocapitalize="none">
    <input class="login-field" id="loginPass" type="password" placeholder="Contrase√±a" autocomplete="current-password">
    <button class="login-btn" id="loginBtn">Entrar</button>
    <div class="login-error" id="loginError"></div>
    <div class="login-version">v1.03.2026.11:34h</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ -->
<div id="app">
  <div class="offline-banner" id="offlineBanner">Sin conexi√≥n ‚Äî las fotos se guardan en cola</div>
  <div class="hdr">
    <div class="hdr-row">
      <h1>Al√©rgenos</h1>
      <div class="hdr-right">
        <span class="hdr-count" id="cnt"></span>
        <button class="hdr-btn" id="syncBtn" title="Sincronizaci√≥n forzada">
          <div class="btn-icon">‚ü≥</div>
          <div class="btn-label">Sync</div>
        </button>
        <button class="hdr-btn" id="gearBtn" title="Ajustes">
          <div class="btn-icon">‚öô</div>
          <div class="btn-label">Ajustes</div>
        </button>
      </div>
    </div>
    <div class="search"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="7.5"/><path d="m20 20-3.5-3.5"/></svg><input id="q" type="text" placeholder="Buscar producto‚Ä¶" autocomplete="off" autocorrect="on" spellcheck="false"><button class="x-btn" id="xb">&times;</button></div>
    <div class="filter-row" id="fl"></div>
  </div>
  <div class="list" id="ls"><div class="ptr-indicator" id="ptrIndicator">‚ü≥</div></div>
  <div class="queue-bar" id="queueBar"><div class="queue-dot" id="queueDot"></div><span class="queue-text" id="queueText"></span><button class="queue-action" id="queueAction">Procesar</button></div>
  <div class="bottom-bar"><button class="add-btn" id="addBtn">+ A√±adir producto</button><button class="cancel-review-btn" id="cancelReviewBtn">Cancelar revisi√≥n</button></div>
</div>
<div class="toast" id="toast"></div>

<!-- ADD/EDIT MODAL -->
<div class="modal-bg" id="modalBg"><div class="modal">
  <h2 id="modalTitle">A√±adir producto <button class="modal-close" id="modalClose">&times;</button></h2>
  <div class="methods" id="methodsRow">
    <button class="method-btn active" data-method="manual">
      <div class="m-icon">‚úèÔ∏è</div>
      <div class="m-label">Manual</div>
      <div class="m-desc">Escribir nombre y al√©rgenos</div>
    </button>
    <button class="method-btn" data-method="camera">
      <div class="m-icon">üì∑</div>
      <div class="m-label">Fotograf√≠a</div>
      <div class="m-desc">Analizar y revisar antes de guardar</div>
    </button>
    <button class="method-btn" data-method="batch">
      <div class="m-icon">üñºÔ∏è</div>
      <div class="m-label">Lote</div>
      <div class="m-desc">Procesar hasta 10 fotos de golpe</div>
    </button>
  </div>
  <div class="form-section show" id="secManual">
    <label class="form-label">Nombre del producto</label>
    <input class="form-input" id="manualName" placeholder="Ej: Galletas integrales" autocomplete="off" lang="es" spellcheck="true">
    <div class="match-box" id="manualMatch"><div class="match-title">Producto similar encontrado</div><div class="match-name" id="manualMatchName"></div><div class="match-detail" id="manualMatchDetail"></div></div>
    <label class="form-label">Al√©rgenos</label>
    <div class="allergen-grid" id="manualAllergens"></div>
    <button class="save-btn" id="manualSave" disabled>Guardar producto</button>
    <div id="auditDismissRow" style="display:none"><button class="audit-dismiss-btn" id="auditDismissBtn">üëÅ No mostrar m√°s esta advertencia</button></div>
    <div class="btn-row" id="editBtns" style="display:none"><button class="btn-delete" id="deleteBtn">Eliminar producto</button></div>
  </div>
  <div class="form-section" id="secCamera">
    <div class="cam-area">
      <div class="photo-pair">
        <div class="photo-slot" id="slot1"><span class="slot-icon">üì¶</span><span class="slot-label">Envase</span><img id="img1" style="display:none"></div>
        <div class="photo-slot" id="slot2"><span class="slot-icon">üè∑Ô∏è</span><span class="slot-label">Etiquetado</span><img id="img2" style="display:none"></div>
      </div>
      <div class="cam-btns"><button class="cam-btn" id="btnCapture">üì∑ Hacer foto</button><button class="cam-btn" id="btnGallery">üñºÔ∏è Galer√≠a</button></div>
      <input type="file" accept="image/*" capture="environment" class="cam-input" id="camInput">
      <input type="file" accept="image/*" class="cam-input" id="galInput">
      <div class="ai-status" id="aiStatus"></div>
      <button class="save-btn" id="analyzeBtn" style="background:var(--warm8-80);margin-bottom:14px;display:none">Analizar etiquetado</button>
    </div>
    <div class="ai-result" id="aiResult">
      <label class="form-label">Producto detectado</label>
      <input class="form-input" id="aiName" placeholder="Nombre del producto" lang="es" spellcheck="true">
      <div class="match-box" id="aiMatch"><div class="match-title">Producto similar encontrado</div><div class="match-name" id="aiMatchName"></div><div class="match-detail" id="aiMatchDetail"></div></div>
      <label class="form-label">Al√©rgenos detectados</label>
      <div class="ai-warn" id="aiWarn"></div>
      <div class="allergen-grid" id="aiAllergens"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="save-btn" id="aiCancel" style="flex:1;min-width:120px;background:var(--warm8-20);color:var(--text)">Cancelar</button>
        <button class="save-btn" id="aiSave" disabled style="flex:1;min-width:120px">Guardar producto</button>
      </div>
    </div>
  </div>
  <div class="form-section" id="secBatch">
    <div class="cam-area">
      <input type="file" accept="image/*" multiple class="cam-input" id="batchInput">
      <button class="save-btn" id="batchSelectBtn" style="margin-bottom:14px">Seleccionar hasta 10 fotos</button>
      <div class="ai-status" id="batchStatus"></div>
      <div id="batchPreview" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:14px"></div>
    </div>
  </div>
</div></div>

<!-- CONFIRM DELETE -->
<div class="modal-bg" id="confirmBg"><div class="modal" style="border-radius:12px;max-width:340px;margin:auto;padding:24px 20px;text-align:center">
  <h2 style="justify-content:center;margin-bottom:8px">¬øEliminar producto?</h2>
  <p style="font-size:13px;color:var(--text2);margin-bottom:20px" id="confirmText"></p>
  <div style="display:flex;gap:8px"><button class="save-btn" id="confirmCancel" style="background:var(--warm8-20);color:var(--text)">Cancelar</button><button class="save-btn" id="confirmDelete" style="background:var(--red)">Eliminar</button></div>
</div></div>

<!-- PHOTO WARNING -->
<div class="modal-bg" id="photoWarningBg"><div class="modal" style="border-radius:12px;max-width:360px;margin:auto;padding:24px 20px;text-align:center">
  <div style="font-size:32px;margin-bottom:12px">‚ö†Ô∏è</div>
  <h2 style="justify-content:center;margin-bottom:12px">Problema detectado</h2>
  <p style="font-size:14px;color:var(--text);margin-bottom:8px;font-weight:500" id="warningProduct"></p>
  <p style="font-size:13px;color:var(--text2);margin-bottom:20px;line-height:1.5" id="warningText"></p>
  <button class="save-btn" id="warningOk">Entendido</button>
</div></div>

<!-- ERROR MODAL (con miniatura) -->
<div class="modal-bg" id="errorModalBg" style="z-index:10001"><div class="modal" style="border-radius:12px;max-width:420px;margin:auto;padding:24px 20px">
  <div style="text-align:center">
    <div style="font-size:40px;margin-bottom:12px">‚ö†Ô∏è</div>
    <h2 style="justify-content:center;margin-bottom:16px">No se pudo registrar</h2>
  </div>
  <div id="errorThumbnail" style="width:120px;height:120px;margin:0 auto 16px;border-radius:8px;background-size:cover;background-position:center;border:2px solid var(--warm8-40)"></div>
  <div style="background:var(--warm8-10);border-radius:8px;padding:12px;margin-bottom:16px">
    <div style="font-size:12px;color:var(--text2);margin-bottom:4px">Producto:</div>
    <div style="font-size:14px;color:var(--text);font-weight:500;margin-bottom:12px" id="errorProductName"></div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:4px">Motivo:</div>
    <div style="font-size:13px;color:var(--red);line-height:1.4" id="errorReason"></div>
  </div>
  <button class="save-btn" id="errorModalOk">Aceptar</button>
</div></div>

<!-- BATCH SUMMARY MODAL (con miniaturas) -->
<div class="modal-bg" id="batchSummaryBg" style="z-index:10002"><div class="modal" style="border-radius:12px;max-width:480px;margin:auto;padding:24px 20px;max-height:80vh;overflow-y:auto">
  <h2 style="justify-content:center;margin-bottom:16px">üìä Resumen del lote</h2>
  <div id="batchSummaryContent"></div>
  <button class="save-btn" id="batchSummaryOk" style="margin-top:16px">Aceptar</button>
</div></div>

<!-- BATCH PENDING REVIEW MODAL (revisi√≥n manual una por una) -->
<div class="modal-bg" id="batchReviewModalBg" style="z-index:10003"><div class="modal audit-medium" style="border-radius:12px;max-width:420px;margin:auto;padding:24px 20px;border:2px solid var(--red);box-shadow:0 0 0 4px rgba(197,48,48,.2);background:#fffbfb">
  <h2 style="justify-content:center;margin-bottom:8px;color:var(--red)">‚ö†Ô∏è Pendiente de revisi√≥n</h2>
  <p style="font-size:12px;color:var(--text2);margin-bottom:12px;text-align:center" id="batchReviewCounter"></p>
  <div id="batchReviewThumb" style="width:120px;height:120px;margin:0 auto 12px;border-radius:8px;background-size:cover;background-position:center;border:2px solid var(--red)"></div>
  <div style="font-size:13px;font-weight:600;margin-bottom:4px" id="batchReviewName"></div>
  <div style="font-size:11px;color:var(--red);margin-bottom:12px;line-height:1.4;background:#fff5f5;padding:10px;border-radius:8px;border:1px solid var(--red)" id="batchReviewReason"></div>
  <div style="font-size:11px;color:var(--text2);margin-bottom:12px" id="batchReviewAllergens"></div>
  <div style="display:flex;flex-direction:column;gap:8px">
    <button class="save-btn" id="batchReviewConfirmBtn">Confirmar y guardar</button>
    <button class="save-btn" id="batchReviewCorrectBtn" style="background:var(--warm8-80)">Corregir y guardar</button>
    <button class="save-btn" id="batchReviewSkipBtn" style="background:var(--warm8-20);color:var(--text)">Saltar (no guardar)</button>
  </div>
</div></div>

<!-- SETTINGS MODAL -->
<div class="modal-bg" id="settingsBg"><div class="modal">
  <h2>Ajustes <button class="modal-close" id="settingsClose">&times;</button></h2>
  <div class="settings-section">
    <h3>Cuenta</h3>
    <div class="settings-row"><span class="settings-label">Usuario</span><span class="settings-val" id="settingsUser">administrador</span></div>
    <div class="settings-row"><span class="settings-label">Rol</span><span class="settings-val">Administrador</span></div>
  </div>
  <div class="settings-section">
    <h3>Sincronizaci√≥n Google Drive</h3>
    <div class="settings-info">Conecta tu Google Drive para sincronizar autom√°ticamente entre dispositivos. Los datos se guardan en: <strong>BaseDatos_Israel_NoEliminar_Sincronizacion</strong></div>
    <div style="margin-bottom:10px">
      <label style="font-size:12px;color:var(--text2)">Client ID de Google (obligatorio para conectar)</label>
      <input class="api-key-input" id="gdriveClientIdInput" type="text" placeholder="xxx.apps.googleusercontent.com" style="margin-top:4px;width:100%">
    </div>
    <div style="margin-bottom:10px">
      <label style="font-size:12px;color:var(--text2)">API Key de Google (obligatorio para Drive)</label>
      <input class="api-key-input" id="gdriveApiKeyInput" type="password" placeholder="AIza..." style="margin-top:4px;width:100%">
    </div>
    <button class="save-btn" id="gdriveConfigSave" style="background:var(--warm8-60);margin-bottom:12px">Guardar configuraci√≥n Google</button>
    <button class="save-btn" id="gdriveConnectBtn" style="background:#4285f4;color:#fff">üîó Conectar Google Drive</button>
    <button class="save-btn" id="gdriveDisconnectBtn" style="background:var(--red);display:none">Desconectar Google Drive</button>
    <button class="save-btn" id="gdriveSyncManualBtn" style="background:var(--warm8-80);display:none">üîÑ Sincronizar ahora</button>
    <div id="syncManualStatus" style="margin-top:12px;display:none"></div>
    <div class="settings-row" id="gdriveStatus" style="display:none">
      <span class="settings-label">Estado</span>
      <span class="settings-val" id="gdriveStatusText">Desconectado</span>
    </div>
    <div class="settings-info" id="gdriveLastSync" style="margin-top:8px;display:none;font-size:11px;color:var(--warm8-60)"></div>
    <div id="syncStatusPanel" style="margin-top:14px;display:none"></div>
  </div>

  <div class="settings-section">
    <h3>Lectura de etiquetas (IA)</h3>
    <div class="settings-info">Para usar la c√°mara con lectura autom√°tica de etiquetas y la revisi√≥n de incoherencias, necesitas una clave API de Google (Gemini). Si no la tienes, la funci√≥n de c√°mara no funcionar√°, pero la consulta y edici√≥n manual siguen disponibles.</div>
    <input class="api-key-input" id="apiKeyInput" type="password" placeholder="AIza... (clave Gemini)">
    <div class="btn-row">
      <button class="api-key-save" id="apiKeySave" style="flex:1">Guardar clave</button>
      <button class="save-btn" id="apiKeyTestBtn" style="flex:1;background:var(--warm8-80)">Probar conexi√≥n IA</button>
    </div>
    <div class="api-key-status no" id="apiKeyStatus">Sin clave configurada</div>
    <div class="settings-info" id="apiKeyTestStatus" style="display:none;margin-top:8px;font-size:12px"></div>
    <div id="apiKeyOriginWarning" style="display:none;margin-top:10px;padding:10px;background:#fff5f5;border:1px solid #fc8181;border-radius:var(--radius);font-size:12px;color:#c53030;line-height:1.5"></div>
    <div class="settings-row" style="margin-top:16px;padding-top:14px;border-top:1px solid var(--warm8-10)">
      <span class="settings-label">Advertencias de calidad de foto</span>
      <label style="display:flex;align-items:center;cursor:pointer">
        <input type="checkbox" id="photoWarningsToggle" style="width:18px;height:18px;cursor:pointer">
      </label>
    </div>
  </div>
  <div class="settings-section">
    <h3>Base de datos</h3>
    <div class="settings-row"><span class="settings-label">Productos</span><span class="settings-val" id="settingsCount">0</span></div>
    <div class="settings-row"><span class="settings-label">Versi√≥n</span><span class="settings-val">1.0 pruebas</span></div>
    <button class="save-btn" id="exportExcelBtn" style="background:var(--warm8-80)">Exportar Excel</button>
  </div>
  <div class="settings-section">
    <h3>üîç Revisi√≥n de incoherencias</h3>
    <div class="settings-info">Analiza toda la base de datos para detectar al√©rgenos que probablemente faltan o que parecen incorrectos. Usa reglas locales e inteligencia artificial.</div>
    <button class="save-btn" id="auditRunBtn" style="background:var(--warm8)">Ejecutar revisi√≥n de incoherencias</button>
    <div id="auditLastRun" style="font-size:11px;color:var(--text2);margin-top:8px;display:none"></div>
  </div>
  <div class="settings-section">
    <h3>üìù Registro de diagn√≥stico</h3>
    <div class="settings-info" style="margin-bottom:6px">Estado de la app y registro de lo que haces: <strong>sincronizaci√≥n</strong> (inicio, fin, subida/descarga, errores), <strong>revisi√≥n de incoherencias</strong>, guardados, fusiones, altas manuales, importaci√≥n Excel y errores. Exporta o copia para auditor√≠a.</div>
    <div id="appStatus"></div>
    <div id="logContainer"></div>
    <div class="btn-row">
      <button class="save-btn" id="copyLogsBtn">üìã Copiar diagn√≥stico completo</button>
      <button class="save-btn" id="clearLogsBtn" style="background:var(--warm8-40)">üóëÔ∏è Limpiar registro</button>
    </div>
  </div>
  <button class="logout-btn" id="logoutBtn">Cerrar sesi√≥n</button>
</div></div>

<script>
const INITIAL=[{"n":"Aceite de s√©samo","a":["S√âSAMO"]},{"n":"Aceitunas negras","a":[]},{"n":"Aceitunas verde salmuera sabor anchoas","a":["PESCADO"]},{"n":"Aceitunas verdes en salmuera","a":["PESCADO"]},{"n":"Aceitunas verdes partidas con hueso ali√±adas","a":["SULFITOS"]},{"n":"Aderezo l√≠quido ahumado botella","a":[]},{"n":"Ajada gallega","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Ajo","a":["SULFITOS"]},{"n":"Alb√≥ndigas a la jardinera carne mixta precocinado","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Alb√≥ndigas en bolsa para fre√≠r mixta","a":["CEREALES","SOJA","SULFITOS"]},{"n":"Alb√≥ndigas vegetales calabaza y zanahoria","a":["CEREALES"]},{"n":"Alcachofa congelada","a":[]},{"n":"Alcachofas con pisto","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Alcachofas congeladas","a":[]},{"n":"Alcachofas congeladas salteadas con ajo","a":["SULFITOS"]},{"n":"Alcachofas conservas","a":[]},{"n":"Alcachofas rebozadas fritas","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Alcachofas salteadas con ajo","a":["SULFITOS"]},{"n":"Alcaparras encurtidos","a":["SULFITOS"]},{"n":"Alchachofa de lata","a":[]},{"n":"Alitas de pollo asadas barcacoa formato bolsa cong","a":["APIO","CEREALES","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"All bran kelloggs cajita individual cereales","a":["CEREALES"]},{"n":"Almejas a la marinera","a":["APIO","MOLUSCO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Almendras crudas peladas","a":["CACAHUETES","CEREALES","FRUTOS SECOS","SOJA","SULFITOS"]},{"n":"Alubias con tomate","a":[]},{"n":"Alubias estofadas potaje","a":["APIO","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Anchoas ahumadas en aceite","a":["PESCADO"]},{"n":"Apio conservas","a":["APIO"]},{"n":"Arenques en conservas","a":["PESCADO"]},{"n":"Aros de cebolla frito","a":["APIO","CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Arroz basmati","a":[]},{"n":"Arroz bomba","a":[]},{"n":"Arroz caldoso de bogavante","a":["APIO","CRUST√ÅCEOS","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SULFITOS"]},{"n":"Arroz chocolateado bolsa cereales","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Atadillo de patata patata con langostinos","a":["CRUST√ÅCEOS","PESCADO","SOJA"]},{"n":"At√∫n a la plancha","a":["PESCADO"]},{"n":"At√∫n a la portuguesa","a":["APIO","HUEVO","L√ÅCTEO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"At√∫n ahumado","a":["PESCADO"]},{"n":"At√∫n conservas","a":["PESCADO"]},{"n":"Bacalao a la bilba√≠na","a":["MOLUSCO","PESCADO","SULFITOS"]},{"n":"Bacalao a la castellana","a":["FRUTOS SECOS","MOLUSCO","PESCADO","SULFITOS"]},{"n":"Bacalao a la plancha","a":["MOLUSCO","PESCADO"]},{"n":"Bacalao ahumado","a":["PESCADO"]},{"n":"Bacalao congelado","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Bacon ahumado lonchas al horno","a":["SOJA"]},{"n":"Baderillas picantes encurtidos","a":[]},{"n":"Baileys","a":[]},{"n":"Banda de frutas","a":["CEREALES","HUEVO"]},{"n":"Banderillas picantes toreras","a":["SULFITOS"]},{"n":"Barquillo","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Barra gallega","a":["CEREALES"]},{"n":"Batata prefrita ultracongelada","a":[]},{"n":"Bebida actimel","a":["L√ÅCTEO"]},{"n":"Bebida de avena","a":["CEREALES"]},{"n":"Bebida de soja","a":["SOJA"]},{"n":"Berenjenas fritas","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Berlidots bomb√≥n","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","SOJA"]},{"n":"Berros","a":[]},{"n":"Berry & white chocolate pie tarta chocolate blanco","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Besos fresas/nata az√∫car golosinas gominolas","a":["SOJA"]},{"n":"Bizcocho de almendras","a":["ALTRAMUZ","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Bizcocho de manzana","a":["ALTRAMUZ","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Bizcocho de zanahorias","a":["CEREALES","HUEVO"]},{"n":"Bizcochon de albaricoque","a":["ALTRAMUZ","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Bizcochon de malaga","a":["CEREALES","HUEVO","L√ÅCTEO"]},{"n":"Bloomer arandanos+pavo","a":["APIO","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Bombones de de foie gras de pato","a":["FRUTOS SECOS"]},{"n":"Bombones de foie gras de pato 100 unidades","a":["FRUTOS SECOS"]},{"n":"Boquerones en vinagre 500g","a":["PESCADO"]},{"n":"Boquerones fritos","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Bran flakes caja cereales a granel","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Bretzel de crema y almendras","a":["APIO","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","PESCADO","S√âSAMO","SOJA"]},{"n":"Brocheta de pavo plancha con piment√≥n","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Brocheta de pollo a la plancha con piment√≥n","a":["APIO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Brocheta de pollo yakitori caja 40g x 40u","a":["CEREALES","HUEVO","MOSTAZA","SOJA"]},{"n":"Br√≥coli cocido","a":[]},{"n":"Br√≥coli rebozado","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Brotes de soja conservas vigna radiata","a":[]},{"n":"Brownie con nueces 1.150g","a":["ALTRAMUZ","CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Brownie de chocolate rocky road 2760g","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Bu√±uelo de bacalao frito","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Caballa conservas","a":[]},{"n":"Cabracho a la plancha","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Cabracho gallineta","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Cacahuete choco blanco 1 kilo golosinas gominolas","a":["CACAHUETES","FRUTOS SECOS","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Cacahuete choco negro 1 kilo golosinas gominolas","a":["CACAHUETES","FRUTOS SECOS","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Calabac√≠n al vapor","a":[]},{"n":"Calabac√≠n rebozado frito","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Calamar a la plancha","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Calamar chipiron congelado","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Calamares a la riojana","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Calamares fritos calamaritos","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Calamares salsa americana precocinado","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Caldo concentrado de pollo liquido","a":[]},{"n":"Caldo concentrado granulado vegetal","a":["APIO","CEREALES","L√ÅCTEO","SOJA"]},{"n":"Caldo paella granulado knorr","a":["CRUST√ÅCEOS","PESCADO"]},{"n":"Caldo pescado granulado","a":["HUEVO","L√ÅCTEO","SOJA"]},{"n":"Caldo pollo granulado","a":["HUEVO","L√ÅCTEO","SOJA"]},{"n":"Caldo ternera liquida knorr","a":[]},{"n":"Callos","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Callos con garbanzos","a":["APIO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Callos con garbanzos guiso","a":["APIO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Callos de ternera barra","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Canela molida","a":["L√ÅCTEO"]},{"n":"Canelon carne congelado","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Canelon de espinaca congelado","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Canelones carne con bechamel y queso","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Canelones de espinacas con bechamel y queso","a":["APIO","CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA"]},{"n":"Can√≥nigos","a":[]},{"n":"Carabineros congelados","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Carrillada al vino dulce","a":["APIO"]},{"n":"Carrillada de ternera al vacio no al√©rgenos","a":[]},{"n":"Carrillera de ternera","a":[]},{"n":"Cazon en adobo (leche) frito","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO","SULFITOS"]},{"n":"Cebolla","a":[]},{"n":"Cebolla crujiente crispy","a":["CEREALES"]},{"n":"Cebolla morada","a":[]},{"n":"Cecina de vacuno","a":[]},{"n":"Champi√±√≥n lata champi√±ones","a":[]},{"n":"Chipirones a la plancha","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Chipotle lata 220g","a":[]},{"n":"Chirizo para cazuela o fre√≠r","a":["L√ÅCTEO","SULFITOS"]},{"n":"Chistorra al horno","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Choco fresco","a":["MOLUSCO"]},{"n":"Choco fresco a la plancha","a":["MOLUSCO"]},{"n":"Chocobolas blanco golosinas gominolas","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO","SOJA"]},{"n":"Chorizo","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Chorizo criollo a la plancha","a":["L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Chorizo extra vela cortado","a":["L√ÅCTEO"]},{"n":"Chorizo ib√©rico lonchas embutido","a":[]},{"n":"Chorizo para potajes horno","a":["L√ÅCTEO","SULFITOS"]},{"n":"Chorizo picante embutido","a":[]},{"n":"Chuleta de cordero a la plancha","a":[]},{"n":"Chuleta de ternera plancha","a":[]},{"n":"Churros lazo","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Chutney de mango \"Puede contener\"","a":["CACAHUETES","FRUTOS SECOS"]},{"n":"Cinta de lomo de cerdo plancha","a":[]},{"n":"Ciruela","a":["SULFITOS"]},{"n":"Ciruela sin hueso","a":["SULFITOS"]},{"n":"Ciruelas","a":["SULFITOS"]},{"n":"Clavo especias especias","a":[]},{"n":"Cochinillo asado a la segoviana","a":["SULFITOS"]},{"n":"Cochinita pibil congelada 2 kilos","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Cocktail mediterraneo","a":["SULFITOS"]},{"n":"Coco pops kelloggs cajita individual cereales","a":["CEREALES"]},{"n":"Codillo asado en su jugo precocinado barqueta 2 kilos","a":["SOJA"]},{"n":"Codillo de cerdo asado en su jugo porcion individual","a":["SOJA"]},{"n":"Col china","a":[]},{"n":"Col salteada","a":["SULFITOS"]},{"n":"Colas de langostinos rebozadas gambas orly","a":["APIO","CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA","SULFITOS"]},{"n":"Coles de bruselas al vapor","a":["APIO"]},{"n":"Coliflor rebozada","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Colorante alimentario","a":[]},{"n":"Comino grano especias","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Comino molido especias","a":["APIO","CEREALES","MOSTAZA","S√âSAMO"]},{"n":"Condimento hamburguesa (bote)","a":["APIO","FRUTOS SECOS","L√ÅCTEO","MOSTAZA","SULFITOS","S√âSAMO"]},{"n":"Contra de ternera asada en su jugo","a":["SULFITOS"]},{"n":"Cookie chispas","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Cookie chocolate","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Copa helada de tiramis√∫","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Copos de avena cereales","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Cordero al chilindron precocinado","a":["APIO","CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Cordero tandoori","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Corn flakes cajita individual cereales","a":["CEREALES"]},{"n":"Corn flakes cereales bolsa cereales","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Corn flakes sin gluten cereales","a":["SOJA"]},{"n":"Corvina a la plancha","a":["PESCADO"]},{"n":"Costillas cerdo a la barbacoa","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Country store kelloggs bolsita individual cereales","a":["CEREALES"]},{"n":"Cracker","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Crema de ave","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Crema de cacao y avellanas 900g","a":["FRUTOS SECOS","L√ÅCTEO"]},{"n":"Crema de calabac√≠n","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Crema de esp√°rragos verdes","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Crema de espinacas","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Crema de guisantes","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Crema de tomate","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Crema de verduras","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Cremas de patatas y verduras","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Croissant","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Croqueta snak crema jalape√±o","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA"]},{"n":"Croquetas at√∫n y piquillo","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas brandada de bacalao","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de arroz negro y alioli","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de cocido","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de gambas al ajillo","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA","SULFITOS"]},{"n":"Croquetas de ib√©rico","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de jam√≥n fritas","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de merluza y gambas","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de pollo","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de pollo fritas","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Croquetas de rabo de vacuno","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Croquetas de setas","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Curry de madras especias","a":["APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Curry de pollo con arroz basmati rrss","a":["APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"D√°tiles con bacon","a":["APIO","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","L√ÅCTEO","MOLUSCO","PESCADO","S√âSAMO","SULFITOS"]},{"n":"D√°tiles d√°til","a":[]},{"n":"Delicias de pollo kentucky american crispy fritas","a":["APIO","CEREALES","CRUST√ÅCEOS","MOLUSCO","MOSTAZA","PESCADO","SOJA"]},{"n":"Demi glace","a":["APIO","CEREALES","HUEVO","L√ÅCTEO","MOSTAZA"]},{"n":"Dorada a la plancha","a":["PESCADO"]},{"n":"Embutido vegano finas hierbas lonchas","a":["APIO","FRUTOS SECOS","HUEVO","MOSTAZA","S√âSAMO"]},{"n":"Empanada de at√∫n horneada","a":["APIO","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Empanado pollo moreno plaza","a":["CEREALES","HUEVO","L√ÅCTEO"]},{"n":"Eneldo especias formato bote","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Ensaimada","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Ensalada alemana barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada americana barqueta","a":["APIO","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada arroz 3 delicias barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada asi√°tica barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada c√©sar rrss","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA"]},{"n":"Ensalada de bulgur barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada de couscous barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada de lombarda barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada de quinoa barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada de repollo barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada de trigo barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada edamame barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada escalivada barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada ex√≥tica barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada griega barqueta","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada italiana barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada malague√±a casera","a":["HUEVO","PESCADO","SULFITOS"]},{"n":"Ensalada mediterranea barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada melia rrss","a":["CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SULFITOS"]},{"n":"Ensalada mexicana barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada patata japo formato barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada patatas alioli barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada pimiento asado cubo","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada pollo barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada taboule barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensalada tabul√©","a":["CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Ensaladilla de cangrejo cubo","a":["CRUST√ÅCEOS","HUEVO","PESCADO","SOJA"]},{"n":"Ensaladilla de pollo cubo","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA","SULFITOS","S√âSAMO"]},{"n":"Ensaladilla patatas con alioli cubo","a":["HUEVO"]},{"n":"Ensaladilla rusa cubo","a":["HUEVO","PESCADO"]},{"n":"Entrecot de ternera plancha","a":[]},{"n":"Espaguetis pasta seca","a":["CEREALES","HUEVO"]},{"n":"Esp√°rragos blancos conservas","a":["PESCADO"]},{"n":"Esp√°rragos blancos en conserva","a":[]},{"n":"Esp√°rragos verdes al vapor","a":[]},{"n":"Espinacas congeladas","a":[]},{"n":"Espinacas frescas","a":[]},{"n":"Espinacas frescas salteadas con piment√≥n","a":[]},{"n":"Estofado de ternera casero","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Fiambre de lomo horno de le√±a ahumado semicocido","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Fiambre pavo trufado chopped","a":["FRUTOS SECOS"]},{"n":"Filamentos guindilla \" hilos de chili\"","a":[]},{"n":"Filete de pollo empanado crujiente congelado","a":["CEREALES","SOJA"]},{"n":"Filete de pollo plancha","a":[]},{"n":"Filetes de ternera plancha","a":[]},{"n":"Flamenquin cerdo jam√≥n huevo men√∫s","a":["CEREALES","HUEVO","SOJA"]},{"n":"Flan de huevo con caramelo","a":["HUEVO","L√ÅCTEO"]},{"n":"Flan sabor vainilla danone","a":["L√ÅCTEO"]},{"n":"Focaccia de pollo crispy rrss","a":["APIO","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA"]},{"n":"Foie gras de pato escalopes congelado","a":[]},{"n":"Foie gras de pato lata","a":[]},{"n":"Frikandelle con cebolla","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Frutas del bosque ultra congeladas","a":[]},{"n":"Fuet","a":["L√ÅCTEO"]},{"n":"Gachas con avena","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Galleta de chocolate sin gluten","a":["L√ÅCTEO","SOJA"]},{"n":"Galleta melia rectangular individual ecol√≥gica","a":["CEREALES","SOJA"]},{"n":"Galleta sin gluten","a":["SOJA"]},{"n":"Galletas maria 800g","a":["CEREALES","S√âSAMO","SOJA","SULFITOS"]},{"n":"Galletas sin azucares","a":["CEREALES","L√ÅCTEO","S√âSAMO","SULFITOS"]},{"n":"Galletitas saladas golosinas gominolas","a":["CEREALES","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Gambas peladas congeladas/gamba pelada cruda","a":["CRUST√ÅCEOS","SULFITOS"]},{"n":"Gambones al horno","a":["CEREALES","CRUST√ÅCEOS","SULFITOS"]},{"n":"Garbanzos conservas lata","a":["SULFITOS"]},{"n":"Gazpacho casero","a":["CEREALES","SULFITOS"]},{"n":"Gazpachuelo","a":["CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Gofre","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Guacamole murimar deca formato bolsa no alergenos","a":[]},{"n":"Guacamole supreme formato bote 1 kilo","a":[]},{"n":"Guisantes al vapor","a":[]},{"n":"Gyozas de verduras","a":["CEREALES","S√âSAMO","SOJA"]},{"n":"Habitas baby lata","a":[]},{"n":"Habitas baby salteadas","a":["SULFITOS"]},{"n":"Hambuerguesa de de ternera plato rrss","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Hambuerguesas caseras de ternera","a":[]},{"n":"Hambuerguesas de pollo plancha","a":["CEREALES","SULFITOS"]},{"n":"Hamburguesa ternera carta formato barqueta","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Helado bomb√≥n vainilla nestle","a":["FRUTOS SECOS","L√ÅCTEO","SOJA"]},{"n":"Helado cucurucho turron nestle","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Helado lim√≥n vasito premium nestle","a":["L√ÅCTEO"]},{"n":"Helado nata fresa vasito premium nestle","a":["FRUTOS SECOS","L√ÅCTEO"]},{"n":"Helado sandwich de nata nestle","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Huevo cocido","a":["HUEVO"]},{"n":"Huevo cocido cubo","a":["HUEVO"]},{"n":"Huevos cocidos al vapor","a":["HUEVO"]},{"n":"Huevos fritos","a":["HUEVO"]},{"n":"Huevos rellenos de at√∫n casero","a":["HUEVO","L√ÅCTEO","MOSTAZA","PESCADO","SULFITOS"]},{"n":"Huevos revueltos","a":["HUEVO"]},{"n":"Hummus cl√°sico formato bote","a":["APIO","CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Imperial de chocolate y mandarina","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Jalape√±os formato lata","a":[]},{"n":"Jam√≥n cocido","a":["L√ÅCTEO","SOJA"]},{"n":"Jam√≥n cocido lonchas","a":["L√ÅCTEO","SOJA"]},{"n":"Jam√≥n curado lonchas","a":[]},{"n":"Jam√≥n ib√©rico","a":[]},{"n":"Jam√≥n serrano centro ib√©rico","a":[]},{"n":"Jamoncitos de pollo al vino blanco","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Jamoncitos de pollo asado","a":["HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Judias verdes salteadas con ajo","a":["SULFITOS"]},{"n":"Kefir yogur","a":["L√ÅCTEO"]},{"n":"Ketchup","a":[]},{"n":"Lacon","a":["SOJA"]},{"n":"Lacon en su jugo","a":["APIO","CEREALES","HUEVO","L√ÅCTEO","MOSTAZA","SOJA"]},{"n":"Langostinos cocidos congelados","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO","SULFITOS"]},{"n":"Langostinos crudos congelados","a":["CRUST√ÅCEOS","SULFITOS"]},{"n":"Lasa√±a bolo√±esa con bechamel","a":["APIO","CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA"]},{"n":"Lasa√±a de carne con bechamel","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Lasa√±a vegetal congelada","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Laurel fresco especias","a":[]},{"n":"Leche desnatada","a":["L√ÅCTEO"]},{"n":"Leche entera","a":["L√ÅCTEO"]},{"n":"Leche semidesnatada sin lactosa","a":["L√ÅCTEO"]},{"n":"Lechuga mezclum","a":[]},{"n":"Lechuga romana","a":[]},{"n":"Lenguado a la plancha","a":[]},{"n":"Lentejas estofadas con verduras","a":["APIO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Limones","a":[]},{"n":"Lombarda rehogada sal pimienta aceite","a":[]},{"n":"Lomo adobado de cerdo plancha","a":[]},{"n":"Lomo de cerdo cocido lonchas o barra","a":["L√ÅCTEO","SOJA"]},{"n":"Lomo de ternera plancha","a":[]},{"n":"Lomo ib√©rico lonchas embutido","a":[]},{"n":"Longaniza fresca de pollo al vino blanco","a":["SULFITOS"]},{"n":"Lubina al horno con patatas y verduras","a":["PESCADO","SULFITOS"]},{"n":"Lubina plancha","a":["PESCADO"]},{"n":"Macarons surtidos 72","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Macarrones pasta seca","a":["CEREALES","HUEVO"]},{"n":"Madalena cl√°sica","a":["CEREALES","FRUTOS SECOS","HUEVO","SOJA"]},{"n":"Madalena sin az√∫car sin gluten","a":["CACAHUETES","HUEVO"]},{"n":"Madalena sin gluten chocolate","a":["HUEVO"]},{"n":"Madalena sin gluten fresa","a":["HUEVO"]},{"n":"Magret de pato plancha","a":[]},{"n":"Magro cantones","a":["CEREALES","SOJA","SULFITOS"]},{"n":"Ma√≠z dulce","a":[]},{"n":"Mantequilla 1 kilo","a":["L√ÅCTEO"]},{"n":"Mantequilla porciones","a":["L√ÅCTEO"]},{"n":"Margarina porciones","a":["L√ÅCTEO","SOJA"]},{"n":"Mejillon tigre","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Mejillones al lim√≥n","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Mejillones en salsa thai","a":["APIO","CRUST√ÅCEOS","MOLUSCO","PESCADO","SULFITOS"]},{"n":"Menbrillo","a":[]},{"n":"Merluza a la almendra","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","PESCADO","SOJA","SULFITOS"]},{"n":"Merluza en cocci√≥n Breve a la gallega rrss","a":["APIO","MOSTAZA","PESCADO","S√âSAMO","SULFITOS"]},{"n":"Merluza plancha","a":["PESCADO"]},{"n":"Mermelada 0% azucares a√±adidos","a":[]},{"n":"Mermelada fresa 900g","a":[]},{"n":"Mermelada fresa mini tarro cristal","a":[]},{"n":"Mermelada frutos del bosque","a":[]},{"n":"Mermelada melocot√≥n 900g","a":[]},{"n":"Mermelada melocot√≥n mini tarro cristal","a":[]},{"n":"Mermelada naranja 900g","a":[]},{"n":"Mermelada naranja mini tarro cristal","a":[]},{"n":"Mezcla china de verduras bolsa congelada","a":[]},{"n":"Micuit","a":["HUEVO","L√ÅCTEO"]},{"n":"Miel de ca√±a","a":[]},{"n":"Milhojas de nata y crema de salvador","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Mini brioche","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Mini chic de crema","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Mini dots classic donuts","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","SOJA"]},{"n":"Mini dots negritos","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Mini empanadilla de at√∫n frita","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Mini flamenquin de ave frito","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Mini napolitana bomb√≥n","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Mini napolitana crema","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Mini sneken","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Mix delicias patatas chips de colores. Patatas terra","a":[]},{"n":"Mollete 4 quesos nueces","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO"]},{"n":"Mollete de cordero","a":["CEREALES","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Morchilla","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Morcilla","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Mortadela con aceitunas lonchas","a":[]},{"n":"Mortadela italiana","a":["FRUTOS SECOS","L√ÅCTEO"]},{"n":"Mostaza antigua","a":["MOSTAZA","SULFITOS"]},{"n":"Mozzarella fresca","a":["L√ÅCTEO"]},{"n":"Muesli de frutas bolsa cereales","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Muffing doble choco","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Muffing yogurt ar√°ndanos","a":["CEREALES","FRUTOS SECOS","HUEVO","SOJA"]},{"n":"Nachos de bolsa nachos fritos","a":[]},{"n":"Nata montada","a":["L√ÅCTEO"]},{"n":"Natilla chocolate sin nada mas","a":["L√ÅCTEO","SOJA"]},{"n":"Natilla vainilla","a":["L√ÅCTEO"]},{"n":"Natillas de chocolate con virutas de choco blanco o negro","a":["L√ÅCTEO","SOJA"]},{"n":"Natillas vainilla montero cubo","a":["L√ÅCTEO"]},{"n":"Natlla de vainilla \"montero\" con virutas de choco b/n","a":["L√ÅCTEO","SOJA"]},{"n":"Nebrina especias","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Nesquik sobre","a":["SOJA"]},{"n":"√ëoquis gnocchi gorgonzola","a":["CEREALES","L√ÅCTEO"]},{"n":"Nueces peladas","a":["CACAHUETES","FRUTOS SECOS"]},{"n":"Nugget de pollo","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA"]},{"n":"Nutella individual","a":["FRUTOS SECOS","L√ÅCTEO","SOJA"]},{"n":"Or√©gano hoja especias","a":[]},{"n":"Or√©gano molido especias","a":[]},{"n":"Orejones de albaricoque","a":["SULFITOS"]},{"n":"Paella de arroz negro","a":["APIO","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Paella de bacalao y gambas","a":["APIO","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Paella de marisco","a":["APIO","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Paella de pollo y setas","a":["APIO","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Paella de presa de cerdo y/o con setas","a":["APIO","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Paella de pulpo y gambas","a":["APIO","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Paella de verduras","a":["APIO","CEREALES","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Paella mixta carne pescado","a":["FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Pajaritas de colores pasta seca al huevo","a":["CEREALES","HUEVO","MOSTAZA","SOJA"]},{"n":"Pak choi salsa teriyaki, s√©samo","a":[]},{"n":"Paletilla de cordero al horno","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Palito chocolate blanco decoracion","a":["L√ÅCTEO"]},{"n":"Palito chocolate decoracion","a":["L√ÅCTEO"]},{"n":"Palito stick blanco","a":["L√ÅCTEO"]},{"n":"Palito stick chocolate","a":["L√ÅCTEO"]},{"n":"Palmera de chocolate","a":["CEREALES","FRUTOS SECOS","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Pan bao con carne merchada con mojo picon","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Pan bao con pollo teriyaki","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Pan bao pollo y salsa yogur","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Pan bao surimi","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Pan bimbo integral","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Pan bimbo rebanadas grande","a":["CEREALES","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Pan de ajo","a":["CEREALES","L√ÅCTEO","S√âSAMO"]},{"n":"Pan de pipas","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan focaccia romana","a":["APIO","CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan frikorn multicereales","a":["ALTRAMUZ","CEREALES","FRUTOS SECOS","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Pan hamburguesa 100g","a":["CEREALES","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Pan hamburguesa congelado 24 unidades","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","S√âSAMO"]},{"n":"Pan hogaza cereales","a":["CEREALES","SOJA","S√âSAMO"]},{"n":"Pan hogaza cl√°sica","a":["CEREALES","S√âSAMO","SOJA"]},{"n":"Pan hogaza pipas de calabaza","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan hogaza semillas cereales","a":["CEREALES","S√âSAMO","SOJA"]},{"n":"Pan integral con salvado","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan korspitz","a":["CEREALES","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan mini burguer con s√©samo 22g caja 180 unidades","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan mini chapata","a":["CEREALES","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan mini flauta","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Pan mini hamburguesa europastry 180 unidades","a":["CEREALES","L√ÅCTEO","S√âSAMO"]},{"n":"Pan miniatura cereales","a":["CEREALES","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan miniatura de pasas y nueces","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA","S√âSAMO"]},{"n":"Pan omega 3","a":["ALTRAMUZ","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","PESCADO","S√âSAMO","SOJA"]},{"n":"Pan panini 100% integral","a":["CEREALES","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Pan pi√±ita ecol√≥gica","a":["CEREALES","S√âSAMO"]},{"n":"Pan rebanada payes","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan rol blanco","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pan sin gluten mini barra en bolsa","a":[]},{"n":"Pan sin gluten rebanadas","a":["HUEVO"]},{"n":"Pan sin gluten semillas rebanada","a":["HUEVO"]},{"n":"Panal de miel","a":[]},{"n":"Panal de miel acasia","a":[]},{"n":"Panko pan rallado japones","a":["CEREALES"]},{"n":"Pasas secas","a":["CACAHUETES","FRUTOS SECOS"]},{"n":"Pasta coditos","a":["CEREALES","HUEVO"]},{"n":"Pasta con bolo√±esa rrss","a":["CEREALES","HUEVO","L√ÅCTEO","SULFITOS"]},{"n":"Pasta de achiote","a":[]},{"n":"Pasta de t√©","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Pasta espirales blanca pasta seca al huevo","a":["CEREALES","HUEVO","MOSTAZA","SOJA"]},{"n":"Pasta miso 1 kilo","a":["CEREALES","SOJA"]},{"n":"Pasta seca fideu√°","a":["CEREALES","HUEVO","MOSTAZA","SOJA"]},{"n":"Pasta seca rigatoni","a":["CEREALES","MOSTAZA","SOJA"]},{"n":"Pastel de bonito del norte y piquillo","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SULFITOS"]},{"n":"Pastel de pescado de roca","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SULFITOS"]},{"n":"Pastel de zanahorias 14 porciones","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Pastrami","a":[]},{"n":"Patata rostikos al horno","a":[]},{"n":"Patatas a la crema","a":["L√ÅCTEO","SULFITOS"]},{"n":"Patatas al horno finas hierbas","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Patatas al vapor","a":["SULFITOS"]},{"n":"Patatas con cebolla y bacon al horno","a":["SOJA","SULFITOS"]},{"n":"Patatas duquesas fritas","a":["L√ÅCTEO","SULFITOS"]},{"n":"Patatas fritas chips golosinas gominolas","a":["CEREALES"]},{"n":"Patatas fritas naturales papecor","a":["SULFITOS"]},{"n":"Patatas gajo aviko congelado 4x2500g","a":[]},{"n":"Patatas gallegas al hono con piment√≥n","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Patatas lionesa al horno con mantequilla","a":["L√ÅCTEO","SULFITOS"]},{"n":"Patatas pajas de bolsa","a":[]},{"n":"Patatas risoladas horno piment√≥n","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Pat√© de cerdo a la pimienta","a":["HUEVO","L√ÅCTEO"]},{"n":"Pat√© de cerdo al roquefort","a":["L√ÅCTEO"]},{"n":"Pat√© de cerdo campa√±a","a":["L√ÅCTEO"]},{"n":"Pat√© de codorniz con uvas","a":["CEREALES","FRUTOS SECOS","HUEVO"]},{"n":"Pat√© de olivas negras tapenade","a":[]},{"n":"Pat√© de pato pollo a la pimienta verde mini tarro cristal","a":["HUEVO","L√ÅCTEO"]},{"n":"Pat√© de pato pollo al armagnac mini tarro cristal","a":["HUEVO","L√ÅCTEO"]},{"n":"Pat√© de pato pollo al oporto mini tarro cristal","a":["HUEVO","L√ÅCTEO"]},{"n":"Pat√© de pato y pollo","a":["HUEVO","L√ÅCTEO"]},{"n":"Pat√© de pato y pollo con pimienta","a":["HUEVO","L√ÅCTEO"]},{"n":"Pat√© de pato y pollo finas hierbas","a":["HUEVO","L√ÅCTEO","MOSTAZA"]},{"n":"Pat√© pato pollo oporto tarro cristal individual","a":["HUEVO","L√ÅCTEO"]},{"n":"Pavo al curry","a":["APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Pavo asado","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Pavo relleno asado en su jugo","a":["CACAHUETES","FRUTOS SECOS","HUEVO","S√âSAMO","SULFITOS"]},{"n":"Pechuga de pavo lonchas fiambre","a":["L√ÅCTEO","SOJA"]},{"n":"Pechuga de pavo plancha","a":[]},{"n":"Pechuga de pollo confitada en aceite y ajo","a":["SULFITOS"]},{"n":"Pechuga de pollo crujiente pollo empanado congelado","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA","SULFITOS"]},{"n":"Pechuga pavo embutido","a":["L√ÅCTEO","SOJA"]},{"n":"Pechuga pollo empanado crijiente este es para c√©sar","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA","SULFITOS"]},{"n":"Pepinillos en vinagre","a":["SULFITOS"]},{"n":"Pepino","a":[]},{"n":"Perca a la rote√±a","a":["PESCADO","SULFITOS"]},{"n":"Pez espada plancha","a":["PESCADO"]},{"n":"Picatostes fritos bolsa custrones costrones","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Picos corlines integral ortiz","a":["CEREALES","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Picos corlines ortiz","a":["CEREALES","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Picos rusticos gourmet obando","a":["CEREALES","S√âSAMO","SOJA"]},{"n":"Piment√≥n dulce especias","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Piment√≥n picante especias","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Pimienta blanca especias","a":[]},{"n":"Pimienta blanca grano especias","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Pimienta negra grano especias","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Pimiento del piquillo relleno de bacalao","a":["CEREALES","CRUST√ÅCEOS","HUEVO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Pimiento italiano","a":[]},{"n":"Pimiento rojo","a":[]},{"n":"Pimiento verde","a":[]},{"n":"Pimientos del piquillo salteados","a":["SULFITOS"]},{"n":"Pimientos fritos","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Pimientos fritos del padron con cherry","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Pimientos tricolor fritos","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Pi√±ones","a":["CACAHUETES","FRUTOS SECOS"]},{"n":"Pipa de mejillon congelada carne de mejillon cocido","a":["MOLUSCO"]},{"n":"Piruleta de langostinos marinado brocheta de gambas","a":["CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Pisto de verduras casero","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Pisto de verduras congelado","a":[]},{"n":"Pizza 5 quesos","a":["CEREALES","L√ÅCTEO","SOJA"]},{"n":"Pizza carbonara","a":["CEREALES","L√ÅCTEO","MOSTAZA","SOJA"]},{"n":"Pizza diavola","a":["CEREALES","L√ÅCTEO","SOJA"]},{"n":"Pizza hawaii","a":["CEREALES","L√ÅCTEO","SOJA"]},{"n":"Pizza margarita","a":["CEREALES","L√ÅCTEO","SOJA"]},{"n":"Pizza prociutto","a":["CEREALES","L√ÅCTEO","SOJA"]},{"n":"Pizza tonno","a":["CEREALES","L√ÅCTEO","PESCADO","SOJA"]},{"n":"Pizza vegana","a":["CEREALES","L√ÅCTEO","SOJA"]},{"n":"Plancha brownie con nueces","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Plancha de cochinillo confitado","a":["APIO","CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA"]},{"n":"Plancha de coco 1500g","a":["APIO","CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Plancha de merengue 1500g","a":["APIO","CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Plancha de queso con ar√°ndanos 1800g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Plancha de san marcos 1500g","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Plancha sabor tres chocolates 1800g","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Plum cake de frutas","a":["CEREALES","HUEVO","L√ÅCTEO"]},{"n":"Pok√© de salm√≥n barqueta","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Pollo a la cazadora barqueta","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA","SULFITOS","S√âSAMO"]},{"n":"Pollo a la pepitoria","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Pollo con orejones y ciruelas precocinado","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Pollo confitado con ajo aceite y sal","a":["SULFITOS"]},{"n":"Postre banda de fruta tipo hojaldre salvador","a":["CEREALES","HUEVO"]},{"n":"Postre tres chocolate mousses de cacao vaso rrss","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Pota congelada","a":["MOLUSCO"]},{"n":"Potaje de patatas con choco","a":["APIO","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"Potaje patatas con costillas de cerdo","a":["APIO","CEREALES","FRUTOS SECOS","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Profiterol de crema mini granel 1500g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Puchero de garbanzos","a":["APIO"]},{"n":"Pulpo a la mugardesa","a":["APIO","CRUST√ÅCEOS","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SULFITOS"]},{"n":"Pulpo congelado","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Puntillitas calamaritos fritos","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Queso azul barra pasteurizado vaca","a":["L√ÅCTEO"]},{"n":"Queso blanco pasteurizado para untar","a":["L√ÅCTEO"]},{"n":"Queso brie redondo vaca pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso cabra piment√≥n leche cruda","a":["L√ÅCTEO"]},{"n":"Queso cabra romero pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso camembert vaca pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso cheddar lonchas","a":["L√ÅCTEO"]},{"n":"Queso cheddar vaca pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso con pi√±a vaca leche cruda","a":["FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Queso de bola pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso edam lonchas","a":["L√ÅCTEO"]},{"n":"Queso emental lonchas","a":["L√ÅCTEO"]},{"n":"Queso emental vaca leche cruda","a":["L√ÅCTEO"]},{"n":"Queso en aceite cabra pasteurizado","a":["HUEVO","L√ÅCTEO"]},{"n":"Queso fresco de cabra","a":["L√ÅCTEO"]},{"n":"Queso gouda comino pasteurizado vaca","a":["L√ÅCTEO"]},{"n":"Queso gouda nueces vaca pasteurizado","a":["FRUTOS SECOS","L√ÅCTEO"]},{"n":"Queso gouda pesto rojo vaca","a":["L√ÅCTEO"]},{"n":"Queso gouda pesto verde vaca pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso gruyere vaca","a":["L√ÅCTEO"]},{"n":"Queso havarti vaca","a":["L√ÅCTEO"]},{"n":"Queso idiazabal ahumado leche cruda oveja","a":["HUEVO","L√ÅCTEO"]},{"n":"Queso mahones","a":["L√ÅCTEO"]},{"n":"Queso mayorquin pasteurizado vaca","a":["L√ÅCTEO"]},{"n":"Queso mozzarela vaca bolitas pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso parmesano vaca leche cruda","a":["L√ÅCTEO"]},{"n":"Queso pecorino pimienta pasteurizado oveja","a":["L√ÅCTEO"]},{"n":"Queso provolone dulce pasteurizado vaca","a":["L√ÅCTEO"]},{"n":"Queso provolone lonchas","a":["L√ÅCTEO"]},{"n":"Queso provolone picante pasteurizado vaca","a":["L√ÅCTEO"]},{"n":"Queso rallado cabra vaca oveja pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso reques√≥n de cabra","a":["L√ÅCTEO"]},{"n":"Queso rulo de cabra pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso rulo de cabra pasteurizado 200g","a":["L√ÅCTEO"]},{"n":"Queso semi curado cortado","a":["HUEVO","L√ÅCTEO"]},{"n":"Queso semicurado vaca vaca oveja","a":["HUEVO","L√ÅCTEO"]},{"n":"Queso tete de moine vaca leche cruda","a":["L√ÅCTEO"]},{"n":"Queso tipo manchego oveja a√±ejo leche cruda","a":["HUEVO","L√ÅCTEO"]},{"n":"Queso tipo manchego oveja semicurado pasteurizado","a":["HUEVO","L√ÅCTEO"]},{"n":"Queso tipo manchego ronkal oveja leche cruda","a":["HUEVO","L√ÅCTEO"]},{"n":"Queso tipo manchego semicurado vaca oveja","a":["L√ÅCTEO"]},{"n":"Queso tipo tetilla vaca pasteurizado","a":["L√ÅCTEO"]},{"n":"Queso torata serena leche cruda oveja","a":["L√ÅCTEO"]},{"n":"Queso tronch√≥n cabra vaca oveja leche cruda","a":["HUEVO","L√ÅCTEO"]},{"n":"Quiche de esp√°rragos verdes","a":["APIO","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","PESCADO","S√âSAMO","SOJA"]},{"n":"Rama de canela","a":[]},{"n":"Rape al curry","a":["APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","L√ÅCTEO","MOLUSCO","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Rape plancha","a":["PESCADO"]},{"n":"Raviolis de carne pasta seca","a":["CEREALES","HUEVO","L√ÅCTEO","MOSTAZA","SOJA"]},{"n":"Remolacha conservas","a":[]},{"n":"Rodaballo a la plancha","a":["PESCADO"]},{"n":"Rollito de primavera de pato","a":["CEREALES","S√âSAMO","SOJA"]},{"n":"Rollitos de primavera fritos","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Romero bote","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Romero fresco especias","a":[]},{"n":"Rosada a la vasca","a":["CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Rosada congelada","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Rosada frita","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Rosada plancha","a":["CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Roscon de reyes nata europastry","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA","SULFITOS"]},{"n":"R√∫cula","a":[]},{"n":"Rusa cubo","a":["APIO","CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Sable mini lingostes 256","a":["CEREALES","MOSTAZA","SOJA"]},{"n":"Salami","a":["L√ÅCTEO"]},{"n":"Salami finas hierbas","a":["L√ÅCTEO","SOJA"]},{"n":"Salchica alemana","a":["APIO","FRUTOS SECOS","L√ÅCTEO","MOSTAZA","S√âSAMO","SOJA"]},{"n":"Salchicha cocktail","a":["L√ÅCTEO","SOJA"]},{"n":"Salchichas estilo frankfurt","a":["L√ÅCTEO","SOJA"]},{"n":"Salchichas veganas","a":["APIO","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO"]},{"n":"Salchich√≥n","a":["L√ÅCTEO"]},{"n":"Salchich√≥n extra cortado","a":["L√ÅCTEO"]},{"n":"Salchich√≥n ib√©rico loncha embutido","a":[]},{"n":"Salchich√≥n ib√©rico lonchas embutido","a":[]},{"n":"Salm√≥n ahumado","a":["PESCADO"]},{"n":"Salm√≥n al eneldo","a":["APIO","HUEVO","L√ÅCTEO","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Salm√≥n grenoblesa","a":["HUEVO","L√ÅCTEO","PESCADO","SULFITOS"]},{"n":"Salmonetes fritos","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO"]},{"n":"Salmorejo casero","a":["CEREALES","SULFITOS"]},{"n":"Salpicon ahumados en aceite","a":["PESCADO"]},{"n":"Salsa alioli casera","a":["HUEVO","MOSTAZA","SULFITOS"]},{"n":"Salsa barbacoa ahumada formato bote 2L","a":["MOSTAZA"]},{"n":"Salsa bechamel deshidratada formato bolsa 2,5kg","a":["APIO","CEREALES","HUEVO","L√ÅCTEO","MOSTAZA"]},{"n":"Salsa bolonesa 1kilo precocinado","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Salsa bolo√±esa casera (salsa pasta)","a":["SULFITOS"]},{"n":"Salsa burguer formato bote 1 kilo","a":["HUEVO","MOSTAZA","SULFITOS"]},{"n":"Salsa cajun formato bote 1 kilo","a":["HUEVO","MOSTAZA"]},{"n":"Salsa carbonara","a":["L√ÅCTEO","SOJA"]},{"n":"Salsa casera de pesto de albahaca pi√±ones y ajo","a":["CACAHUETES","FRUTOS SECOS","SULFITOS"]},{"n":"Salsa c√©sar Hellmann 1 litro formato bote","a":["HUEVO","L√ÅCTEO","MOSTAZA","PESCADO","S√âSAMO"]},{"n":"Salsa chimichurri formato lata","a":[]},{"n":"Salsa de nata con calabac√≠n (salsa pastas)","a":["L√ÅCTEO"]},{"n":"Salsa de nata con gambas casera (salsa pastas)","a":["CRUST√ÅCEOS","L√ÅCTEO","SULFITOS"]},{"n":"Salsa de nata y setas casera (salsa pastas)","a":["L√ÅCTEO"]},{"n":"Salsa de queso cheddar formato lata","a":["L√ÅCTEO"]},{"n":"Salsa de quesos casera (salsa pastas)","a":["HUEVO","L√ÅCTEO"]},{"n":"Salsa kebab bote","a":["HUEVO","L√ÅCTEO","SOJA"]},{"n":"Salsa kebab chovi","a":["HUEVO","L√ÅCTEO"]},{"n":"Salsa mayonesa cubo","a":["HUEVO","L√ÅCTEO","MOSTAZA"]},{"n":"Salsa miel y mostaza hellmann","a":["HUEVO","MOSTAZA","S√âSAMO"]},{"n":"Salsa napolitana casera (salsa pastas)","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Salsa nata con pimiento rojo casera (salsa pasta)","a":["L√ÅCTEO"]},{"n":"Salsa pesto con albahaca formato bote","a":["CACAHUETES","FRUTOS SECOS","L√ÅCTEO"]},{"n":"Salsa pesto de tomates secos y albahaca bote","a":["CACAHUETES","FRUTOS SECOS","L√ÅCTEO"]},{"n":"Salsa romesco","a":["FRUTOS SECOS"]},{"n":"Salsa romesco bote cristal","a":["FRUTOS SECOS"]},{"n":"Salsa rosa elaborada","a":["CEREALES","HUEVO","L√ÅCTEO","MOSTAZA","PESCADO"]},{"n":"Salsa soja dulce","a":["CEREALES","SOJA"]},{"n":"Salsa soja kikkoman","a":["CEREALES","SOJA"]},{"n":"Salsa sweet chili dulce","a":[]},{"n":"Salsa sweet chilli","a":[]},{"n":"Salsa t√°rtara elaborada","a":["HUEVO","L√ÅCTEO","MOSTAZA","SULFITOS"]},{"n":"Salsa t√°rtara hellmann","a":["HUEVO","MOSTAZA"]},{"n":"Salsa tartufata","a":["APIO","CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","SOJA","SULFITOS"]},{"n":"Salsa teriyaki","a":["CACAHUETES","CEREALES","FRUTOS SECOS","SOJA"]},{"n":"Salsa teriyaki bote","a":["CEREALES","SOJA"]},{"n":"Salsa tomate polvo cubo 10 kilos","a":[]},{"n":"Salsa vinagreta casera","a":["HUEVO","MOSTAZA","SULFITOS"]},{"n":"Salsa vinagreta hellmann","a":["MOSTAZA","S√âSAMO"]},{"n":"Salsa yogur","a":["HUEVO","L√ÅCTEO","MOSTAZA","S√âSAMO"]},{"n":"Salteado de ternera casero","a":["APIO","MOSTAZA","S√âSAMO","SULFITOS"]},{"n":"Salteado de verduras congeladas formato bolsa 2,5kg","a":[]},{"n":"Salteado mediterraneo de verduras expres 1kilo","a":[]},{"n":"Salteado rustico de verduras 2,5 kg congelado","a":["APIO"]},{"n":"Samosa de verduras ya fritas","a":["CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO","S√âSAMO","SOJA"]},{"n":"San jacobos fritos","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA"]},{"n":"Sandwich club melia rrss","a":["CEREALES","HUEVO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Saquitos de brandada de bacalao","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Saquitos de queso de cabra y verduras","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Secreto a la plancha","a":[]},{"n":"Semillas de amapola","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Semillas de lino","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Semillas de polen","a":["FRUTOS SECOS"]},{"n":"Semillas de s√©samo","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Sepia congelada","a":["MOLUSCO"]},{"n":"S√©samo negro","a":["CEREALES","FRUTOS SECOS","SOJA","S√âSAMO"]},{"n":"Setas salteadas","a":[]},{"n":"Siropes sabores topping","a":[]},{"n":"Smoke knorr aderezo l√≠quido ahumado 40CL","a":[]},{"n":"Solomillo de cerdo a la plancha","a":[]},{"n":"Solomillo de retinta 220g plato rrss","a":["SULFITOS"]},{"n":"Solomillo de ternera plancha","a":[]},{"n":"Sopa de cebolla","a":["HUEVO","L√ÅCTEO","SOJA"]},{"n":"Sopa de fideos de pollo","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Sopa de minestrones","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Sopa de rabo de buey","a":["HUEVO","L√ÅCTEO","SOJA"]},{"n":"Sopa hortelana","a":["HUEVO","L√ÅCTEO","SOJA"]},{"n":"Sorbete de mojito la lechera 2,1L","a":["L√ÅCTEO"]},{"n":"Sorbete lim√≥n 2,1l","a":["L√ÅCTEO"]},{"n":"Sorbete mandarina 2,1l","a":["L√ÅCTEO"]},{"n":"Surtido canap√©s salados 68 unidades","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","PESCADO","SOJA","SULFITOS","S√âSAMO"]},{"n":"Surtido mini crodots","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Surtido reposter√≠a dulce pasteleria francesa 62200","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Sushi","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tajine de pollo con orejones con ciruelas","a":["CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tallarines pasta seca","a":["CEREALES","HUEVO"]},{"n":"Tarta baviera sg","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta cheesecake cookies & cream","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta chocolate noche y dia 1100g","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta cruble manzana y caramelo","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de almendras 600g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de choco y frutos rojos 1250g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de lima 1350g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Tarta de manzana 1750g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Tarta de oreo","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de oreo 1700g","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tarta de queso 1250g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de queso con ar√°ndanos 1800g","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA","SULFITOS"]},{"n":"Tarta de queso con caramelo","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de queso fresca 1600g","a":["HUEVO","L√ÅCTEO"]},{"n":"Tarta de queso individual alber adria","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de queso y fresa","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de queso y fresa rrss","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta de turr√≥n y yema tostada, Salvador","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Tarta de zanahoria sg 2 unidades","a":["APIO","CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta individual inglesa 90g 12 unidades","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Tarta individual masquechoco mousse de chocolate vaso","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Tarta individual piramide de mango","a":["CACAHUETES","CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Tarta individual primavera mousse de lim√≥n vaso","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta individual queso vaso mousse de queso","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tarta individual turron mausse de turron vaso","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA"]},{"n":"Tarta lemon pie","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tarta lemon pie (salvador) cartas","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tarta manzana brisa 1300g Salvador","a":["CEREALES","HUEVO","MOSTAZA","SOJA"]},{"n":"Tarta menu chocolate 1000g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta menu fresa 20 porciones 1000g","a":["CEREALES","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta mousse de chocolate 1000g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta muerte por chocolate","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Tarta praline precortada sg 2 unidades 1000g","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tarta ricota y pera 1200g","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tempura para rebozar","a":["CEREALES"]},{"n":"Ternera carbonara y setas barqueta","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tinta de sepia","a":["CRUST√ÅCEOS","L√ÅCTEO","PESCADO"]},{"n":"Tirabeques al vapor","a":[]},{"n":"Tiramisu daviguel","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO"]},{"n":"Tocino de cielo tarrinas","a":["HUEVO"]},{"n":"Tofu","a":["SOJA"]},{"n":"Tomate","a":[]},{"n":"Tomate horno provenzal y queso","a":["CEREALES","L√ÅCTEO","SULFITOS"]},{"n":"Tomate pera al horno con mantequilla","a":["L√ÅCTEO"]},{"n":"Tomate seco en aceite bote cristal","a":[]},{"n":"Tomate triturado casero","a":[]},{"n":"Tomillo bote","a":["APIO","MOSTAZA","S√âSAMO"]},{"n":"Tomillo fresco especias","a":[]},{"n":"Tomillo seco formato bote especias","a":[]},{"n":"Torta loca 1450g","a":["CEREALES","HUEVO"]},{"n":"Tortellinis de carne pasta seca","a":["CEREALES","HUEVO","L√ÅCTEO","MOSTAZA","SOJA"]},{"n":"Tortilla a la francesa queso jam√≥n cebolla champi√±√≥n","a":["HUEVO","L√ÅCTEO","SOJA"]},{"n":"Tortilla de patatas con cebolla congelada","a":["HUEVO"]},{"n":"Tortillitas de camar√≥n","a":["CEREALES","CRUST√ÅCEOS","HUEVO","L√ÅCTEO","MOLUSCO","PESCADO","SOJA","SULFITOS"]},{"n":"Tortitas de arroz","a":["L√ÅCTEO","SOJA"]},{"n":"Tortitas de arroz con sal","a":["S√âSAMO"]},{"n":"Tortitas pancakes receta casera","a":["CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Tostas chapatas de la marca salvador","a":["CEREALES","FRUTOS SECOS","S√âSAMO","SOJA"]},{"n":"Traiteur de paris misi vasos dulces","a":["ALTRAMUZ","APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Trucha ahumada","a":["PESCADO"]},{"n":"Trucha plancha","a":["PESCADO"]},{"n":"Trufa lata","a":[]},{"n":"Trufas cacao bolas","a":["CACAHUETES","CEREALES","FRUTOS SECOS","HUEVO","L√ÅCTEO","SOJA"]},{"n":"Variantes encurtidos","a":["SULFITOS"]},{"n":"Verdura tempura frita","a":["CEREALES","CRUST√ÅCEOS","L√ÅCTEO","MOLUSCO","PESCADO"]},{"n":"Virutas chocolate","a":["L√ÅCTEO","SOJA"]},{"n":"Wakame","a":["S√âSAMO"]},{"n":"Wok de gambas","a":["APIO","CEREALES","CRUST√ÅCEOS","S√âSAMO","SOJA","SULFITOS"]},{"n":"Wok de langostinos rrss","a":["APIO","CEREALES","CRUST√ÅCEOS","MOLUSCO","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Wok de ternera","a":["CEREALES","S√âSAMO","SOJA"]},{"n":"Wrap atun+nueces+mayonesa","a":["APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Wrap de salm√≥n ahumado rrss","a":["CEREALES","L√ÅCTEO","PESCADO"]},{"n":"WRAP POLLO CON CURRY precocinado fresco","a":["APIO","CACAHUETES","CEREALES","CRUST√ÅCEOS","FRUTOS SECOS","HUEVO","L√ÅCTEO","MOLUSCO","MOSTAZA","PESCADO","S√âSAMO","SOJA","SULFITOS"]},{"n":"Xuxo de crema","a":["CEREALES","FRUTOS SECOS","HUEVO","SOJA"]},{"n":"Yogur activia ciruela desnatado individual","a":["CEREALES","FRUTOS SECOS","L√ÅCTEO"]},{"n":"Yogur dadone fresa vaso cristal","a":["L√ÅCTEO"]},{"n":"Yogur dadone natural vaso cristal","a":["L√ÅCTEO"]},{"n":"Yogur fresa cubo","a":["L√ÅCTEO"]},{"n":"Yogur griego oikos individual","a":["L√ÅCTEO"]},{"n":"Yogur melocot√≥n cubo","a":["L√ÅCTEO"]},{"n":"Yogur natural cubo","a":["L√ÅCTEO"]},{"n":"Yogur sabor macedonia danone individual","a":["L√ÅCTEO"]},{"n":"Yogur savia individual","a":["SOJA"]},{"n":"Zanahoria baby congelada","a":["APIO"]},{"n":"Zanahoria baston papecor","a":["SULFITOS"]},{"n":"Zanahoria parisina al vapor","a":["APIO"]},{"n":"Zanahoria rallada conservas","a":[]},{"n":"Zanahoria rallada lata","a":[]},{"n":"Zanahoria rallada papecor","a":["SULFITOS"]},{"n":"Zumos brick individual","a":[]},{"n":"Zurrapa blanca","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]},{"n":"Zurrapa roja","a":["L√ÅCTEO","MOSTAZA","SOJA","SULFITOS"]}];
const IC={"ALTRAMUZ":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIyLjA3MTQgMTYuNUMyMi4wNzE0IDE4LjM1NzIgMTkuNzg0OSAyMS4xNDI5IDE2Ljk2NDMgMjEuMTQyOUMxNC4xNDM3IDIxLjE0MjkgMTEuODU3MSAyMC4yMTQzIDExLjg1NzEgMTYuNUMxMS44NTcxIDEyLjc4NTcgMTQuMTQzNyAxMS44NTcyIDE2Ljk2NDMgMTEuODU3MkMxOS43ODQ5IDExLjg1NzIgMjIuMDcxNCAxNC42NDI5IDIyLjA3MTQgMTYuNVoiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xOC4zNTcxIDE2LjAzNThWMTYuOTY0MyIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTI3LjY0MjkgMjIuNTM1OFYyMy40NjQzIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTguMzU3MSAyOS4wMzU4VjI5Ljk2NDMiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yMi4wNzE0IDI5LjVDMjIuMDcxNCAzMS4zNTcyIDE5Ljc4NDkgMzQuMTQyOSAxNi45NjQzIDM0LjE0MjlDMTQuMTQzNyAzNC4xNDI5IDExLjg1NzEgMzMuMjE0MyAxMS44NTcxIDI5LjVDMTEuODU3MSAyNS43ODU3IDE0LjE0MzcgMjQuODU3MiAxNi45NjQzIDI0Ljg1NzJDMTkuNzg0OSAyNC44NTcyIDIyLjA3MTQgMjcuNjQyOSAyMi4wNzE0IDI5LjVaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMjMuOTI4NiAyM0MyMy45Mjg2IDI0Ljg1NzIgMjYuMjE1MSAyNy42NDI5IDI5LjAzNTcgMjcuNjQyOUMzMS44NTY0IDI3LjY0MjkgMzQuMTQyOSAyNi43MTQzIDM0LjE0MjkgMjNDMzQuMTQyOSAxOS4yODU3IDMxLjg1NjQgMTguMzU3MiAyOS4wMzU3IDE4LjM1NzJDMjYuMjE1MSAxOC4zNTcyIDIzLjkyODYgMjEuMTQyOSAyMy45Mjg2IDIzWiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cg==","APIO":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzE0MTRfMzcxKSI+CjxwYXRoIGQ9Ik0xOC4zMjQ5IDE5LjczMDFMMTIuMDI2NSAyNC44ODI2QzEwLjgyMSAyNi4wODgxIDEwLjE0MzcgMjcuNzIzMiAxMC4xNDM3IDI5LjQyOEMxMC4xNDM3IDMxLjEzMjkgMTAuODIxIDMyLjc2OCAxMi4wMjY1IDMzLjk3MzVDMTMuMjMyMSAzNS4xNzkgMTQuODY3MSAzNS44NTYzIDE2LjU3MiAzNS44NTYzQzE4LjI3NjkgMzUuODU2MyAxOS45MTE5IDM1LjE3OSAyMS4xMTc0IDMzLjk3MzVMMjYuNDE0MSAyNy43NjEyIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMzEuMDAzMiAyMy42OTMxQzMxLjM2OCAyNC4xMDk4IDMxLjg4MjYgMjQuMzY1NiAzMi40MzUgMjQuNDA1QzMyLjk4NzUgMjQuNDQ0NCAzMy41MzMxIDI0LjI2NDEgMzMuOTUzMyAyMy45MDMzQzM0LjMxNDIgMjMuNDgyOSAzNC40OTQ1IDIyLjkzNzEgMzQuNDU1MSAyMi4zODQ0QzM0LjQxNTggMjEuODMxOCAzNC4xNTk5IDIxLjMxNyAzMy43NDMyIDIwLjk1MkMzMy41MDYyIDIwLjcxNSAzMy4wMjIxIDIwLjIxNTMgMzMuMDIyMSAyMC4yMTUzQzMzLjMwOTcgMjAuMzMzOSAzMy42MDk3IDIwLjQxOTcgMzMuOTE2NSAyMC40NzEzQzM0LjE3NzkgMjAuNDk5NyAzNC40NDI0IDIwLjQ2OTEgMzQuNjkwNSAyMC4zODE5QzM0LjkzODYgMjAuMjk0NiAzNS4xNjQgMjAuMTUyOCAzNS4zNSAxOS45NjY5QzM1LjUzNjEgMTkuNzgxMSAzNS42NzgxIDE5LjU1NTkgMzUuNzY1NyAxOS4zMDc5QzM1Ljg1MzMgMTkuMDU5OSAzNS44ODQxIDE4Ljc5NTQgMzUuODU2IDE4LjUzNEMzNS44MDA4IDE3Ljk1OTcgMzUuNTQ3NSAxNy40MjI1IDM1LjEzOTYgMTcuMDE0NkMzNC43MzE2IDE2LjYwNjYgMzQuMTk0NSAxNi4zNTMzIDMzLjYyMDIgMTYuMjk4MUMzMy4zMDcyIDE2LjI3NTggMzIuNjU3NyAxNi4yMTY1IDMyLjY1NzcgMTYuMjE2NUMzMi45MTY2IDE2LjEwNzEgMzMuMTU5NiAxNS45NjMgMzMuMzc5OSAxNS43ODgzQzMzLjc0MDUgMTUuMzY3OCAzMy45MjA3IDE0LjgyMTkgMzMuODgxMSAxNC4yNjkyQzMzLjg0MTUgMTMuNzE2NiAzMy41ODU1IDEzLjIwMTkgMzMuMTY4NiAxMi44MzdDMzIuODAzNyAxMi40MjAxIDMyLjI4OSAxMi4xNjQxIDMxLjczNjQgMTIuMTI0NUMzMS4xODM3IDEyLjA4NDkgMzAuNjM3OCAxMi4yNjUxIDMwLjIxNzMgMTIuNjI1OEMzMC4wMTI3IDEyLjgzMTUgMjkuNTc2NyAxMy4yNDg0IDI5LjU3NjcgMTMuMjQ4NEMyOS42NTY4IDEyLjk2NzUgMjkuNzAwNyAxMi42Nzc1IDI5LjcwNzUgMTIuMzg1NEMyOS42NTIzIDExLjgxMTEgMjkuMzk5IDExLjI3NCAyOC45OTEgMTAuODY2QzI4LjU4MzEgMTAuNDU4MSAyOC4wNDU5IDEwLjIwNDggMjcuNDcxNyAxMC4xNDk2QzI3LjIxMDQgMTAuMTIxNSAyNi45NDYxIDEwLjE1MjQgMjYuNjk4MyAxMC4yMzk4QzI2LjQ1MDUgMTAuMzI3MyAyNi4yMjU1IDEwLjQ2OTEgMjYuMDM5NiAxMC42NTQ5QzI1Ljg1MzggMTAuODQwNyAyNS43MTIgMTEuMDY1OCAyNS42MjQ1IDExLjMxMzZDMjUuNTM3MSAxMS41NjE0IDI1LjUwNjMgMTEuODI1NiAyNS41MzQzIDEyLjA4NjlDMjUuNTU2NyAxMi4zOTk5IDI1LjU5MDIgMTMuMDQ3MiAyNS41OTAyIDEzLjA0NzJDMjUuNDM5NyAxMi43NjU2IDI1LjI1OTkgMTIuNTAwNiAyNS4wNTM2IDEyLjI1NjlDMjQuNjg4NiAxMS44NDAxIDI0LjE3MzggMTEuNTg0MiAyMy42MjEyIDExLjU0NDlDMjMuMDY4NiAxMS41MDU1IDIyLjUyMjcgMTEuNjg1OSAyMi4xMDIzIDEyLjA0NjdDMjEuNzQxNiAxMi40NjY5IDIxLjU2MTMgMTMuMDEyNiAyMS42MDA2IDEzLjU2NUMyMS42NCAxNC4xMTc0IDIxLjg5NTggMTQuNjMyIDIyLjMxMjUgMTQuOTk2OUMyMi41Mzg5IDE1LjIyNTIgMjIuODA3MyAxNS40MDc4IDIzLjEwMjggMTUuNTM0NkMyMy4xMDI4IDE1LjUzNDYgMjIuNDU2NyAxNS41MDEgMjIuMTQyNiAxNS40Nzg3QzIxLjg4MDggMTUuNDQ5NyAyMS42MTYgMTUuNDc5OSAyMS4zNjc0IDE1LjU2NjlDMjEuMTE4OSAxNS42NTQgMjAuODkzMSAxNS43OTU3IDIwLjcwNjcgMTUuOTgxNkMyMC41MjAyIDE2LjE2NzUgMjAuMzc3OSAxNi4zOTI5IDIwLjI5MDEgMTYuNjQxMkMyMC4yMDIzIDE2Ljg4OTQgMjAuMTcxNCAxNy4xNTQyIDIwLjE5OTYgMTcuNDE2QzIwLjI1NSAxNy45OTAyIDIwLjUwODQgMTguNTI3MyAyMC45MTYzIDE4LjkzNTJDMjEuMzI0MiAxOS4zNDMxIDIxLjg2MTMgMTkuNTk2NCAyMi40MzU0IDE5LjY1MTlDMjIuNzI3NSAxOS42NDUxIDIzLjAxNzUgMTkuNjAxMSAyMy4yOTg1IDE5LjUyMTFDMjMuMjk4NSAxOS41MjExIDIyLjg4MTUgMTkuOTU1OSAyMi42NzU4IDIwLjE2MTZDMjIuMzE1NiAyMC41ODIzIDIyLjEzNTkgMjEuMTI4IDIyLjE3NTYgMjEuNjgwNEMyMi4yMTU0IDIyLjIzMjcgMjIuNDcxNSAyMi43NDcxIDIyLjg4ODIgMjMuMTExOEMyMy4yNTMxIDIzLjUyODcgMjMuNzY3OCAyMy43ODQ4IDI0LjMyMDQgMjMuODI0NEMyNC44NzMgMjMuODYzOSAyNS40MTg5IDIzLjY4MzggMjUuODM5NSAyMy4zMjMxQzI2LjAxNDggMjMuMTAzMSAyNi4xNTkzIDIyLjg2MDEgMjYuMjY4OCAyMi42MDA5QzI2LjI2ODggMjIuNjAwOSAyNi4zMjY5IDIzLjI1MDQgMjYuMzQ5MyAyMy41NjM1QzI2LjQwNDcgMjQuMTM3NiAyNi42NTgxIDI0LjY3NDcgMjcuMDY2IDI1LjA4MjZDMjcuNDczOSAyNS40OTA1IDI4LjAxMDkgMjUuNzQzOSAyOC41ODUxIDI1Ljc5OTNDMjguODQ2NCAyNS44MjcyIDI5LjExMDcgMjUuNzk2MiAyOS4zNTg1IDI1LjcwODZDMjkuNjA2MyAyNS42MjEgMjkuODMxNCAyNS40NzkgMzAuMDE3MSAyNS4yOTMyQzMwLjIwMjkgMjUuMTA3MyAzMC4zNDQ3IDI0Ljg4MjEgMzAuNDMyMiAyNC42MzQzQzMwLjUxOTYgMjQuMzg2NCAzMC41NTA1IDI0LjEyMjEgMzAuNTIyNSAyMy44NjA4QzMwLjQ3MTIgMjMuNTU0MSAzMC4zODU3IDIzLjI1NDEgMzAuMjY3NiAyMi45NjY1QzMwLjI2NzYgMjIuOTY2NSAzMC43NjUgMjMuNDU1IDMxLjAwMzIgMjMuNjkzMVoiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yMS41OTQ4IDEzLjUxODlDMjEuMzUyNCAxMy4wODgxIDIwLjk3NCAxMi43NDk4IDIwLjUxODkgMTIuNTU2OUMyMC4wNjM4IDEyLjM2MzkgMTkuNTU3NiAxMi4zMjcyIDE5LjA3OTQgMTIuNDUyNkMxOC42MDEyIDEyLjU3NzkgMTguMTc4MSAxMi44NTgxIDE3Ljg3NjEgMTMuMjQ5NUMxNy41NzQxIDEzLjY0MDkgMTcuNDEwNCAxNC4xMjEzIDE3LjQxMDQgMTQuNjE1NlYxNC42ODZDMTYuODgzIDE0LjgyMTYgMTYuNDIzMiAxNS4xNDUxIDE2LjExNzMgMTUuNTk1NkMxNS44MTE1IDE2LjA0NjIgMTUuNjgwNSAxNi41OTI5IDE1Ljc0OTEgMTcuMTMzMUMxNS44MTc4IDE3LjY3MzMgMTYuMDgxMiAxOC4xNyAxNi40OSAxOC41Mjk4QzE2Ljg5ODcgMTguODg5NiAxNy40MjQ4IDE5LjA4NzggMTcuOTY5NCAxOS4wODczSDE4LjAzOThDMTguNDU1NyAyMC43MDgyIDIwLjY0MjMgMjEuNjE4MiAyMi40MTQyIDE5LjYzNSIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTMyLjQ4MTEgMjQuNDA1MkMzMi45MTE5IDI0LjY0NzcgMzMuMjUwMiAyNS4wMjYgMzMuNDQzMSAyNS40ODExQzMzLjYzNiAyNS45MzYyIDMzLjY3MjcgMjYuNDQyNSAzMy41NDc0IDI2LjkyMDZDMzMuNDIyMSAyNy4zOTg4IDMzLjE0MTggMjcuODIxOSAzMi43NTA1IDI4LjEyMzlDMzIuMzU5MSAyOC40MjU5IDMxLjg3ODcgMjguNTg5NyAzMS4zODQ0IDI4LjU4OTZIMzEuMzE0QzMxLjE3ODMgMjkuMTE3IDMwLjg1NDkgMjkuNTc2OCAzMC40MDQ0IDI5Ljg4MjdDMjkuOTUzOCAzMC4xODg2IDI5LjQwNzEgMzAuMzE5NSAyOC44NjY5IDMwLjI1MDlDMjguMzI2NiAzMC4xODIzIDI3LjgzIDI5LjkxODkgMjcuNDcwMiAyOS41MTAxQzI3LjExMDQgMjkuMTAxMyAyNi45MTIyIDI4LjU3NTIgMjYuOTEyNyAyOC4wMzA3VjI3Ljk2MDJDMjUuMjkxNyAyNy41NDU1IDI0LjM2MjcgMjUuMzM2NSAyNi4zNDU5IDIzLjU2NDYiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yNS4zNjc3IDI1LjAyNjhDMjUuMzY3NyAyNS4wMjY4IDE1Ljk2ODMgMzcuOTE1MyAxMi4wMjY1IDMzLjk3MDFDOC4wODQ3NiAzMC4wMjUgMjAuOTY5OSAyMC42Mjg5IDIwLjk2OTkgMjAuNjI4OSIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9nPgo8ZGVmcz4KPGNsaXBQYXRoIGlkPSJjbGlwMF8xNDE0XzM3MSI+CjxyZWN0IHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDkgOSkiLz4KPC9jbGlwUGF0aD4KPC9kZWZzPgo8L3N2Zz4K","CACAHUETES":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTM1LjA3MTQgMTguMzU3MkMzNS4wNzE0IDE0LjI1NDUgMzEuNzQ1NSAxMC45Mjg2IDI3LjY0MjkgMTAuOTI4NkMyNC4yMzkxIDEwLjkyODYgMjEuMzcwMSAxMy4yMjY2IDIwLjQ5MTMgMTYuMzQ1MkMyMC4xODk4IDE3LjQxNSAxOS4yMzE3IDE4LjI4MzcgMTguMTMyMSAxOC40NDYyQzE0LjE1ODEgMTkuMDMzNiAxMC45Mjg2IDIyLjUxMTIgMTAuOTI4NiAyNi43MTQzQzEwLjkyODYgMzEuMzI5OSAxNC42NzAyIDM1LjA3MTQgMTkuMjg1NyAzNS4wNzE0QzIzLjQ4ODkgMzUuMDcxNCAyNi45NjY0IDMxLjg0MTkgMjcuNTUzOCAyNy44Njc5QzI3LjcxNjMgMjYuNzY4NCAyOC41ODUgMjUuODEwMiAyOS42NTQ5IDI1LjUwODhDMzIuNzczNCAyNC42MyAzNS4wNzE0IDIxLjc2MSAzNS4wNzE0IDE4LjM1NzJaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTguODIxNSAzMC40Mjg2QzE4LjU2NSAzMC40Mjg2IDE4LjM1NzIgMzAuMjIwOCAxOC4zNTcyIDI5Ljk2NDNDMTguMzU3MiAyOS43MDc4IDE4LjU2NSAyOS41IDE4LjgyMTUgMjkuNSIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTE4LjgyMTUgMzAuNDI4NkMxOS4wNzc5IDMwLjQyODYgMTkuMjg1OCAzMC4yMjA4IDE5LjI4NTggMjkuOTY0M0MxOS4yODU4IDI5LjcwNzggMTkuMDc3OSAyOS41IDE4LjgyMTUgMjkuNSIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTE4LjgyMTUgMjUuNzg1N0MxOC41NjUgMjUuNzg1NyAxOC4zNTcyIDI1LjU3NzkgMTguMzU3MiAyNS4zMjE1QzE4LjM1NzIgMjUuMDY1IDE4LjU2NSAyNC44NTcyIDE4LjgyMTUgMjQuODU3MiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTE4LjgyMTUgMjUuNzg1N0MxOS4wNzc5IDI1Ljc4NTcgMTkuMjg1OCAyNS41Nzc5IDE5LjI4NTggMjUuMzIxNUMxOS4yODU4IDI1LjA2NSAxOS4wNzc5IDI0Ljg1NzIgMTguODIxNSAyNC44NTcyIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMjMuNDY0MyAyNS43ODU3QzIzLjIwNzkgMjUuNzg1NyAyMyAyNS41Nzc5IDIzIDI1LjMyMTVDMjMgMjUuMDY1IDIzLjIwNzkgMjQuODU3MiAyMy40NjQzIDI0Ljg1NzIiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yMy40NjQzIDI1Ljc4NTdDMjMuNzIwNyAyNS43ODU3IDIzLjkyODYgMjUuNTc3OSAyMy45Mjg2IDI1LjMyMTVDMjMuOTI4NiAyNS4wNjUgMjMuNzIwNyAyNC44NTcyIDIzLjQ2NDMgMjQuODU3MiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTI5LjAzNTggMjAuMjE0M0MyOC43NzkzIDIwLjIxNDMgMjguNTcxNSAyMC4wMDY1IDI4LjU3MTUgMTkuNzUwMUMyOC41NzE1IDE5LjQ5MzYgMjguNzc5MyAxOS4yODU4IDI5LjAzNTggMTkuMjg1OCIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTI5LjAzNTggMjAuMjE0M0MyOS4yOTIyIDIwLjIxNDMgMjkuNTAwMSAyMC4wMDY1IDI5LjUwMDEgMTkuNzUwMUMyOS41MDAxIDE5LjQ5MzYgMjkuMjkyMiAxOS4yODU4IDI5LjAzNTggMTkuMjg1OCIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cg==","CEREALES":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzE0MTRfMTEyKSI+CjxwYXRoIGQ9Ik0xNC42NjEyIDIxLjM2ODJMMjUuMjM1OCAxMC45ODI0QzI4LjU4OTYgMTQuMzM2MiAyNi4zNTM3IDE5LjY0NjMgMjQuNjc2OSAyMS4zMjMyQzI2LjM1MzcgMTkuNjQ2MyAzMS42NjkxIDE3LjQxMDQgMzUuMDIyOSAyMC43NjQyTDI0LjYzMTggMzEuMzQwNkMyMS44ODU1IDM0LjEzNTggMTcuMzg3IDM0LjE1NTcgMTQuNjE2MSAzMS4zODQ4QzExLjg0NDkgMjguNjEzNiAxMS44NjUxIDI0LjExNDQgMTQuNjYxMiAyMS4zNjgyWiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTMyLjYxMzMgMjMuMjE2NUMyOS44NjMyIDI1LjE2MzggMjYuMDI2MiAyNC45MDkxIDIzLjU1OSAyMi40NDE5QzIxLjA5NDIgMTkuOTc3MSAyMC44Mzc2IDE2LjE0NTQgMjIuNzc4MyAxMy4zOTYiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xOC41Mjk5IDE3LjU2ODZDMTYuMzUwMiAyMC4zMzMyIDE2LjUzMTkgMjQuMzU4MiAxOS4wODc0IDI2LjkxMzZDMjEuNjQ0NCAyOS40NzA2IDI1LjY3MjggMjkuNjUxMSAyOC40Mzc3IDI3LjQ2NjgiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yNy4xMDA5IDE4Ljg1NTRDMjYuNjYwMiAxNS43NDMxIDI3LjcwNjggOS43MjI0IDM1LjQxODYgMTAuNTM3N0MzNi43NDA1IDE3LjI4NTUgMzAuNDMzNCAxOS43OTE4IDI3LjEwMDkgMTguODU1NFoiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xMC4yNTg1IDM1LjczOTZMMjQuNzE5NSAyMS4yNzg3IiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L2c+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzE0MTRfMTEyIj4KPHJlY3Qgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSJ3aGl0ZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOSA5KSIvPgo8L2NsaXBQYXRoPgo8L2RlZnM+Cjwvc3ZnPgo=","CRUST√ÅCEOS":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDciIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NyA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE4LjU4MTIgMzUuODU1OUgyNC43Mjk3QzI2LjEwNzUgMzUuODU2IDI3LjQ3MDcgMzUuNTczMiAyOC43MzQ5IDM1LjAyNDhDMjkuOTk4OSAzNC40NzY1IDMxLjEzNjggMzMuNjc0NCAzMi4wNzgxIDMyLjY2ODJDMzMuMDE5NSAzMS42NjE5IDMzLjc0NDEgMzAuNDczMSAzNC4yMDcxIDI5LjE3NTVDMzQuNjcwMSAyNy44Nzc3IDM0Ljg2MTYgMjYuNDk4NiAzNC43Njk3IDI1LjEyMzlDMzQuNTQ0MSAyMi41MzY3IDMzLjM0ODIgMjAuMTMwNyAzMS40MjIgMTguMzg4OUMyOS40OTU4IDE2LjY0NzEgMjYuOTgyMSAxNS42OTg0IDI0LjM4NTQgMTUuNzMzNEgxMi43NjhDMTIuNjcyNiAxNS43MzMyIDEyLjU3ODcgMTUuNzU3NCAxMi40OTUzIDE1LjgwMzhDMTIuNDExOSAxNS44NTAxIDEyLjM0MTggMTUuOTE3MSAxMi4yOTE2IDE1Ljk5ODJDMTIuMjQxNCAxNi4wNzkzIDEyLjIxMjggMTYuMTcyIDEyLjIwODUgMTYuMjY3M0MxMi4yMDQyIDE2LjM2MjYgMTIuMjI0NCAxNi40NTc0IDEyLjI2NzIgMTYuNTQyN0wxMy4wNDk3IDE4LjExNDVDMTMuNzAwMyAxOS40MTYgMTQuNzAwOSAyMC41MTAzIDE1LjkzOTEgMjEuMjc0NkMxNy4xNzczIDIyLjAzODggMTguNjA0IDIyLjQ0MjcgMjAuMDU5MSAyMi40NDA5SDIzLjM4ODJDMjQuNjY1MSAyMi40MTk1IDI1LjkwNDcgMjIuODcxIDI2Ljg2ODggMjMuNzA4NEMyNy44MzMgMjQuNTQ1OCAyOC40NTM1IDI1LjcxMDEgMjguNjExMSAyNi45Nzc0QzI4LjY4MDEgMjcuNjc1NyAyOC42MDIxIDI4LjM4MDcgMjguMzgyMyAyOS4wNDcxQzI4LjE2MjUgMjkuNzEzNSAyNy44MDU4IDMwLjMyNjYgMjcuMzM0OSAzMC44NDY5QzI2Ljg2NDEgMzEuMzY3MSAyNi4yODk2IDMxLjc4MzIgMjUuNjQ4NCAzMi4wNjgzQzI1LjAwNzMgMzIuMzUzNCAyNC4zMTM1IDMyLjUwMTEgMjMuNjExOCAzMi41MDIxSDIwLjgxN0wxOC41ODEyIDM1Ljg1NTlaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTkuMTQwMSAxNS43MzM1QzE4LjY5NTQgMTUuNzMzNSAxOC4yNjg5IDE1LjU1NjggMTcuOTU0NCAxNS4yNDI0QzE3LjYzOTkgMTQuOTI3OSAxNy40NjMyIDE0LjUwMTQgMTcuNDYzMiAxNC4wNTY2QzE3LjQ2MzIgMTMuNjExOSAxNy42Mzk5IDEzLjE4NTQgMTcuOTU0NCAxMi44NzA5QzE4LjI2ODkgMTIuNTU2NCAxOC42OTU0IDEyLjM3OTggMTkuMTQwMSAxMi4zNzk4SDI1LjI4ODciIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xNi45MDQzIDE1LjczMzVDMTYuMTYzMSAxNS43MzM1IDE1LjQ1MjIgMTUuNDM5MSAxNC45MjgxIDE0LjkxNDlDMTQuNDAzOSAxNC4zOTA4IDE0LjEwOTUgMTMuNjc5OSAxNC4xMDk1IDEyLjkzODdDMTQuMTA5NSAxMi4xOTc1IDE0LjQwMzkgMTEuNDg2NiAxNC45MjgxIDEwLjk2MjVDMTUuNDUyMiAxMC40Mzg0IDE2LjE2MzEgMTAuMTQzOSAxNi45MDQzIDEwLjE0MzlIMjkuMjAxNCIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTIwLjgxNyAzMi41MDIzQzIwLjgzNjYgMzEuNTY1OSAyMC41ODI2IDMwLjY0NDEgMjAuMDg2MiAyOS44NDk4QzE5LjU4OTggMjkuMDU1NyAxOC44NzI1IDI4LjQyMzQgMTguMDIyMiAyOC4wMzA2TDE3LjQ2MzMgMzIuNTAyM0wxMi45OTE2IDM0LjE3OTJDMTIuOTkxNiAzNC4xNzkyIDE0LjY2ODUgMzUuODU2MSAxOC41ODEyIDM1Ljg1NjEiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yNC4xNzA3IDE1LjczMzVDMjQuNjkxNCAxNi4xMjQgMjUuMTEzOSAxNi42MzA0IDI1LjQwNSAxNy4yMTI1QzI1LjY5NjEgMTcuNzk0NiAyNS44NDc2IDE4LjQzNjUgMjUuODQ3NiAxOS4wODczQzI1Ljg0NzYgMTkuNzM4MSAyNS42OTYxIDIwLjM4IDI1LjQwNSAyMC45NjIxQzI1LjExMzkgMjEuNTQ0MiAyNC42OTE0IDIyLjA1MDUgMjQuMTcwNyAyMi40NDEiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0zMy45MjQ2IDIxLjc3MDFDMzMuNzU3NCAyMy4xMzIzIDMzLjA2NTYgMjQuMzc1NiAzMS45OTYyIDI1LjIzNTdDMzEuNDQ1NyAyNS41NjE3IDMwLjgzMzYgMjUuNzY5NyAzMC4xOTg2IDI1Ljg0NjdDMjkuNTYzNSAyNS45MjM2IDI4LjkxOTQgMjUuODY3OSAyOC4zMDcgMjUuNjgyOSIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTI2LjU1NzUgMzEuNTQ2NUMyNi41NTc1IDMxLjU0NjUgMjcuMjY1MSAzNC4zNzM3IDI4Ljk0MiAzNC45MzI3IiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTkuNDE5NiAxOC41MjgzQzE5LjI2NTMgMTguNTI4MyAxOS4xNDAxIDE4LjQwMzIgMTkuMTQwMSAxOC4yNDg4QzE5LjE0MDEgMTguMDk0NSAxOS4yNjUzIDE3Ljk2OTQgMTkuNDE5NiAxNy45Njk0IiBzdHJva2U9IiMyNTI1MjUiLz4KPHBhdGggZD0iTTE5LjQxOTYgMTguNTI4M0MxOS41NzQgMTguNTI4MyAxOS42OTkxIDE4LjQwMzIgMTkuNjk5MSAxOC4yNDg4QzE5LjY5OTEgMTguMDk0NSAxOS41NzQgMTcuOTY5NCAxOS40MTk2IDE3Ljk2OTQiIHN0cm9rZT0iIzI1MjUyNSIvPgo8L3N2Zz4K","FRUTOS SECOS":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzE0MTRfMzgwKSI+CjxwYXRoIGQ9Ik0xMS4zOTYgMzMuODk3NUMxMS40NTY3IDM0LjA1ODcgMTEuNTUxMiAzNC4yMDUyIDExLjY3MyAzNC4zMjdDMTEuNzk0OCAzNC40NDg5IDExLjk0MTMgMzQuNTQzMyAxMi4xMDI1IDM0LjYwNEMyMC4zNTUgMzcuNzAwNyAyNS43OTM3IDM0LjcyMzYgMzEuMjMzNCAyOS4yODM5TDE2LjcxNjIgMTQuNzY3N0MxMS4yNzc1IDIwLjIwNTIgOC4yOTgyNyAyNS42NDYyIDExLjM5NiAzMy44OTc1WiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTM1LjUwMjggMTMuMDU5NEMzNS43Mjg5IDEyLjgzMjYgMzUuODU1OCAxMi41MjU1IDM1Ljg1NTggMTIuMjA1M0MzNS44NTU4IDExLjg4NTEgMzUuNzI4OSAxMS41Nzc5IDM1LjUwMjggMTEuMzUxMkwzNC42NDg3IDEwLjQ5NzFDMzQuNDIyIDEwLjI3MSAzNC4xMTQ4IDEwLjE0NCAzMy43OTQ2IDEwLjE0NEMzMy40NzQ0IDEwLjE0NCAzMy4xNjcyIDEwLjI3MSAzMi45NDA1IDEwLjQ5NzFMMzAuMzI5IDEzLjEwODZDMjguMzI2NiAxMS41MDkgMjUuODIzNCAxMC42Njg0IDIzLjI2MTQgMTAuNzM1M0MyMC42OTk0IDEwLjgwMjIgMTguMjQzNCAxMS43NzIyIDE2LjMyNzEgMTMuNDc0MUMxNi4yNjYgMTMuNTI4OSAxNi4yMTY3IDEzLjU5NTYgMTYuMTgyMSAxMy42NzAxQzE2LjE0NzYgMTMuNzQ0NiAxNi4xMjg1IDEzLjgyNTMgMTYuMTI2MSAxMy45MDc0QzE2LjEyMzcgMTMuOTg5NSAxNi4xMzggMTQuMDcxMiAxNi4xNjgyIDE0LjE0NzVDMTYuMTk4MyAxNC4yMjM5IDE2LjI0MzYgMTQuMjkzNCAxNi4zMDE0IDE0LjM1MTdMMzEuNjQ4MiAyOS42OTg0QzMxLjcwNjMgMjkuNzU2NyAzMS43NzU3IDI5LjgwMjYgMzEuODUyMiAyOS44MzNDMzEuOTI4NyAyOS44NjM0IDMyLjAxMDUgMjkuODc3OCAzMi4wOTI4IDI5Ljg3NTJDMzIuMTc1MSAyOS44NzI4IDMyLjI1NTkgMjkuODUzMyAzMi4zMzA1IDI5LjgxODNDMzIuNDA0OSAyOS43ODM0IDMyLjQ3MTQgMjkuNzMzNCAzMi41MjU3IDI5LjY3MTZDMzQuMjI3OCAyNy43NTU3IDM1LjE5NzkgMjUuMjk5NyAzNS4yNjQ1IDIyLjczNzhDMzUuMzMxMyAyMC4xNzU4IDM0LjQ5MDMgMTcuNjcyOCAzMi44OTAyIDE1LjY3MDhMMzUuNTAyOCAxMy4wNTk0WiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTI5LjQyOCAyMS44ODIxQzI5LjI3MzcgMjEuODgyMSAyOS4xNDg2IDIxLjc1NyAyOS4xNDg2IDIxLjYwMjZDMjkuMTQ4NiAyMS40NDgyIDI5LjI3MzcgMjEuMzIzMSAyOS40MjggMjEuMzIzMSIgc3Ryb2tlPSIjMjUyNTI1Ii8+CjxwYXRoIGQ9Ik0yOS40MjggMjEuODgyMUMyOS41ODI0IDIxLjg4MjEgMjkuNzA3NSAyMS43NTcgMjkuNzA3NSAyMS42MDI2QzI5LjcwNzUgMjEuNDQ4MiAyOS41ODI0IDIxLjMyMzEgMjkuNDI4IDIxLjMyMzEiIHN0cm9rZT0iIzI1MjUyNSIvPgo8cGF0aCBkPSJNMzAuNTQ2IDI1LjIzNThDMzAuMzkxNiAyNS4yMzU4IDMwLjI2NjUgMjUuMTEwNyAzMC4yNjY1IDI0Ljk1NjRDMzAuMjY2NSAyNC44MDIgMzAuMzkxNiAyNC42NzY5IDMwLjU0NiAyNC42NzY5IiBzdHJva2U9IiMyNTI1MjUiLz4KPHBhdGggZD0iTTMwLjU0NiAyNS4yMzU4QzMwLjcwMDMgMjUuMjM1OCAzMC44MjU0IDI1LjExMDcgMzAuODI1NCAyNC45NTY0QzMwLjgyNTQgMjQuODAyIDMwLjcwMDMgMjQuNjc2OSAzMC41NDYgMjQuNjc2OSIgc3Ryb2tlPSIjMjUyNTI1Ii8+CjxwYXRoIGQ9Ik0zMi43ODE4IDIzQzMyLjYyNzQgMjMgMzIuNTAyMyAyMi44NzQ5IDMyLjUwMjMgMjIuNzIwNUMzMi41MDIzIDIyLjU2NjEgMzIuNjI3NCAyMi40NDEgMzIuNzgxOCAyMi40NDEiIHN0cm9rZT0iIzI1MjUyNSIvPgo8cGF0aCBkPSJNMzIuNzgxOCAyM0MzMi45MzYyIDIzIDMzLjA2MTMgMjIuODc0OSAzMy4wNjEzIDIyLjcyMDVDMzMuMDYxMyAyMi41NjYxIDMyLjkzNjIgMjIuNDQxIDMyLjc4MTggMjIuNDQxIiBzdHJva2U9IiMyNTI1MjUiLz4KPC9nPgo8ZGVmcz4KPGNsaXBQYXRoIGlkPSJjbGlwMF8xNDE0XzM4MCI+CjxyZWN0IHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDkgOSkiLz4KPC9jbGlwUGF0aD4KPC9kZWZzPgo8L3N2Zz4K","HUEVO":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIzIDM1LjU3NjZDMjQuNDY1MiAzNS41OTMzIDI1LjkxNjUgMzUuMjkwNSAyNy4yNTI3IDM0LjY4OTJDMjguNTg5IDM0LjA4NzggMjkuNzc4MSAzMy4yMDI1IDMwLjczNzMgMzIuMDk0N0MzMS42OTY1IDMwLjk4NyAzMi40MDI3IDI5LjY4MzUgMzIuODA2NyAyOC4yNzVDMzMuMjEwOCAyNi44NjY1IDMzLjMwMyAyNS4zODY4IDMzLjA3NjkgMjMuOTM5MUMzMS45MDIgMTYuMzMzOSAyNy4zNzExIDEwLjQyMzUgMjMgMTAuNDIzNUMxOC42MjkgMTAuNDIzNSAxNC4wOTggMTYuMzMzOSAxMi45MjMxIDIzLjkzOTFDMTIuNjk3IDI1LjM4NjggMTIuNzg5MiAyNi44NjY1IDEzLjE5MzMgMjguMjc1QzEzLjU5NzMgMjkuNjgzNSAxNC4zMDM1IDMwLjk4NyAxNS4yNjI3IDMyLjA5NDdDMTYuMjIxOSAzMy4yMDI1IDE3LjQxMSAzNC4wODc4IDE4Ljc0NzMgMzQuNjg5MkMyMC4wODM1IDM1LjI5MDUgMjEuNTM0OCAzNS41OTMzIDIzIDM1LjU3NjZaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K","L√ÅCTEO":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMwLjgyNTQgMzMuNjIwMkMzMC44MjU0IDM0LjIxMzIgMzAuNTg5OSAzNC43ODE5IDMwLjE3MDYgMzUuMjAxMkMyOS43NTEzIDM1LjYyMDUgMjkuMTgyNiAzNS44NTYgMjguNTg5NiAzNS44NTZIMTcuNDEwNEMxNi44MTc0IDM1Ljg1NiAxNi4yNDg4IDM1LjYyMDUgMTUuODI5NSAzNS4yMDEyQzE1LjQxMDIgMzQuNzgxOSAxNS4xNzQ2IDM0LjIxMzIgMTUuMTc0NiAzMy42MjAyVjIxLjEzMDhDMTUuMTc0NyAyMC41Mzc5IDE1LjQxMDQgMTkuOTY5MyAxNS44Mjk3IDE5LjU1MDFMMTguNTI4MyAxNi44NTE0SDI3LjQ3MTdMMzAuMTcwMyAxOS41NTAxQzMwLjU4OTcgMTkuOTY5MyAzMC44MjUzIDIwLjUzNzkgMzAuODI1NCAyMS4xMzA4VjMzLjYyMDJaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTguNTI4MyAxMy40OTc3SDI3LjQ3MTdWMTYuODUxNEgxOC41MjgzVjEzLjQ5NzdaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTUuMzc4MSAyMC4yMDUySDMwLjYyMiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTE2LjI5MjUgMTMuNDk3N0MxNi4yOTI1IDEyLjYwODIgMTYuNjQ1OCAxMS43NTUyIDE3LjI3NDggMTEuMTI2MkMxNy45MDM3IDEwLjQ5NzMgMTguNzU2OCAxMC4xNDM5IDE5LjY0NjIgMTAuMTQzOUgyNi4zNTM3QzI3LjI0MzIgMTAuMTQzOSAyOC4wOTYzIDEwLjQ5NzMgMjguNzI1MiAxMS4xMjYyQzI5LjM1NDIgMTEuNzU1MiAyOS43MDc1IDEyLjYwODIgMjkuNzA3NSAxMy40OTc3SDE2LjI5MjVaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTUuMTk4MSAyMC44MUwxMi45Mzg4IDE2LjI5MjUiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0zMC44MDE5IDIwLjgxTDMzLjA2MTMgMTYuMjkyNSIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cg==","MOLUSCO":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDciIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NyA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE0LjEwMDUgMzAuNzY5OEwxNC45OTc0IDI4LjA3OTFMMjAuNjM5NiAzMi40MzlDMjEuMjkgMzIuOTQxNSAyMi4wODg3IDMzLjIxNDIgMjIuOTEwNyAzMy4yMTQySDI0LjA4OTNDMjQuOTExMiAzMy4yMTQyIDI1LjcxIDMyLjk0MTUgMjYuMzYwNCAzMi40MzlMMzIuMDAyNSAyOC4wNzkxTDMyLjg5OTUgMzAuNzY5OEMzMy4zMDAzIDMxLjk3MjUgMzIuNDA1MiAzMy4yMTQ0IDMxLjEzNzcgMzMuMjE0NEgxNS44NjIzQzE0LjU5NDcgMzMuMjE0NCAxMy42OTk3IDMxLjk3MjUgMTQuMTAwNSAzMC43Njk4WiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTIzLjUgMTIuNzg1OEMxNi44MzMxIDEyLjc4NTggMTEuNDI4NiAxOC4xOTAzIDExLjQyODYgMjQuODU3MkMxMS40Mjg2IDI1LjE1IDExLjU2NDIgMjUuNDI2MyAxMS43OTU5IDI1LjYwNTRMMjAuNjM5NiAzMi40MzkyQzIxLjI5IDMyLjk0MTcgMjIuMDg4NyAzMy4yMTQzIDIyLjkxMDcgMzMuMjE0M0gyNC4wODkzQzI0LjkxMTIgMzMuMjE0MyAyNS43MSAzMi45NDE3IDI2LjM2MDQgMzIuNDM5MkwzNS4yMDQxIDI1LjYwNTRDMzUuNDM1NyAyNS40MjYzIDM1LjU3MTQgMjUuMTUgMzUuNTcxNCAyNC44NTcyQzM1LjU3MTQgMTguMTkwMyAzMC4xNjY5IDEyLjc4NTggMjMuNSAxMi43ODU4WiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTI5LjQ3MzUgMTQuMzY1NUwyNi4yODU3IDIzLjkyOTEiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xNy41MjY0IDE0LjM2NTVMMjAuNzE0MyAyMy45MjkxIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K","MOSTAZA":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTI1Ljc5NDggMTMuNDk3N1YxOS42NDYyQzI1Ljc5NDggMjEuODgyMSAzMC44MjU0IDI0LjY3NjggMzAuODI1NCAyOC4wMzA2QzMwLjc4MzUgMzAuMzAxNCAzMC40OTk1IDMyLjU2MTIgMjkuOTc4IDM0Ljc3MTZDMjkuODg5NCAzNS4wNzUxIDI5LjcwNzcgMzUuMzQzMSAyOS40NTg2IDM1LjUzNzZDMjkuMjA5NCAzNS43MzIyIDI4LjkwNTQgMzUuODQzNiAyOC41ODk2IDM1Ljg1NkgxNy40MTA0QzE3LjA5NDUgMzUuODQzNiAxNi43OTA1IDM1LjczMjIgMTYuNTQxNCAzNS41Mzc2QzE2LjI5MjIgMzUuMzQzMSAxNi4xMTA1IDM1LjA3NTEgMTYuMDIxOSAzNC43NzE2QzE1LjUwMDUgMzIuNTYxMiAxNS4yMTY0IDMwLjMwMTQgMTUuMTc0NiAyOC4wMzA2QzE1LjE3NDYgMjQuNjc2OCAyMC4yMDUyIDIxLjg4MjEgMjAuMjA1MiAxOS42NDYyVjEzLjQ5NzciIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yNS43OTQ4IDEzLjQ5NzdIMjAuMjA1MlYxMC43MDI5QzIwLjIwNTIgMTAuNTU0NiAyMC4yNjQxIDEwLjQxMjUgMjAuMzY4OSAxMC4zMDc2QzIwLjQ3MzcgMTAuMjAyOCAyMC42MTU5IDEwLjE0MzkgMjAuNzY0MiAxMC4xNDM5SDI1LjIzNThDMjUuMzg0MSAxMC4xNDM5IDI1LjUyNjIgMTAuMjAyOCAyNS42MzExIDEwLjMwNzZDMjUuNzM1OSAxMC40MTI1IDI1Ljc5NDggMTAuNTU0NiAyNS43OTQ4IDEwLjcwMjlWMTMuNDk3N1oiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xNS4xNzQ2IDI4LjAzMDZIMzAuODI1NCIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTE1LjU3MjYgMzIuNTAyM0gzMC40Mjg2IiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K","PESCADO":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzE0MTRfMTYyKSI+CjxwYXRoIGQ9Ik0zNS4xMzYxIDEwLjg0NkMzNi4xNjAxIDExLjg3MTIgMzYuODY2NiAxOS43NzkzIDMxLjYwMzUgMjUuMDQzNkMyOC4yMzIyIDI4LjI0MjIgMjMuODI0MyAzMC4xMjM4IDE5LjE4MjMgMzAuMzQ1OUwxNS42MzUyIDI2LjgwMDlDMTUuODkwNSAyMi4xNjcxIDE3Ljc3NDMgMTcuNzcyMyAyMC45NTQyIDE0LjM5MjFDMjYuMTYxNSA5LjE4NDgxIDM0LjExMSA5LjgyMDkgMzUuMTM2MSAxMC44NDZaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTkuMTgyMyAzMC4zNDU4TDE2LjgzNDcgMzUuMTYyOUMxNi43MjgyIDM1LjM3NjEgMTYuNTYzMiAzNS41NTQ0IDE2LjM1ODkgMzUuNjc3MUMxNi4xNTQ3IDM1Ljc5OTggMTUuOTE5NyAzNS44NjE4IDE1LjY4MTUgMzUuODU1N0MxNS40NDMzIDM1Ljg0OTYgMTUuMjExOCAzNS43NzU3IDE1LjAxNDEgMzUuNjQyN0MxNC44MTY0IDM1LjUwOTcgMTQuNjYwNyAzNS4zMjMxIDE0LjU2NTMgMzUuMTA0OEwxMy41OTM4IDMyLjc1NzJMMTAuODU2MSAzMS40NTE0QzEwLjY0NDQgMzEuMzUwMiAxMC40NjU1IDMxLjE5MTUgMTAuMzM5NiAzMC45OTM1QzEwLjIxMzcgMzAuNzk1NiAxMC4xNDU5IDMwLjU2NjIgMTAuMTQzOSAzMC4zMzE2QzEwLjE0MiAzMC4wOTcgMTAuMjA1OSAyOS44NjY2IDEwLjMyODQgMjkuNjY2NUMxMC40NTA5IDI5LjQ2NjQgMTAuNjI3MiAyOS4zMDQ4IDEwLjgzNzEgMjkuMkwxNS42MzUyIDI2LjgwMDlMMTkuMTgyMyAzMC4zNDU4WiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTMzLjAxOTkgMjMuMzc3OEMzMy4wMDk4IDIzLjY2MjkgMzIuNzk2MyAyNy4xNTQxIDI4LjA2NDIgMzIuMjU3NEMyNy45NDkyIDMyLjM4MTQgMjcuODEwNCAzMi40ODA5IDI3LjY1NiAzMi41NDk5QzI3LjUwMTcgMzIuNjE4OSAyNy4zMzQ5IDMyLjY1NiAyNy4xNjU5IDMyLjY1ODlDMjYuOTk2OCAzMi42NjE5IDI2LjgyODkgMzIuNjMwNiAyNi42NzIzIDMyLjU2NjlDMjYuNTE1NiAzMi41MDMzIDI2LjM3MzQgMzIuNDA4NyAyNi4yNTQzIDMyLjI4ODdMMjMuNjA0OCAyOS42MTQ3IiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTYuMDYxMSAyMy42ODA4TDEzLjA3NzQgMjAuNjk1OUMxMi45MDI2IDIwLjUyMSAxMi43ODMzIDIwLjI5ODMgMTIuNzM0NiAyMC4wNTU5QzEyLjY4NTkgMTkuODEzNSAxMi43MDk5IDE5LjU2MiAxMi44MDM1IDE5LjMzMzJDMTMuNDM5NiAxNy43ODYgMTUuMzk4MiAxNC41ODY1IDIwLjc2NDIgMTQuNTgyIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMjguODkzNyAxNC4zNTRDMjkuMDY5IDE0LjUyOTMgMjkuMTg4NCAxNC43NTI2IDI5LjIzNjggMTQuOTk1N0MyOS4yODUyIDE1LjIzODggMjkuMjYwNCAxNS40OTA4IDI5LjE2NTUgMTUuNzE5OEMyOS4wNzA3IDE1Ljk0ODggMjguOTEwMSAxNi4xNDQ2IDI4LjcwNCAxNi4yODIzQzI4LjQ5NzkgMTYuNDIgMjguMjU1NiAxNi40OTM2IDI4LjAwNzcgMTYuNDkzNkMyNy43NTk4IDE2LjQ5MzYgMjcuNTE3NSAxNi40MiAyNy4zMTE0IDE2LjI4MjNDMjcuMTA1MyAxNi4xNDQ2IDI2Ljk0NDcgMTUuOTQ4OCAyNi44NDk5IDE1LjcxOThDMjYuNzU1IDE1LjQ5MDggMjYuNzMwMiAxNS4yMzg4IDI2Ljc3ODYgMTQuOTk1N0MyNi44MjcgMTQuNzUyNiAyNi45NDY0IDE0LjUyOTMgMjcuMTIxOCAxNC4zNTRDMjcuMzU2OCAxNC4xMTkxIDI3LjY3NTQgMTMuOTg3MiAyOC4wMDc3IDEzLjk4NzJDMjguMzQgMTMuOTg3MiAyOC42NTg2IDE0LjExOTEgMjguODkzNyAxNC4zNTRaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L2c+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzE0MTRfMTYyIj4KPHJlY3Qgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSJ3aGl0ZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOSA5KSIvPgo8L2NsaXBQYXRoPgo8L2RlZnM+Cjwvc3ZnPgo=","S√âSAMO":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE3LjQyODYgMzEuMzU3MkMxNy40Mjg2IDMyLjg5NTcgMTYuMTgxNCAzNC4xNDI5IDE0LjY0MjkgMzQuMTQyOUMxMy4xMDQzIDM0LjE0MjkgMTEuODU3MSAzMi44OTU3IDExLjg1NzEgMzEuMzU3MkMxMS44NTcxIDI4LjU3MTUgMTQuNjQyOSAyNS43ODU4IDE0LjY0MjkgMjUuNzg1OEMxNC42NDI5IDI1Ljc4NTggMTcuNDI4NiAyOC41NzE1IDE3LjQyODYgMzEuMzU3MloiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0zMi45MDI1IDE4LjA0NTRDMzIuMzc2MyAxOS40OTExIDMwLjc3NzcgMjAuMjM2NSAyOS4zMzIxIDE5LjcxMDNDMjcuODg2MyAxOS4xODQxIDI3LjE0MDkgMTcuNTg1NiAyNy42NjcxIDE2LjEzOTlDMjguNjE5OSAxMy41MjIxIDMyLjE5MDMgMTEuODU3MiAzMi4xOTAzIDExLjg1NzJDMzIuMTkwMyAxMS44NTcyIDMzLjg1NTQgMTUuNDI3NiAzMi45MDI1IDE4LjA0NTRaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMjUuNTQzIDI0LjA0OUMyNi4zNDEgMjUuMzY0MyAyNS45MjE3IDI3LjA3NzYgMjQuNjA2MyAyNy44NzU2QzIzLjI5MSAyOC42NzM4IDIxLjU3NzcgMjguMjU0MyAyMC43Nzk3IDI2LjkzOUMxOS4zMzQ3IDI0LjU1NzMgMjAuMjcxNCAyMC43MzA3IDIwLjI3MTQgMjAuNzMwN0MyMC4yNzE0IDIwLjczMDcgMjQuMDk4IDIxLjY2NzQgMjUuNTQzIDI0LjA0OVoiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0zMy4yMjUxIDMyLjg3MzVDMzIuMzg3NSAzNC4xNjQgMzAuNjYyMiAzNC41MzEyIDI5LjM3MTcgMzMuNjkzNkMyOC4wODEyIDMyLjg1NjEgMjcuNzE0IDMxLjEzMDggMjguNTUxNiAyOS44NDAyQzMwLjA2ODEgMjcuNTAzNiAzMy45MjE1IDI2LjY4MzUgMzMuOTIxNSAyNi42ODM1QzMzLjkyMTUgMjYuNjgzNSAzNC43NDE2IDMwLjUzNjcgMzMuMjI1MSAzMi44NzM1WiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTE3LjMwMTUgMTguNDgyN0MxNi4wOTU1IDE5LjQzODIgMTQuMzQzNCAxOS4yMzUxIDEzLjM4OCAxOC4wMjkyQzEyLjQzMjcgMTYuODIzMyAxMi42MzU3IDE1LjA3MTIgMTMuODQxNiAxNC4xMTU4QzE2LjAyNTEgMTIuMzg1OSAxOS45Mzg1IDEyLjgzOTQgMTkuOTM4NSAxMi44Mzk0QzE5LjkzODUgMTIuODM5NCAxOS40ODQ5IDE2Ljc1MjkgMTcuMzAxNSAxOC40ODI3WiIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cg==","SOJA":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzExNjlfMzE3NCkiPgo8cGF0aCBkPSJNMzMuODY5NiAxNC40MzEyQzMzLjA5NzUgMTMuODY5OCAzMi4xNjYxIDEzLjU3MDEgMzEuMjExNSAxMy41NzZDMzAuMjU2OSAxMy41ODIgMjkuMzI5MyAxMy44OTMyIDI4LjU2NDMgMTQuNDY0M0MyNy43OTk0IDE1LjAzNTQgMjcuMjM3MyAxNS44MzYyIDI2Ljk2MDIgMTYuNzQ5N0MyNi42ODMxIDE3LjY2MzMgMjYuNzA1NyAxOC42NDE1IDI3LjAyNDUgMTkuNTQxMkMyNS45MTMyIDE5LjY2NzggMjQuODg5NyAyMC4yMDYzIDI0LjE1NTggMjEuMDUwNEMyMy40MjIgMjEuODk0NiAyMy4wMzExIDIyLjk4MzEgMjMuMDYwNCAyNC4xMDEyQzIxLjk2NDMgMjMuODc4MiAyMC44MjQ0IDI0LjA3NCAxOS44NjU2IDI0LjY1MDJDMTguOTA2NyAyNS4yMjY0IDE4LjE5ODcgMjYuMTQwOSAxNy44ODExIDI3LjIxMzVDMTcuMDczOCAyNi43NTY1IDE2LjE0NDMgMjYuNTYyIDE1LjIyMTQgMjYuNjU2OEMxNC4yOTg2IDI2Ljc1MTYgMTMuNDI4MSAyNy4xMzExIDEyLjczMDUgMjcuNzQyN0MxMi4wMzI5IDI4LjM1NDMgMTEuNTQyOSAyOS4xNjc3IDExLjMyODIgMzAuMDcwMkMxMS4xMTM1IDMwLjk3MjcgMTEuMTg0OCAzMS45MTk3IDExLjUzMjMgMzIuNzc5OUMxMS44Nzk3IDMzLjY0IDEyLjQ4NjEgMzQuMzcwOSAxMy4yNjc0IDM0Ljg3MUMxNC4wNDg3IDM1LjM3MTIgMTQuOTY2MyAzNS42MTYxIDE1Ljg5MjkgMzUuNTcxNkMxNi44MTk1IDM1LjUyNzEgMTcuNzA5NCAzNS4xOTU1IDE4LjQzOTIgMzQuNjIyN0MxOS4xNjkgMzQuMDUgMTkuNzAyNiAzMy4yNjQ0IDE5Ljk2NiAzMi4zNzQ5QzIwLjY1NSAzMi43NjUyIDIxLjQzNTIgMzIuOTY1NSAyMi4yMjcgMzIuOTU1NEMyMy4wMTg4IDMyLjk0NTIgMjMuNzkzNiAzMi43MjUxIDI0LjQ3MjQgMzIuMzE3M0MyNS4xNTEyIDMxLjkwOTYgMjUuNzA5NSAzMS4zMjkgMjYuMDkwNCAzMC42MzQ3QzI2LjQ3MTIgMjkuOTQwNSAyNi42NjA5IDI5LjE1NzYgMjYuNjQgMjguMzY2MUMyNy40MTU3IDI4LjUyNDEgMjguMjE5NSAyOC40NzM0IDI4Ljk2OTMgMjguMjE5QzI5LjcxOSAyNy45NjQ3IDMwLjM4NzggMjcuNTE1OSAzMC45MDcyIDI2LjkxODRDMzEuNDI2NyAyNi4zMjEgMzEuNzc4MiAyNS41OTYzIDMxLjkyNTkgMjQuODE4NUMzMi4wNzM1IDI0LjA0MDcgMzIuMDEyMSAyMy4yMzc3IDMxLjc0NzcgMjIuNDkxNEMzMi42NDMgMjIuMzg5NiAzMy40ODY3IDIyLjAxOTggMzQuMTY4MiAyMS40MzAzQzM0Ljg0OTYgMjAuODQwOCAzNS4zMzcxIDIwLjA1OTIgMzUuNTY2NyAxOS4xODc5QzM1Ljc5NjMgMTguMzE2NSAzNS43NTc0IDE3LjM5NjIgMzUuNDU0OSAxNi41NDc0QzM1LjE1MjUgMTUuNjk4NiAzNC42MDA3IDE0Ljk2MSAzMy44NzE4IDE0LjQzMTJIMzMuODY5NloiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0zMy4wMDY1IDEwLjQyMzNDMzMuMDA3OSAxMS41NTYyIDMyLjg1NzUgMTIuNjg0MiAzMi41NTkzIDEzLjc3NzEiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0yNS4wMTIyIDE0LjI2QzI0LjQwNTcgMTQuMzk3NSAyMy44NDE4IDE0LjY4MDcgMjMuMzY5MiAxNS4wODVDMjIuODk2NyAxNS40ODk0IDIyLjUyOTggMTYuMDAyOCAyMi4zMDAyIDE2LjU4MDhDMjEuNTExNiAxNi4wMzU0IDIwLjU0NzMgMTUuODA1MiAxOS41OTc0IDE1LjkzNThDMTguNjQ3NSAxNi4wNjY0IDE3Ljc4MTEgMTYuNTQ4MiAxNy4xNjg5IDE3LjI4NjJDMTYuNjg2MyAxNi42NTQyIDE2LjAxOSAxNi4xODc5IDE1LjI1OTUgMTUuOTUyQzE0LjUgMTUuNzE2MSAxMy42ODYgMTUuNzIyMiAxMi45MzAyIDE1Ljk2OTZDMTIuMTc0MyAxNi4yMTY5IDExLjUxNDIgMTYuNjkzMiAxMS4wNDExIDE3LjMzMjVDMTAuNTY4IDE3Ljk3MTcgMTAuMzA1NSAxOC43NDIzIDEwLjI4OTggMTkuNTM3NEMxMC4yNzQyIDIwLjMzMjUgMTAuNTA2MiAyMS4xMTI4IDEwLjk1MzcgMjEuNzcwMUMxMS40MDEzIDIyLjQyNzUgMTIuMDQyMiAyMi45Mjk0IDEyLjc4NzcgMjMuMjA2M0MxMy41MzMyIDIzLjQ4MzIgMTQuMzQ2NCAyMy41MjE0IDE1LjExNDYgMjMuMzE1NUMxNS44ODI3IDIzLjEwOTcgMTYuNTY3OSAyMi42NyAxNy4wNzUgMjIuMDU3NSIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9nPgo8ZGVmcz4KPGNsaXBQYXRoIGlkPSJjbGlwMF8xMTY5XzMxNzQiPgo8cmVjdCB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIGZpbGw9IndoaXRlIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg5IDkpIi8+CjwvY2xpcFBhdGg+CjwvZGVmcz4KPC9zdmc+Cg==","SULFITOS":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTM1LjA3MTQgMjIuOTk5OUMzNS4wNzE0IDE2LjMzMyAyOS42NjcgMTAuOTI4NSAyMyAxMC45Mjg1QzE2LjMzMzIgMTAuOTI4NSAxMC45Mjg2IDE2LjMzMyAxMC45Mjg2IDIyLjk5OTlDMTAuOTI4NiAyOS42NjY5IDE2LjMzMzIgMzUuMDcxMyAyMyAzNS4wNzEzIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTUuMDU4MSAyNS40NzYxQzE1LjMxMyAyNi4xOTc0IDE2LjAwMDkgMjYuNzE0MiAxNi44MDk1IDI2LjcxNDJIMTguMDQ3NkMxOS4wNzMzIDI2LjcxNDIgMTkuOTA0OCAyNS44ODIxIDE5LjkwNDggMjQuODU2NEMxOS45MDQ4IDIzLjk4MzYgMTkuMjk3MSAyMy4yMjgxIDE4LjQ0NDUgMjMuMDQxNkwxNi4yNTU5IDIyLjU2MjlDMTUuNDk0OCAyMi4zOTY0IDE0Ljk1MjQgMjEuNzIyNCAxNC45NTI0IDIwLjk0MzRDMTQuOTUyNCAyMC4wMjc5IDE1LjY5NDYgMTkuMjg1NiAxNi42MTAxIDE5LjI4NTZIMTguMDQ3NkMxOC41OTc2IDE5LjI4NTYgMTkuMDkxOCAxOS41MjQ4IDE5LjQzMTkgMTkuOTA0N0MxOS41OTE4IDIwLjA4MzMgMTkuNzE3NiAyMC4yOTMxIDE5Ljc5OTEgMjAuNTIzNyIgc3Ryb2tlPSIjMjUyNTI1IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHBhdGggZD0iTTIyLjM4MSAyMS4xNDI4VjI0Ljg1NzFDMjIuMzgxIDI1Ljg4MjcgMjMuMjEyNCAyNi43MTQyIDI0LjIzODEgMjYuNzE0MkgyNS40NzYyQzI2LjUwMTkgMjYuNzE0MiAyNy4zMzM0IDI1Ljg4MjcgMjcuMzMzNCAyNC44NTcxVjIxLjE0MjhDMjcuMzMzNCAyMC4xMTcxIDI2LjUwMTkgMTkuMjg1NiAyNS40NzYyIDE5LjI4NTZIMjQuMjM4MUMyMy4yMTI0IDE5LjI4NTYgMjIuMzgxIDIwLjExNzEgMjIuMzgxIDIxLjE0MjhaIiBzdHJva2U9IiMyNTI1MjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNMzQuMTQyOSAzNS4wNzE0SDI5LjE5MDRWMzQuMDE2MkMyOS4xOTA0IDMzLjI3ODMgMjkuNjI3MiAzMi42MTA1IDMwLjMwMzIgMzIuMzE0N0wzMy4wNTg5IDMxLjEwOUMzMy43MTc0IDMwLjgyMSAzNC4xNDI5IDMwLjE3MDQgMzQuMTQyOSAyOS40NTE5QzM0LjE0MjkgMjguNDUyNyAzMy4zMzMgMjcuNjQyOCAzMi4zMzM4IDI3LjY0MjhIMzEuMDQ3NkMzMC4yMzkgMjcuNjQyOCAyOS41NTExIDI4LjE1OTYgMjkuMjk2MSAyOC44ODEiIHN0cm9rZT0iIzI1MjUyNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo="};
const AL=Object.keys(IC);
const OFFICIAL_ALLERGENS=AL;

// ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ
const USERS={administrador:'fca?cG4F+[DMY1:P6_Q\\._5'};
const loginScreen=document.getElementById('loginScreen');
const appEl=document.getElementById('app');

function checkSession(){
  const s=sessionStorage.getItem('alerg_session');
  if(s){loginScreen.classList.add('hidden');appEl.classList.add('show');document.getElementById('settingsUser').textContent=s;if(typeof ensureAppHistory==='function')ensureAppHistory();return true}
  return false;
}

document.getElementById('loginBtn').addEventListener('click',doLogin);
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('loginUser').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()});

function doLogin(){
  const u=document.getElementById('loginUser').value.trim().toLowerCase();
  const p=document.getElementById('loginPass').value;
  if(USERS[u]&&USERS[u]===p){
    sessionStorage.setItem('alerg_session',u);
    loginScreen.classList.add('hidden');appEl.classList.add('show');
    document.getElementById('settingsUser').textContent=u;
    if(typeof ensureAppHistory==='function')ensureAppHistory();
    document.getElementById('loginError').textContent='';
  }else{
    document.getElementById('loginError').textContent='Usuario o contrase√±a incorrectos';
    document.getElementById('loginPass').value='';
  }
}

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ
var APP_ENTRY_URL='';

function getNavStack(){
  const s=history.state;
  if(s&&s.app&&Array.isArray(s.stack)&&s.stack.length>0) return s.stack;
  return ['main'];
}

function getNavUrl(stack){
  if(stack[stack.length-1]==='settings') return (window.location.pathname||'/')+(window.location.search||'')+'#ajustes';
  return APP_ENTRY_URL||window.location.href.replace(/#.*$/,'');
}

function applyNavStack(stack){
  const list=stack||['main'];
  settingsBg.classList.toggle('open',list.includes('settings'));
  modalBg.classList.toggle('open',list.includes('add'));
  confirmBg.classList.toggle('open',list.includes('confirm'));
  photoWarningBg.classList.toggle('open',list.includes('photoWarning'));
  errorModalBg.classList.toggle('open',list.includes('errorModal'));
  batchSummaryBg.classList.toggle('open',list.includes('batchSummary'));
  batchReviewModalBg.classList.toggle('open',list.includes('batchReview'));
  if(!list.includes('add')&&typeof window.clearBatchPhotos==='function')window.clearBatchPhotos();
  // No hacer pushState cuando solo estamos en main: as√≠ la entrada anterior sigue siendo exitGuard y al pulsar Atr√°s se muestra "¬øDesea salir?"
}

function navPush(screen){
  const next=[...getNavStack(),screen];
  history.pushState({app:true,stack:next},'',getNavUrl(next));
}

function navBack(){
  history.back();
}

function navReplace(stack){
  history.replaceState({app:true,stack:stack||['main']},'',getNavUrl(stack||['main']));
}

function ensureAppHistory(){
  if(!appEl.classList.contains('show')) return;
  APP_ENTRY_URL=window.location.href.replace(/#.*$/,'');
  const state=history.state;
  // Queremos siempre dos pasos internos: uno de protecci√≥n de salida y otro normal
  if(!state||!state.app){
    history.replaceState({app:true,stack:['main'],exitGuard:true},'',APP_ENTRY_URL);
    history.pushState({app:true,stack:['main']},'',APP_ENTRY_URL);
  }else if(state.app&&!state.exitGuard){
    const stack=Array.isArray(state.stack)&&state.stack.length?state.stack:['main'];
    history.replaceState({app:true,stack,exitGuard:true},'',APP_ENTRY_URL);
    history.pushState({app:true,stack},'',APP_ENTRY_URL);
  }
}
const settingsBg=document.getElementById('settingsBg');
function openSettings(){
  document.getElementById('settingsCount').textContent=P.length;
  const key=localStorage.getItem('alerg_apikey')||'';
  const driveKey=localStorage.getItem('gdrive_api_key')||'';
  document.getElementById('apiKeyInput').value=key;
  const c=getGdriveConfig();
  const gci=document.getElementById('gdriveClientIdInput');
  const gak=document.getElementById('gdriveApiKeyInput');
  if(gci)gci.value=c.clientId||'';
  if(gak)gak.value=c.apiKey||'';
  updateGDriveUI();
  const st=document.getElementById('apiKeyStatus');
  if(key){st.textContent='‚úì Clave configurada';st.className='api-key-status ok'}
  else if(driveKey){st.textContent='Sin clave Gemini (hay clave de Drive)';st.className='api-key-status no'}
  else{st.textContent='Sin clave configurada';st.className='api-key-status no'}
  const testStatus=document.getElementById('apiKeyTestStatus');
  if(testStatus){
    testStatus.style.display='none';
    testStatus.style.color='var(--text2)';
    testStatus.textContent='';
  }
  const originWarn=document.getElementById('apiKeyOriginWarning');
  if(originWarn){
    if(typeof location!=='undefined'&&location.protocol==='file:'){
      originWarn.textContent='‚ö† Est√°s abriendo la app desde un archivo local (file://). Google rechaza la API key en ese caso. Abre la app desde la URL de GitHub Pages (https://perseo782.github.io/Alargenos-melia/) o desde un servidor local (http://localhost:5500/).';
      originWarn.style.display='block';
    }else{originWarn.style.display='none';}
  }
  navPush('settings');
  settingsBg.classList.add('open');
}
function closeSettings(){
  const stack=getNavStack();
  if(stack.includes('settings')) navBack();
  else settingsBg.classList.remove('open');
}
document.getElementById('gearBtn').addEventListener('click',()=>openSettings());
document.getElementById('settingsClose').addEventListener('click',()=>closeSettings());

// ‚îÄ‚îÄ‚îÄ FORCE SYNC ‚îÄ‚îÄ‚îÄ
document.getElementById('syncBtn').addEventListener('click',async()=>{
  if(!gdriveToken){showToast('Conecta Google Drive primero','info');return}
  const btn=document.getElementById('syncBtn');
  btn.style.pointerEvents='none';
  btn.style.opacity='0.5';
  try{
    showToast('‚ü≥ Sincronizando...','info');
    await gdriveSmartSync('manual');
  }catch(e){
    showToast('Error al sincronizar','info');
  }finally{
    btn.style.pointerEvents='';
    btn.style.opacity='';
  }
});
settingsBg.addEventListener('click',e=>{if(e.target===settingsBg)closeSettings()});
window.addEventListener('popstate',()=>{
  const state=history.state;
  // Estado especial de protecci√≥n de salida (primer paso Atr√°s desde la app)
  if(state&&state.app&&state.exitGuard){
    if(!confirm('¬øDesea salir de la aplicaci√≥n?')){
      history.pushState({app:true,stack:['main']},'',APP_ENTRY_URL||window.location.href.replace(/#.*$/,''));
      applyNavStack(['main']);
      return;
    }
    history.go(-1);
    return;
  }
  // Estados internos normales de la app
  if(state&&state.app){
    applyNavStack(state.stack);
    return;
  }
  // Cualquier otro caso: preguntar antes de salir
  if(!confirm('¬øDesea salir de la aplicaci√≥n?')){
    history.pushState({app:true,stack:['main']},'',APP_ENTRY_URL||window.location.href.replace(/#.*$/,''));
    applyNavStack(['main']);
    return;
  }
  history.go(-1);
});
document.getElementById('apiKeySave').addEventListener('click',()=>{
  const raw=document.getElementById('apiKeyInput').value;
  const key=normalizeApiKey(raw);
  if(key){localStorage.setItem('alerg_apikey',key);document.getElementById('apiKeyInput').value=key;const st=document.getElementById('apiKeyStatus');st.textContent='‚úì Clave guardada';st.className='api-key-status ok';showToast('Clave API guardada','info')}
  else{localStorage.removeItem('alerg_apikey');const st=document.getElementById('apiKeyStatus');st.textContent='Clave eliminada';st.className='api-key-status no'}
});
const apiKeyTestBtn=document.getElementById('apiKeyTestBtn');
if(apiKeyTestBtn){
  apiKeyTestBtn.addEventListener('click',async()=>{
    const statusEl=document.getElementById('apiKeyTestStatus');
    const typedKey=normalizeApiKey((document.getElementById('apiKeyInput').value||''));
    const keyToTest=typedKey||getApiKey();
    if(statusEl){
      statusEl.style.display='block';
      statusEl.style.color='var(--text2)';
      statusEl.textContent='Probando conexi√≥n con Gemini‚Ä¶';
    }
    apiKeyTestBtn.disabled=true;
    apiKeyTestBtn.style.opacity='0.65';
    try{
      const result=await testGeminiKey(keyToTest);
      if(result.ok){
        if(statusEl){
          statusEl.style.color='var(--green)';
          statusEl.textContent=`‚úÖ Conexi√≥n Gemini OK (HTTP ${result.status})`;
        }
        showToast('Conexi√≥n IA correcta','info');
      }else{
        const hint=result.hint?` ${result.hint}`:'';
        if(statusEl){
          statusEl.style.color='var(--red)';
          statusEl.textContent=`‚ùå ${result.message||'Error de conexi√≥n Gemini'}.${hint}`;
        }
        showToast('Fall√≥ la prueba de conexi√≥n IA','info');
      }
    }catch(err){
      const errMsg=(err&&err.message)?err.message:'Error de red';
      const hint=buildGeminiTroubleshootingHint(errMsg,(err&&err.status)||0);
      if(statusEl){
        statusEl.style.color='var(--red)';
        statusEl.textContent=`‚ùå ${errMsg}${hint?'. '+hint:''}`;
      }
      showToast('Error de red al probar IA','info');
    }finally{
      apiKeyTestBtn.disabled=false;
      apiKeyTestBtn.style.opacity='';
    }
  });
}

// Photo warnings toggle
const photoWarningsToggle=document.getElementById('photoWarningsToggle');
const photoWarningsEnabled=()=>localStorage.getItem('photo_warnings_enabled')!=='false';
photoWarningsToggle.checked=photoWarningsEnabled();
photoWarningsToggle.addEventListener('change',()=>{
  localStorage.setItem('photo_warnings_enabled',photoWarningsToggle.checked);
  showToast(photoWarningsToggle.checked?'Advertencias activadas':'Advertencias desactivadas','info');
});

document.getElementById('logoutBtn').addEventListener('click',()=>{sessionStorage.removeItem('alerg_session');location.reload()});


// ‚îÄ‚îÄ‚îÄ LOGGING SYSTEM ‚îÄ‚îÄ‚îÄ
const LOG_LEVELS={ERROR:'ERROR',WARN:'WARN',INFO:'INFO'};
const ERROR_CODES={
  API_BAD_REQUEST:'API_BAD_REQUEST',
  API_AUTH_FAILED:'API_AUTH_FAILED',
  API_FORBIDDEN:'API_FORBIDDEN',
  API_NOT_FOUND:'API_NOT_FOUND',
  API_DISABLED:'API_DISABLED',
  API_REFERRER_BLOCKED:'API_REFERRER_BLOCKED',
  API_BILLING_REQUIRED:'API_BILLING_REQUIRED',
  API_RATE_LIMIT:'API_RATE_LIMIT',
  API_TIMEOUT:'API_TIMEOUT',
  API_SERVER_ERROR:'API_SERVER_ERROR',
  API_INVALID_RESPONSE:'API_INVALID_RESPONSE',
  CONFIG_MISSING:'CONFIG_MISSING',
  NETWORK_OFFLINE:'NETWORK_OFFLINE',
  NETWORK_TIMEOUT:'NETWORK_TIMEOUT',
  NETWORK_REQUEST_FAILED:'NETWORK_REQUEST_FAILED',
  PHOTO_UNREADABLE:'PHOTO_UNREADABLE',
  PHOTO_NO_NAME:'PHOTO_NO_NAME',
  PHOTO_QUALITY:'PHOTO_QUALITY',
  JSON_PARSE_ERROR:'JSON_PARSE_ERROR',
  GDRIVE_AUTH_FAILED:'GDRIVE_AUTH_FAILED',
  GDRIVE_NOT_FOUND:'GDRIVE_NOT_FOUND',
  GDRIVE_CONFLICT:'GDRIVE_CONFLICT',
  GDRIVE_QUOTA:'GDRIVE_QUOTA',
  DB_SAVE_FAILED:'DB_SAVE_FAILED',
  DB_DUPLICATE:'DB_DUPLICATE'
};

let diagnosticLogs=[];
const MAX_LOGS=250;
const LOG_RETENTION_DAYS=10;

// Cargar logs persistidos
try {
  const stored = localStorage.getItem('app_logs');
  if(stored) diagnosticLogs = JSON.parse(stored);
} catch(e) { diagnosticLogs = []; }

function pruneByAge(items, maxDays, tsField='timestamp'){
  const cutoff = Date.now() - (maxDays*24*60*60*1000);
  return (items||[]).filter(it => {
    const t = it && it[tsField] ? Date.parse(it[tsField]) : NaN;
    return Number.isNaN(t) || t >= cutoff;
  });
}
function persistLogs(){
  diagnosticLogs = pruneByAge(diagnosticLogs, LOG_RETENTION_DAYS).slice(0, MAX_LOGS);
  try {
    localStorage.setItem('app_logs', JSON.stringify(diagnosticLogs));
  } catch(e) {
    if(e && e.name === 'QuotaExceededError' && diagnosticLogs.length > 50){
      diagnosticLogs = diagnosticLogs.slice(0, Math.floor(diagnosticLogs.length/2));
      try { localStorage.setItem('app_logs', JSON.stringify(diagnosticLogs)); } catch(_) {}
    }
  }
}

// Registro de an√°lisis de fotos (ciclo completo por analysis_id)
const MAX_ANALYSES = 500;
const ANALYSIS_RETENTION_DAYS = 10;
let diagnosticAnalyses = [];
try {
  const storedA = localStorage.getItem('app_analyses');
  if(storedA) diagnosticAnalyses = JSON.parse(storedA);
} catch(e) { diagnosticAnalyses = []; }
if(!Array.isArray(diagnosticAnalyses)) diagnosticAnalyses = [];

function pruneAnalyses(){
  const cutoff = Date.now() - (ANALYSIS_RETENTION_DAYS * 24 * 60 * 60 * 1000);
  diagnosticAnalyses = (diagnosticAnalyses || []).filter(a => {
    const t = a && a.started_at ? Date.parse(a.started_at) : NaN;
    return !Number.isNaN(t) && t >= cutoff;
  }).slice(0, MAX_ANALYSES);
}

function persistAnalyses(){
  pruneAnalyses();
  try { localStorage.setItem('app_analyses', JSON.stringify(diagnosticAnalyses)); } catch(e) {}
}
// Aplicar retenci√≥n al cargar
(function(){ pruneAnalyses(); try { localStorage.setItem('app_analyses', JSON.stringify(diagnosticAnalyses)); } catch(e) {} })();

function generateAnalysisId(){ return 'a_' + Date.now() + '_' + Math.random().toString(36).substr(2,9); }

function startPhotoAnalysis(origin, nPhotos, imageMeta){
  const analysisId = generateAnalysisId();
  const started_at = new Date().toISOString();
  const record = {
    analysis_id: analysisId,
    started_at,
    finished_at: null,
    origin,
    n_photos: nPhotos,
    A_context: {
      analysis_id: analysisId,
      started_at,
      origin,
      n_photos: nPhotos,
      image_meta: imageMeta || null,
      prompt_id: 'AI_PROMPT',
      model: typeof GEMINI_MODEL!=='undefined' ? GEMINI_MODEL : 'gemini-2.5-flash',
      provider: 'google',
      network_online: navigator.onLine
    },
    B_input: { photo_refs: true, preprocess: 'resize_compress', max_size: typeof PHOTO_MAX_SIZE !== 'undefined' ? PHOTO_MAX_SIZE : 1120, quality: typeof PHOTO_JPEG_QUALITY !== 'undefined' ? PHOTO_JPEG_QUALITY : 0.85 },
    C_raw_output: null,
    D_interpretation: null,
    E_validations: null,
    F_decision: null,
    G_saved_result: null
  };
  diagnosticAnalyses.unshift(record);
  if(diagnosticAnalyses.length > MAX_ANALYSES) diagnosticAnalyses = diagnosticAnalyses.slice(0, MAX_ANALYSES);
  persistAnalyses();
  return { analysisId, record };
}

function addAnalysisSection(analysisId, section, data){
  const a = (diagnosticAnalyses || []).find(x => x.analysis_id === analysisId);
  if(!a) return;
  if(section === 'C_raw_output') a.C_raw_output = data;
  else if(section === 'D_interpretation') a.D_interpretation = data;
  else if(section === 'E_validations') a.E_validations = data;
  else if(section === 'F_decision') a.F_decision = data;
  else if(section === 'G_saved_result') a.G_saved_result = data;
  else if(section === 'B_input' && data) a.B_input = { ...a.B_input, ...data };
  persistAnalyses();
}

function finishPhotoAnalysis(analysisId, error){
  const a = (diagnosticAnalyses || []).find(x => x.analysis_id === analysisId);
  if(!a) return;
  a.finished_at = new Date().toISOString();
  if(error) a.F_decision = a.F_decision || { decision: 'error', error: String(error.message || error) };
  persistAnalyses();
}
// addLog unificado: acepta tanto la firma antigua (level,code,message,details)
// como la nueva (event, details) usada por el sistema de sync
function addLog(levelOrEvent, codeOrDetails, message, details={}){
  let log;
  // Detectar si es llamada nueva: addLog('SYNC_STARTED', { ... })
  if(typeof codeOrDetails === 'object' || codeOrDetails === undefined) {
    log = {
      id: Date.now() + '_' + Math.random().toString(36).substr(2,4),
      timestamp: new Date().toISOString(),
      level: 'INFO',
      code: levelOrEvent,
      message: levelOrEvent,
      details: codeOrDetails || {}
    };
  } else {
    // Llamada antigua: addLog(level, code, message, details)
    log = {
      id: Date.now() + '_' + Math.random().toString(36).substr(2,4),
      timestamp: new Date().toISOString(),
      level: levelOrEvent,
      code: codeOrDetails,
      message: message || codeOrDetails,
      details: details
    };
  }
  diagnosticLogs.unshift(log);
  if(diagnosticLogs.length>MAX_LOGS) diagnosticLogs=diagnosticLogs.slice(0,MAX_LOGS);
  persistLogs();
  try { updateLogDisplay(); } catch(e) { console.warn('[LOG] updateLogDisplay error', e); }
  console.log('[LOG]', log.code, log.details || log.message);
  return log;
}

// appLogs es alias para compatibilidad con las nuevas funciones de historial
Object.defineProperty(window, 'appLogs', {
  get() { return diagnosticLogs; },
  set(v) { diagnosticLogs = v; }
});

function updateLogDisplay(){
  const container=document.getElementById('logContainer');
  if(!container)return;
  const logs=(typeof diagnosticLogs!=='undefined'&&Array.isArray(diagnosticLogs))?diagnosticLogs:[];
  if(logs.length===0){
    container.innerHTML='<div style="color:var(--text2);text-align:center;padding:20px">No hay eventos registrados</div>';
    return;
  }
  function esc(s){ if(s==null||s===undefined) return ''; const t=String(s); return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  const visible=logs.slice(0,80);
  const total=logs.length;
  const html=visible.map((log,i)=>{
    try {
      const ts=log&&log.timestamp;
      const time=ts ? (function(){ try { const d=new Date(ts); return isNaN(d.getTime()) ? '‚Äî' : d.toLocaleTimeString('es-ES'); } catch(_){ return '‚Äî'; } })() : '‚Äî';
      const level=(log&&log.level)||'INFO';
      const code=(log&&log.code)!=null ? String(log.code) : '';
      const msg=(log&&log.message)!=null ? String(log.message) : code || '‚Äî';
      const icon=level==='ERROR'?'‚ùå':level==='WARN'?'‚ö†Ô∏è':'‚úì';
      const color=level==='ERROR'?'var(--red)':level==='WARN'?'var(--orange)':'var(--green)';
      const isAudit=code&&code.startsWith('AUDIT_');
      const isSync=code&&code.startsWith('SYNC_');
      const syncMsg=isSync&&(msg===code) ? ({ SYNC_STARTED:'Inicio de sincronizaci√≥n', SYNC_FINISHED:'Sync finalizado', SYNC_ERROR:'Error de sync', SYNC_REMOTE_FILE_FOUND:'Archivo remoto encontrado', SYNC_REMOTE_FILE_NOT_FOUND:'Sin archivo remoto' }[code]||msg) : msg;
      const title=isAudit ? `Revisi√≥n: ${esc(msg)}` : isSync ? `Sync: ${esc(syncMsg)}` : `${esc(level)}: ${esc(code)}`;
      let extra='';
      const details=log&&log.details;
      if(isAudit&&details&&typeof details==='object'){
        const d=details;
        const prod=d.product||d.product_after||d.target||d.merged_name||'';
        const extraParts=[];
        if(d.total_flagged!=null) extraParts.push(`Marcados: ${d.total_flagged}`);
        if(d.error) extraParts.push(esc(d.error));
        const reasons=Array.isArray(d.reasons) ? d.reasons : [];
        if(reasons.length) extraParts.push('‚ö† '+reasons.map(r=>esc(r)).join(' ¬∑ '));
        if(extraParts.length) extra=`<div style="color:var(--text2);font-size:11px">${extraParts.join(' ¬∑ ')}</div>`;
        if(prod) extra=`<div style="color:var(--text2);font-size:11px">${esc(prod)}</div>`+extra;
      }
      if(isSync&&details&&typeof details==='object'){
        const d=details;
        const parts=[];
        if(d.trigger) parts.push(`Disparo: ${esc(d.trigger)}`);
        if(d.local_count!=null) parts.push(`Local: ${d.local_count}`);
        if(d.local_count_before!=null&&d.local_count_after!=null) parts.push(`Local: ${d.local_count_before}‚Üí${d.local_count_after}`);
        if(d.remote_count!=null) parts.push(`Remoto: ${d.remote_count}`);
        if(d.remote_count_before!=null) parts.push(`Remoto: ${d.remote_count_before}‚Üí${(d.remote_count_after!=null?d.remote_count_after:d.remote_count_before)}`);
        if(d.decision) parts.push(esc(d.decision));
        if(d.summary_message) parts.push(esc(d.summary_message));
        if(d.error_detail||d.error) parts.push('Error: '+esc(d.error_detail||d.error));
        if(parts.length) extra=`<div style="color:var(--text2);font-size:11px">${parts.join(' ¬∑ ')}</div>`;
      }
      if(!extra&&details&&typeof details==='object'){
        const d=details;
        const parts=[];
        if(d.status!=null) parts.push(`HTTP ${esc(d.status)}${d.status_text ? ' '+esc(d.status_text) : ''}`);
        if(d.probable_cause) parts.push(`Causa: ${esc(d.probable_cause)}`);
        if(d.provider_message) parts.push(`Proveedor: ${esc(d.provider_message)}`);
        if(d.error) parts.push(`Error: ${esc(d.error)}`);
        if(parts.length) extra=`<div style="color:var(--text2);font-size:11px">${parts.join(' ¬∑ ')}</div>`;
      }
      const body=extra ? `<div style="color:var(--text);font-size:12px">${esc(msg)}</div>${extra}` : `<div style="color:var(--text);font-size:12px">${esc(msg)}</div>`;
      return `<div style="margin-bottom:8px;border-left:3px solid ${color};padding-left:8px">
        <div style="color:${color}">${icon} ${title}</div>
        ${body}
        <div style="color:var(--text2);font-size:10px">${esc(time)}</div>
      </div>`;
    } catch(err) {
      return `<div style="margin-bottom:8px;border-left:3px solid var(--orange);padding-left:8px;font-size:11px;color:var(--text2)">
        ‚ö† Registro no mostrable (error)
        <div style="font-size:10px">${(err&&err.message)?esc(err.message):'‚Äî'}</div>
      </div>`;
    }
  }).join('');
  const footer=total>visible.length ? `<div style="text-align:center;padding:8px;font-size:11px;color:var(--text2)">Mostrando ${visible.length} de ${total} ¬∑ Los m√°s recientes arriba</div>` : '';
  container.innerHTML=html+footer;
}

function updateAppStatus(){
  const status=document.getElementById('appStatus');
  if(!status)return;
  const apiConfigured=!!getApiKey();
  const gdriveConnected=!!localStorage.getItem('gdrive_token');
  const offlineQueue=(typeof photoQueue!=='undefined' && Array.isArray(photoQueue))?photoQueue.length:0;
  status.innerHTML=`
    ‚Ä¢ Productos: ${P.length}
    ‚Ä¢ API Gemini: ${apiConfigured?'‚úì Configurada':'‚ùå Sin configurar'}
    ‚Ä¢ Google Drive: ${gdriveConnected?'‚úì Conectado':'‚ùå Desconectado'}
    ‚Ä¢ Cola offline: ${offlineQueue} pendientes
  `;
}

function exportDiagnostics(){
  const env={
    browser:navigator.userAgent,
    os:navigator.platform,
    online:navigator.onLine,
    screen:`${window.screen.width}x${window.screen.height}`,
    language:navigator.language
  };
  const state={
    logged_in:!!sessionStorage.getItem('alerg_session'),
    products_count:P.length,
    api_configured:!!getApiKey(),
    gdrive_connected:!!localStorage.getItem('gdrive_token'),
    offline_queue:0,
    db_source: typeof DB_SOURCE !== 'undefined' ? DB_SOURCE : 'unknown',
    local_last_update: localStorage.getItem('local_last_update') || null,
    remote_last_count: localStorage.getItem('remote_last_count') || null,
    remote_last_update_read: localStorage.getItem('remote_last_update_read') || null,
    last_sync_decision: localStorage.getItem('last_sync_decision') || null,
    pending_changes: typeof pendingChanges !== 'undefined' ? pendingChanges : null
  };
  const diagnostic={
    app:'Al√©rgenos Meli√°',
    version:'1.0.0',
    timestamp_export:new Date().toISOString(),
    environment:env,
    state:state,
    app_logs: typeof appLogs !== 'undefined' ? appLogs : [],
    legacy_logs: typeof diagnosticLogs !== 'undefined' ? diagnosticLogs : [],
    analyses: typeof diagnosticAnalyses !== 'undefined' ? diagnosticAnalyses : []
  };
  return JSON.stringify(diagnostic,null,2);
}

// Event listeners para botones de logs
document.addEventListener('DOMContentLoaded',()=>{
  const copyBtn=document.getElementById('copyLogsBtn');
  const clearBtn=document.getElementById('clearLogsBtn');
  if(copyBtn){
    copyBtn.onclick=async function(){
      try{
        const text=exportDiagnostics();
        console.log('[COPY] Intentando copiar',text.length,'caracteres');
        
        // M√©todo 1: Clipboard API moderno
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
          showToast('‚úì Diagn√≥stico copiado','info');
          console.log('[COPY] Copiado con Clipboard API');
        }else{
          // M√©todo 2: Fallback cl√°sico
          const textarea=document.createElement('textarea');
          textarea.value=text;
          textarea.style.position='fixed';
          textarea.style.top='0';
          textarea.style.left='0';
          textarea.style.opacity='0';
          textarea.style.pointerEvents='none';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          const successful=document.execCommand('copy');
          document.body.removeChild(textarea);
          if(successful){
            showToast('‚úì Diagn√≥stico copiado','info');
            console.log('[COPY] Copiado con execCommand');
          }else{
            throw new Error('execCommand fall√≥');
          }
        }
      }catch(err){
        console.error('[COPY] Error:',err);
        showToast('Error al copiar: '+err.message,'error');
        // Mostrar en alert como √∫ltimo recurso
        const text=exportDiagnostics();
        alert('Copia esto manualmente:\n\n'+text.substring(0,500)+'...');
      }
    };
  }
  if(clearBtn){
    clearBtn.onclick=function(){
      diagnosticLogs=[];
      persistLogs();
      updateLogDisplay();
      showToast('Registro limpiado','info');
    };
  }
  // Inicializar displays
  persistLogs();
  updateLogDisplay();
  updateAppStatus();
  updateSyncStatusUI();
  addLog(LOG_LEVELS.INFO,'APP_STARTED','Aplicaci√≥n iniciada',{});
});

// Claves API: Gemini y Vision se guardan por separado para evitar usar por error la clave de Drive en Gemini.
// Normalizar clave: quitar espacios, saltos de l√≠nea y caracteres invisibles que Google rechaza.
function normalizeApiKey(s){if(typeof s!=='string')return '';return s.replace(/\s/g,'').replace(/\u200B|\uFEFF/g,'').trim()}
function getApiKey(){return normalizeApiKey(localStorage.getItem('alerg_apikey')||'')}
function getVisionApiKey(){return normalizeApiKey(localStorage.getItem('gdrive_api_key')||'')}
const GEMINI_MODEL='gemini-2.5-flash';
const GEMINI_GENERATE_URL=`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent`;
function buildGeminiHeaders(apiKey){
  return {'Content-Type':'application/json','x-goog-api-key':normalizeApiKey(apiKey||'')};
}

function sanitizeUrlForDiagnostics(rawUrl){
  const input=String(rawUrl||'');
  if(!input) return '';
  try{
    const u=new URL(input, window.location.origin);
    ['key','api_key','access_token','token','oauth_token'].forEach(param=>{
      if(u.searchParams.has(param)) u.searchParams.set(param,'[REDACTED]');
    });
    return u.toString();
  }catch(_){
    return input.replace(/([?&](?:key|api_key|access_token|token|oauth_token)=)[^&]*/gi,'$1[REDACTED]');
  }
}
function trimDiagnostic(value,maxLen=2200){
  if(value==null) return null;
  let text='';
  if(typeof value==='string') text=value;
  else{
    try{text=JSON.stringify(value)}catch(_){text=String(value)}
  }
  return text.length>maxLen ? text.slice(0,maxLen)+'...[truncado]' : text;
}
function extractProviderErrorMessage(payload){
  if(payload==null) return '';
  if(typeof payload==='string') return payload;
  if(typeof payload==='object'){
    if(payload.error){
      if(typeof payload.error==='string') return payload.error;
      if(payload.error.message) return payload.error.message;
      if(payload.error.status) return payload.error.status;
    }
    if(payload.message) return payload.message;
    if(payload.error_description) return payload.error_description;
  }
  return trimDiagnostic(payload,1000)||'';
}
function isApiKeyInvalidMessage(providerMessage){
  const msg=String(providerMessage||'').toLowerCase();
  return /api[_ -]?key[^a-z0-9]*(not valid|invalid)|api_key_invalid|invalid api key|provided api key is invalid|request had invalid authentication credentials/.test(msg);
}
function buildGeminiTroubleshootingHint(providerMessage,status){
  const msg=String(providerMessage||'').toLowerCase();
  if(typeof location!=='undefined'&&location.protocol==='file:'){
    return 'Abre la app desde GitHub Pages o localhost, no desde archivo local (file://).';
  }
  if(/referer|referrer|origin|not authorized for this referrer/.test(msg)){
    return 'En Google Cloud, a√±ade https://perseo782.github.io/* en "HTTP referrers" de la API key.';
  }
  if(isApiKeyInvalidMessage(msg)){
    return 'La API key de Gemini no es v√°lida para este proyecto; vuelve a pegarla y gu√°rdala en Ajustes.';
  }
  if(/disabled|has not been used|not enabled|service disabled/.test(msg)){
    return 'Habilita "Generative Language API" en Google Cloud para el proyecto de la clave.';
  }
  if(/billing|payment|financial/.test(msg)){
    return 'Activa facturaci√≥n en Google Cloud para el proyecto de la clave.';
  }
  if(status===403){
    return 'Revisa restricciones de la API key: APIs permitidas y dominio autorizado.';
  }
  return '';
}
async function parseHttpErrorPayload(response){
  try{
    const clone=response.clone();
    const ct=(clone.headers.get('content-type')||'').toLowerCase();
    if(ct.includes('application/json')) return await clone.json();
    const t=await clone.text();
    return t||null;
  }catch(_){
    return null;
  }
}
function classifyHttpFailure(status, providerMessage){
  const msg=String(providerMessage||'').toLowerCase();
  if(isApiKeyInvalidMessage(msg)) return 'API key inv√°lida, mal copiada o de otro proyecto de Google Cloud.';
  if(status===0){
    if(/cors|origin|access-control/.test(msg)) return 'Bloqueo CORS u origen no permitido.';
    if(/failed to fetch|networkerror|load failed/.test(msg)) return 'No se pudo contactar con el servidor (DNS, red, firewall o adblock).';
    return 'Fallo de red del navegador o corte de conexion.';
  }
  if(status===400) return 'Peticion mal formada (JSON/campos obligatorios incorrectos).';
  if(status===401) return 'Credenciales invalidas o caducadas.';
  if(status===403){
    if(/referer|referrer|origin|not authorized for this referrer/.test(msg)) return 'La clave API esta restringida y este dominio no esta autorizado.';
    if(/disabled|has not been used|not enabled|service disabled/.test(msg)) return 'La API esta deshabilitada en Google Cloud.';
    if(/billing|payment|cloud billing|financial/.test(msg)) return 'Falta facturacion activa o saldo/cuota del proyecto.';
    return 'Acceso prohibido: permisos insuficientes o politica de seguridad.';
  }
  if(status===404) return 'Endpoint/modelo/recurso no encontrado.';
  if(status===408) return 'Timeout del servidor o de pasarela.';
  if(status===409) return 'Conflicto de version/estado del recurso.';
  if(status===429 || /quota|rate limit|resource exhausted|insufficient/.test(msg)) return 'Limite de cuota o peticiones superado.';
  if(status>=500) return 'Fallo interno temporal en servidores de Google.';
  return 'Error HTTP no clasificado; revisar detalle del proveedor.';
}
function mapHttpStatusToErrorCode(status, providerMessage){
  const msg=String(providerMessage||'').toLowerCase();
  if(isApiKeyInvalidMessage(msg)) return ERROR_CODES.API_AUTH_FAILED;
  if(status===400) return ERROR_CODES.API_BAD_REQUEST;
  if(status===401) return ERROR_CODES.API_AUTH_FAILED;
  if(status===403){
    if(/referer|referrer|origin|not authorized for this referrer/.test(msg)) return ERROR_CODES.API_REFERRER_BLOCKED;
    if(/disabled|has not been used|not enabled|service disabled/.test(msg)) return ERROR_CODES.API_DISABLED;
    if(/billing|payment|cloud billing|financial/.test(msg)) return ERROR_CODES.API_BILLING_REQUIRED;
    return ERROR_CODES.API_FORBIDDEN;
  }
  if(status===404) return ERROR_CODES.API_NOT_FOUND;
  if(status===408) return ERROR_CODES.API_TIMEOUT;
  if(status===429 || /quota|rate limit|resource exhausted|insufficient/.test(msg)) return ERROR_CODES.API_RATE_LIMIT;
  if(status>=500) return ERROR_CODES.API_SERVER_ERROR;
  return ERROR_CODES.API_INVALID_RESPONSE;
}
async function fetchWithDiagnostics(url, options={}, meta={}){
  const service=meta.service||'Servicio HTTP';
  const operation=meta.operation||'solicitud';
  const method=(options&&options.method)||'GET';
  const safeUrl=sanitizeUrlForDiagnostics(url);
  const startTs=(typeof performance!=='undefined'&&performance.now)?performance.now():Date.now();
  const requestTag=meta.requestTag||null;
  if(meta.requireOnline && !navigator.onLine){
    const err=new Error('Sin conexion a internet');
    err.code=ERROR_CODES.NETWORK_OFFLINE;
    addLog(LOG_LEVELS.ERROR, ERROR_CODES.NETWORK_OFFLINE, `${service} (${operation}) sin conexion`, {
      service, operation, method, url:safeUrl, online:false, request_tag:requestTag
    });
    throw err;
  }
  try{
    const response=await fetch(url,options);
    const endTs=(typeof performance!=='undefined'&&performance.now)?performance.now():Date.now();
    const durationMs=Math.max(0,Math.round(endTs-startTs));
    if(!response.ok){
      const payload=await parseHttpErrorPayload(response);
      const providerMessage=extractProviderErrorMessage(payload);
      const probableCause=classifyHttpFailure(response.status,providerMessage);
      const errorCode=mapHttpStatusToErrorCode(response.status,providerMessage);
      addLog(LOG_LEVELS.ERROR,errorCode,`${service} (${operation}) devolvio HTTP ${response.status}`,{
        service,
        operation,
        method,
        url:safeUrl,
        status:response.status,
        status_text:response.statusText||'',
        online:navigator.onLine,
        duration_ms:durationMs,
        probable_cause:probableCause,
        provider_message:trimDiagnostic(providerMessage,900),
        provider_payload:trimDiagnostic(payload,2500),
        request_tag:requestTag
      });
    }else if(meta.logSuccess){
      addLog(LOG_LEVELS.INFO,meta.successCode||'CONNECTION_OK',`${service} (${operation}) OK`,{
        service,
        operation,
        method,
        url:safeUrl,
        status:response.status,
        duration_ms:durationMs,
        request_tag:requestTag
      });
    }
    return response;
  }catch(err){
    const endTs=(typeof performance!=='undefined'&&performance.now)?performance.now():Date.now();
    const durationMs=Math.max(0,Math.round(endTs-startTs));
    const isAbort=!!(err&&err.name==='AbortError');
    const offline=!navigator.onLine;
    const errMsg=(err&&err.message)?err.message:String(err||'Error de red');
    const errorCode=offline ? ERROR_CODES.NETWORK_OFFLINE : (isAbort ? ERROR_CODES.NETWORK_TIMEOUT : ERROR_CODES.NETWORK_REQUEST_FAILED);
    const probableCause=offline ? 'Sin conexion local o red inestable.' : (isAbort ? 'Timeout de solicitud.' : classifyHttpFailure(0, errMsg));
    addLog(LOG_LEVELS.ERROR,errorCode,`${service} (${operation}) sin respuesta`,{
      service,
      operation,
      method,
      url:safeUrl,
      online:navigator.onLine,
      duration_ms:durationMs,
      error:trimDiagnostic(errMsg,1200),
      probable_cause:probableCause,
      request_tag:requestTag
    });
    const wrapped=new Error(errMsg);
    wrapped.name=(err&&err.name)||'NetworkError';
    wrapped.code=errorCode;
    wrapped.status=(err&&err.status)||0;
    wrapped.cause=err;
    throw wrapped;
  }
}

async function testGeminiKey(rawKey){
  const apiKey=normalizeApiKey(rawKey||getApiKey());
  if(!apiKey){
    return {
      ok:false,
      status:401,
      message:'Clave API de Gemini no configurada',
      hint:'Guarda la clave en Ajustes y vuelve a probar.'
    };
  }
  const response=await fetchWithDiagnostics(GEMINI_GENERATE_URL,{
    method:'POST',
    headers:buildGeminiHeaders(apiKey),
    body:JSON.stringify({
      contents:[{role:'user',parts:[{text:'Responde SOLO con "OK".'}]}],
      generationConfig:{maxOutputTokens:16,temperature:0}
    })
  },{
    service:'Gemini',
    operation:'test de conexion',
    requestTag:'gemini_healthcheck',
    requireOnline:true,
    logSuccess:true,
    successCode:'GEMINI_HEALTH_OK'
  });
  if(!response.ok){
    const payload=await parseHttpErrorPayload(response);
    const providerMessage=extractProviderErrorMessage(payload)||`HTTP ${response.status}`;
    return {
      ok:false,
      status:response.status,
      message:providerMessage,
      hint:buildGeminiTroubleshootingHint(providerMessage,response.status)
    };
  }
  const data=await response.json().catch(()=>({}));
  const text=(data.candidates&&data.candidates[0]&&data.candidates[0].content&&data.candidates[0].content.parts&&data.candidates[0].content.parts[0])?String(data.candidates[0].content.parts[0].text||'').trim():'OK';
  return {ok:true,status:response.status,message:text||'OK'};
}

function extractTextFromVisionResponse(data){
  try{
    const responses = (data && data.responses) || [];
    let text = '';
    responses.forEach(r=>{
      if(r && r.fullTextAnnotation && r.fullTextAnnotation.text){
        text += (text ? '\n\n' : '') + r.fullTextAnnotation.text;
      }else if(Array.isArray(r && r.textAnnotations) && r.textAnnotations.length){
        text += (text ? '\n\n' : '') + (r.textAnnotations[0].description || '');
      }
    });
    return String(text || '').trim();
  }catch(_){
    return '';
  }
}

function buildResultFromOcrText(rawText){
  const text=String(rawText||'').replace(/\r/g,'');
  const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
  let nombre='';
  const candidatos=[];
  for(const line of lines){
    const low=line.toLowerCase();
    if(low.includes('ingrediente')||low.includes('al√©rgen')||low.includes('alergen')||low.includes('allergen')) continue;
    if(low.includes('informaci√≥n nutricional')||low.includes('peso neto')||low.includes('peso bruto')) continue;
    if(line.length>=3&&line.length<=120) candidatos.push(line);
  }
  if(candidatos.length){
    candidatos.sort((a,b)=>b.length-a.length);
    nombre=candidatos[0];
  }
  if(!nombre) nombre=lines[0]||'';

  const hallazgos_texto=[];
  const alergenos=new Set();
  const trazas=new Set();
  const mapeo=[];

  const ALLERGEN_RULES=[
    {allergen:'CEREALES',rx:[/gluten/i,/trig/i,/trigo/i,/cebad/i,/avena/i,/centen/i]},
    {allergen:'L√ÅCTEO',rx:[/leche/i,/l√°cte/i,/lactos/i,/suero/i,/queso/i,/mantequill/i]},
    {allergen:'HUEVO',rx:[/huevo/i,/huevos/i,/egg/i,/ovoalb/i]},
    {allergen:'FRUTOS SECOS',rx:[/almendr/i,/nuez/i,/avellan/i,/pistach/i,/anacard/i,/frutos?\s+secos?/i]},
    {allergen:'CACAHUETES',rx:[/cacahuet[ea]/i,/peanut/i,/man[i√≠]/i]},
    {allergen:'SOJA',rx:[/soja/i,/soy/i,/edamame/i,/miso/i,/tofu/i]},
    {allergen:'S√âSAMO',rx:[/s√©sam/i,/sesam/i,/tahin[i√≠]/i]},
    {allergen:'APIO',rx:[/apio/i,/celery/i,/c√©leri/i]},
    {allergen:'MOSTAZA',rx:[/mostaz/i,/mustard/i]},
    {allergen:'SULFITOS',rx:[/sulfit/i,/anh√≠drido\s+sulfuroso/i,/anhidrido\s+sulfuroso/i,/e22[0-8]/i]},
    {allergen:'PESCADO',rx:[/pescad/i,/atun/i,/at√∫n/i,/salmon/i,/salm√≥n/i,/bacalao/i,/merluza/i]},
    {allergen:'CRUST√ÅCEOS',rx:[/crustac[e√©]o/i,/gamb[ao]/i,/langost/i,/marisc/i]},
    {allergen:'MOLUSCO',rx:[/mejillon/i,/mejill√≥n/i,/almej/i,/pulpo/i,/calamar/i,/molusc/i]},
    {allergen:'ALTRAMUZ',rx:[/altramuz/i,/lupin/i]}
  ];

  lines.forEach(line=>{
    const low=line.toLowerCase();
    const isAllergenLine=/al[√©e]rgenos?/i.test(line)||/allergen/i.test(line)||/contiene/i.test(line)||/puede contener/i.test(line)||/trazas/i.test(line);
    if(!isAllergenLine) return;
    hallazgos_texto.push(line);
    const isTrace=/puede contener|trazas/i.test(low);
    ALLERGEN_RULES.forEach(rule=>{
      const hit=rule.rx.find(rx=>rx.test(line));
      if(hit){
        if(isTrace)trazas.add(rule.allergen);
        else alergenos.add(rule.allergen);
        mapeo.push({texto:line,alergeno:rule.allergen});
      }
    });
  });

  return{
    nombre,
    hallazgos_texto,
    mapeo,
    alergenos:[...alergenos],
    trazas:[...trazas],
    notas:'',
    warning:''
  };
}

/** Si la IA devolvi√≥ un fragmento de ingredientes como "nombre", lo corrige usando el inicio del texto OCR (t√≠tulo real). */
function fixNombreFromOcr(nombre, ocrText){
  const n=(nombre||'').trim();
  if(!n) return n;
  const ocr=String(ocrText||'').trim();
  if(!ocr) return n;
  const looksLikeIngredients=/ingredientes?|E-\d|marina,|potenciador|harina de ma√≠z|harina de trigo|sal,|agua,|pimiento,|cebolla,|aceite|grasa vegetal|Ngredientes/i.test(n) || (n.length>50 && /,/.test(n));
  if(!looksLikeIngredients) return n;
  const lines=ocr.replace(/\r/g,'').split('\n').map(l=>l.trim()).filter(Boolean);
  const stopWords=/ingredientes?|informaci√≥n nutricional|kcal|E-\d|peso neto|peso bruto|modo de empleo/i;
  const candidatos=[];
  for(const line of lines){
    if(stopWords.test(line)) break;
    if(line.length>=2&&line.length<=120&&!/^\d+$/.test(line)) candidatos.push(line);
  }
  if(candidatos.length===0) return n;
  // Unir todas las l√≠neas de t√≠tulo (ej. "Aceitunas" + "verdes" + "con hueso" + "partidas" + "ali√±adas." + "Verdiales.")
  let combined=candidatos.join(' ').replace(/\s+/g,' ').trim();
  // Cortar en el primer punto si hay frase completa (evitar "Verdiales." como segundo t√≠tulo)
  const atPeriod=combined.indexOf('.');
  if(atPeriod>15) combined=combined.slice(0,atPeriod).trim();
  if(combined.length>80) combined=combined.slice(0,80).trim();
  return combined||n;
}
const ACCENT_MAP={
  'rucula':'R√∫cula','sesamo':'S√©samo','atun':'At√∫n','jamon':'Jam√≥n','salmon':'Salm√≥n',
  'melocoton':'Melocot√≥n','esparragos':'Esp√°rragos','esparrago':'Esp√°rrago',
  'champinon':'Champi√±√≥n','champinones':'Champi√±ones','arandanos':'Ar√°ndanos',
  'arandano':'Ar√°ndano','platano':'Pl√°tano','platanos':'Pl√°tanos','datiles':'D√°tiles',
  'datil':'D√°til','albondigas':'Alb√≥ndigas','albondiga':'Alb√≥ndiga','pure':'Pur√©',
  'pate':'Pat√©','ragu':'Rag√∫','fideua':'Fideu√°','azucar':'Az√∫car','oregano':'Or√©gano',
  'rabano':'R√°bano','limon':'Lim√≥n','clasica':'Cl√°sica','clasico':'Cl√°sico',
  'iberico':'Ib√©rico','iberica':'Ib√©rica','tartara':'T√°rtara','ecologico':'Ecol√≥gico',
  'ecologica':'Ecol√≥gica','semola':'S√©mola','canapes':'Canap√©s','canape':'Canap√©',
  'cafe':'Caf√©','calabacin':'Calabac√≠n','pimenton':'Piment√≥n','requeson':'Reques√≥n',
  'bombon':'Bomb√≥n','higado':'H√≠gado','nectar':'N√©ctar','curcuma':'C√∫rcuma',
  'fricando':'Fricand√≥','mejillon':'Mejill√≥n','mejillones':'Mejillones'
};
function normWord(w){return w.normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').toLowerCase()}
function autoCorrectName(name){return name.split(/(\s+)/).map(p=>{if(/^\s+$/.test(p))return p;const k=normWord(p);if(ACCENT_MAP[k]){const c=ACCENT_MAP[k];return p[0]===p[0].toUpperCase()?c[0].toUpperCase()+c.slice(1):c[0].toLowerCase()+c.slice(1)}return p}).join('')}

function canonicalizeProductName(name){
  return autoCorrectName(String(name||'').trim().replace(/\s+/g,' '));
}
function sanitizeAllergenList(arr){
  const valid = new Set(AL);
  return sortAllergens([...(new Set((Array.isArray(arr)?arr:[]).map(a=>String(a||'').trim().toUpperCase()).filter(a=>valid.has(a))))]);
}
function sanitizeProductList(list){
  if(!Array.isArray(list)) return [];
  const map = new Map();
  list.forEach(item => {
    if(!item || typeof item.n==='undefined') return;
    const name = canonicalizeProductName(item.n);
    if(!name) return;
    const key = norm(name);
    const allergens = sanitizeAllergenList(item.a || []);
    if(map.has(key)){
      const prev = map.get(key);
      prev.a = sanitizeAllergenList([...(prev.a||[]), ...allergens]);
      if(name.length > prev.n.length) prev.n = name;
      const prevTs = prev.last_analysis_timestamp ? Date.parse(prev.last_analysis_timestamp) : 0;
      const itemTs = item.last_analysis_timestamp ? Date.parse(item.last_analysis_timestamp) : 0;
      if(itemTs > prevTs && item.last_analysis_id != null){ prev.last_analysis_id = item.last_analysis_id; prev.last_analysis_timestamp = item.last_analysis_timestamp; }
    } else {
      const obj = { n:name, a:allergens };
      if(item.last_analysis_id != null) obj.last_analysis_id = item.last_analysis_id;
      if(item.last_analysis_timestamp != null) obj.last_analysis_timestamp = item.last_analysis_timestamp;
      map.set(key, obj);
    }
  });
  return [...map.values()].sort((a,b)=>a.n.localeCompare(b.n,'es'));
}

// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ
let DB_SOURCE = 'DB_SOURCE_UNKNOWN';
let P;
try {
  const s = localStorage.getItem('alergenos_db_v3');
  if(s) {
    P = sanitizeProductList(JSON.parse(s));
    DB_SOURCE = 'DB_SOURCE_LOCALSTORAGE';
  } else {
    // Solo usamos INITIAL si no hay base local persistida
    P = sanitizeProductList(JSON.parse(JSON.stringify(INITIAL)));
    DB_SOURCE = 'DB_SOURCE_INITIAL';
  }
} catch(e) {
  P = sanitizeProductList(JSON.parse(JSON.stringify(INITIAL)));
  DB_SOURCE = 'DB_SOURCE_INITIAL_FALLBACK';
}
// Log del origen al arrancar (se ejecuta despu√©s de que addLog est√© disponible)
setTimeout(() => {
  addLog('APP_STARTED', {
    db_source: DB_SOURCE,
    product_count: P ? P.length : 0,
    local_last_update: localStorage.getItem('local_last_update') || null
  });
}, 0);
let photoQueue=[];try{const s=localStorage.getItem('alergenos_queue');if(s)photoQueue=JSON.parse(s)}catch(e){}
let queuePendingReview=[];
let isProcessing=false;
function saveQueue(){try{localStorage.setItem('alergenos_queue',JSON.stringify(photoQueue))}catch(e){}}
// (Sistema de logs unificado definido m√°s arriba)

// ============================================================
// SINCRONIZACI√ìN (sesiones registradas en registro de diagn√≥stico)
// ============================================================
function createSyncSession(trigger) {
  const localCount = P ? P.length : 0;
  const localLastUpdate = localStorage.getItem('local_last_update') || null;
  const session = {
    sync_session_id: 'sync_' + Date.now() + '_' + Math.random().toString(36).substr(2,4),
    started_at: new Date().toISOString(),
    finished_at: null,
    trigger,
    local_count_before: localCount,
    remote_count_before: null,
    local_last_update_before: localLastUpdate,
    remote_last_update_before: null,
    decision: null,
    local_count_after: null,
    remote_count_after: null,
    uploaded_count: 0,
    downloaded_count: 0,
    status: 'running',
    summary_message: '',
    error_detail: null
  };
  return session;
}

function finishSyncSession(session, decision, status, summary, errorDetail = null) {
  session.finished_at = new Date().toISOString();
  session.decision = decision;
  session.status = status;
  session.summary_message = summary;
  session.local_count_after = P ? P.length : 0;
  session.error_detail = errorDetail;
  if(decision === 'upload') session.uploaded_count = session.local_count_before;
  if(decision === 'download') session.downloaded_count = session.remote_count_before;
  const decLabel = { upload:'Subido', download:'Descargado', none:'Sin cambios', error:'Error' }[decision] || decision;
  addLog('INFO', 'SYNC_FINISHED', `${decLabel}: ${summary}`, {
    sync_session_id: session.sync_session_id,
    trigger: session.trigger,
    decision,
    status,
    local_count_before: session.local_count_before,
    local_count_after: session.local_count_after,
    remote_count_before: session.remote_count_before,
    remote_count_after: session.remote_count_after,
    summary_message: summary,
    error_detail: errorDetail
  });
  updateSyncStatusUI();
}

// Estado de sync visible en Ajustes
let lastSyncDecision = localStorage.getItem('last_sync_decision') || null;
let pendingChanges = localStorage.getItem('pending_changes') === '1';

function updateSyncStatusUI() {
  const el = document.getElementById('syncStatusPanel');
  if(!el) return;
  const localCount = P ? P.length : 0;
  const localTs = localStorage.getItem('local_last_update');
  const remoteCount = localStorage.getItem('remote_last_count') || '‚Äî';
  const remoteTs = localStorage.getItem('remote_last_update_read') || null;
  const decision = localStorage.getItem('last_sync_decision') || '‚Äî';
  const pending = pendingChanges ? '<span style="color:var(--red)">‚ö† Cambios pendientes</span>' : '<span style="color:green">‚úì Sincronizado</span>';

  el.innerHTML = `
    <div class="sync-status-grid">
      <div><b>Productos locales:</b> ${localCount}</div>
      <div><b>√öltima actualizaci√≥n local:</b> ${localTs ? new Date(parseInt(localTs)).toLocaleString('es-ES') : '‚Äî'}</div>
      <div><b>Productos remotos (√∫ltima lectura):</b> ${remoteCount}</div>
      <div><b>√öltima actualizaci√≥n remota:</b> ${remoteTs ? new Date(parseInt(remoteTs)).toLocaleString('es-ES') : '‚Äî'}</div>
      <div><b>√öltima decisi√≥n de sync:</b> ${decision}</div>
      <div><b>Estado:</b> ${pending}</div>
    </div>
  `;
}

// ============================================================
// GUARDAR BASE DE DATOS (con opci√≥n skipAutoSync)
// ============================================================
function saveDB(options = {}) {
  if(!Array.isArray(P)) return;
  const skipAutoSync = options.skipAutoSync === true;
  try {
    P = sanitizeProductList(P);
    const json = JSON.stringify(P);
    if(json.length > 4.5 * 1024 * 1024){
      addLog(LOG_LEVELS.WARN,'DB_SAVE_ERROR','Base de datos muy grande (cerca del l√≠mite)',{bytes:json.length});
    }
    localStorage.setItem('alergenos_db_v3', json);
    localStorage.setItem('local_last_update', Date.now().toString());
    if (!skipAutoSync) {
      pendingChanges = true;
      localStorage.setItem('pending_changes','1');
      if(gdriveToken && navigator.onLine) setTimeout(() => gdriveSmartSync('auto'), 500);
    }
    updateAppStatus();
    updateSyncStatusUI();
  } catch(e) {
    if(e && e.name === 'QuotaExceededError'){
      addLog(LOG_LEVELS.ERROR,'DB_SAVE_ERROR','Sin espacio en almacenamiento local',{error:e.message});
      if(typeof showToast==='function') showToast('Sin espacio: borra datos antiguos o exporta','info');
    }else{
      addLog(LOG_LEVELS.ERROR,'DB_SAVE_ERROR',e.message||'Error al guardar',{error:String(e)});
    }
  }
}
const save = saveDB;

// ============================================================
// SISTEMA DE REVISI√ìN DE INCOHERENCIAS
// ============================================================

// Reglas de palabras clave ‚Üí al√©rgenos esperados
const KEYWORD_RULES = {
  'PESCADO': ['atun','salmon','merluza','bacalao','boqueron','sardina','sardinilla','caballa','melva','bonito','lubina','dorada','anchoa','pez espada','trucha','rodaballo','lenguado','rape','corvina','cabracho','rosada','cazon','bu√±uelo de bacalao','croquetas de merluza','empanada de atun','pizza tonno','wrap de salmon','salpicon','perca'],
  'CRUST√ÅCEOS': ['gamba','gambon','langostino','camaron','carabinero','cigala','bogavante','necora','buey de mar','brocheta de gambas','colas de langostinos','gambas peladas','gambones','croquetas de gambas','piruleta de langostinos'],
  'MOLUSCO': ['mejillon','almeja','calamar','pulpo','sepia','navaja','berberecho','chipiron','choco','pota','jibia','mejillon tigre','pipa de mejillon'],
  'L√ÅCTEO': ['queso','mantequilla','nata','leche','yogur','kefir','bechamel'],
  'HUEVO': ['huevo','mayonesa','tortilla','rebozad','empanado','flan'],
  'CEREALES': ['pan','pasta','harina','galleta','bizcocho','croissant'],
  'FRUTOS SECOS': ['nuez','nueces','almendra','pistacho','avellana','pi√±on','pi√±ones','anacardo','castana','pacana'],
  'SOJA': ['tofu','edamame','miso'],
  'S√âSAMO': ['tahini','tahina'],
};

// Persistencia de flags y excepciones
let auditFlags = {};   // { productIdx (por nombre normalizado): {severity:'high'|'medium', reasons:[...], type:'extra'|'missing'} }
let auditExceptions = {}; // { productSignature: true }

try {
  const af = localStorage.getItem('alerg_audit_flags');
  if(af) auditFlags = JSON.parse(af);
} catch(e){}
try {
  const ae = localStorage.getItem('alerg_audit_exceptions');
  if(ae) auditExceptions = JSON.parse(ae);
} catch(e){}

function saveAuditFlags(){ try{localStorage.setItem('alerg_audit_flags', JSON.stringify(auditFlags))}catch(e){} }
function saveAuditExceptions(){ try{localStorage.setItem('alerg_audit_exceptions', JSON.stringify(auditExceptions))}catch(e){} }

// Eventos de revisi√≥n/auditor√≠a van al registro de diagn√≥stico (addLog)
const AUDIT_EVENT_LABELS = { run_started:'Inicio revisi√≥n', run_finished:'Fin revisi√≥n', run_error:'Error revisi√≥n', dismissed:'No mostrar m√°s', saved_review:'Registro guardado', merge_save:'Fusi√≥n de registro', new_product:'Alta manual', import_excel:'Importaci√≥n Excel' };
function logAuditEvent(event, payload={}){
  const msg = AUDIT_EVENT_LABELS[event] || event;
  addLog('INFO', 'AUDIT_'+event, msg, payload);
}

function productSignature(p){ return norm(p.n) + '|' + p.a.slice().sort().join(','); }

function getFlag(p){
  const key = norm(p.n);
  const flag = auditFlags[key];
  if(!flag) return null;
  // Check exception
  if(auditExceptions[productSignature(p)]) return null;
  return flag;
}

function dismissFlag(p){
  const flag = getFlag(p);
  auditExceptions[productSignature(p)] = true;
  saveAuditExceptions();
  logAuditEvent('dismissed', { product: p.n, allergens: p.a, reasons: flag?.reasons || [] });
}

function clearFlagOnSave(pName, beforeProduct=null, afterProduct=null){
  const key = norm(pName);
  const oldFlag = auditFlags[key] || (beforeProduct ? getFlag(beforeProduct) : null);
  if(auditFlags[key]){
    delete auditFlags[key];
    saveAuditFlags();
  }
  if(beforeProduct || afterProduct){
    logAuditEvent('saved_review', {
      product_before: beforeProduct ? beforeProduct.n : null,
      product_after: afterProduct ? afterProduct.n : pName,
      allergens_before: beforeProduct ? beforeProduct.a : null,
      allergens_after: afterProduct ? afterProduct.a : null,
      changed: !!(beforeProduct && afterProduct && (beforeProduct.n!==afterProduct.n || JSON.stringify(beforeProduct.a)!==JSON.stringify(afterProduct.a))),
      reasons: oldFlag?.reasons || []
    });
  }
}

// Layer 1: keyword rules (local, free, instant)
function runKeywordAudit(){
  const issues = [];
  P.forEach((p, idx) => {
    if(auditExceptions[productSignature(p)]) return;
    const pnorm = norm(p.n);
    const pAllergens = new Set(p.a);
    const reasons = [];

    Object.entries(KEYWORD_RULES).forEach(([allergen, keywords]) => {
      const matches = keywords.filter(kw => pnorm.includes(norm(kw)));
      if(matches.length > 0 && !pAllergens.has(allergen)){
        reasons.push({ type:'missing', allergen, trigger: matches[0] });
      }
    });

    if(reasons.length > 0){
      issues.push({ idx, product: p, reasons, severity: 'high' });
    }
  });
  return issues;
}

// Layer 2: AI semantic analysis (1 single call for ALL ambiguous products)
async function runAIAudit(apiKey, productsForAI){
  if(!productsForAI.length) return [];

  // Build a compact list: index|name|allergens
  const lines = productsForAI.map(({idx,product}) =>
    `${idx}|${product.n}|${product.a.join(',')}`
  ).join('\n');

  const prompt = `Eres un experto en al√©rgenos alimentarios seg√∫n el Reglamento UE 1169/2011. 
Analiza esta lista de productos de un hotel. Para cada uno, detecta posibles incoherencias:
- Al√©rgeno que probablemente FALTA (el nombre sugiere fuertemente ese ingrediente pero no est√° marcado)
- Al√©rgeno que probablemente est√° DE M√ÅS (parece improbable para ese producto)

Formato de entrada: √≠ndice|nombre|al√©rgenos_actuales
Lista de al√©rgenos posibles: ALTRAMUZ, APIO, CACAHUETES, CEREALES, CRUST√ÅCEOS, FRUTOS SECOS, HUEVO, L√ÅCTEO, MOLUSCO, MOSTAZA, PESCADO, S√âSAMO, SOJA, SULFITOS

IMPORTANTE: Solo reporta casos con alta confianza. Ignora platos muy elaborados con muchos ingredientes posibles. No infieras SULFITOS solo por palabras como 'conserva', 'lata', 'encurtido' o 'ahumado' salvo evidencia muy clara en el nombre.

Responde √öNICAMENTE con JSON array, sin texto extra:
[{"idx":n√∫mero,"type":"missing|extra","allergen":"NOMBRE","reason":"explicaci√≥n breve","confidence":"high|medium"}]

Si no detectas nada, responde: []

Productos a analizar:
${lines}`;

  const response = await fetchWithDiagnostics(GEMINI_GENERATE_URL, {
    method: 'POST',
    headers: buildGeminiHeaders(apiKey),
    body: JSON.stringify({
      contents: [{ role: 'user', parts: [{ text: prompt }] }],
      generationConfig: { maxOutputTokens: 2000, temperature: 0 }
    })
  }, {
    service:'Gemini',
    operation:'revision de incoherencias',
    requestTag:'runAIAudit',
    requireOnline:true
  });

  if(!response.ok){
    const errPayload=await parseHttpErrorPayload(response);
    const errMsg=extractProviderErrorMessage(errPayload) || `Gemini error: ${response.status}`;
    throw new Error(errMsg);
  }
  const data = await response.json();
  const text = (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0])
    ? (data.candidates[0].content.parts[0].text || '').trim()
    : '[]';
  
  try {
    const cleaned = text.replace(/```json|```/g,'').trim();
    return JSON.parse(cleaned);
  } catch(e) {
    return [];
  }
}

async function runAuditReview(){
  const apiKey = getApiKey();
  const auditSessionId = 'aud_'+Date.now()+'_'+Math.random().toString(36).slice(2,5);
  if(!apiKey){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Revision IA sin clave API configurada',{service:'Gemini',operation:'runAuditReview'});
    showToast('Configura la clave API en Ajustes (‚öô)','info');
    return;
  }

  // Show loading overlay
  const overlay = document.createElement('div');
  overlay.className = 'audit-running-overlay';
  overlay.innerHTML = `<div class="audit-running-box">
    <div class="audit-spinner"></div>
    <p>Analizando base de datos‚Ä¶</p>
    <p style="font-size:12px;color:var(--text2);margin-top:6px">Esto puede tardar unos segundos</p>
  </div>`;
  document.body.appendChild(overlay);

  try {
    // Reset previous flags (but keep exceptions)
    auditFlags = {};

    logAuditEvent('run_started', { audit_session_id:auditSessionId, total_products:P.length });
    // Layer 1: keywords (instant)
    const kwIssues = runKeywordAudit();
    const kwKeys = new Set(kwIssues.map(i => norm(i.product.n)));

    // Layer 2: AI gets products NOT caught by keywords (sample of 120 max to control cost)
    const productsForAI = P
      .map((p,idx) => ({idx,product:p}))
      .filter(({product}) => !kwKeys.has(norm(product.n)) && !auditExceptions[productSignature(product)])
      .slice(0, 120);

    overlay.querySelector('p').textContent = 'Consultando IA‚Ä¶';
    const aiResults = await runAIAudit(apiKey, productsForAI);
    addLog('AUDIT_AI_RESULTS',{audit_session_id:auditSessionId, analyzed:productsForAI.length, returned:Array.isArray(aiResults)?aiResults.length:0});

    // Build flags from keyword issues
    kwIssues.forEach(({product, reasons, severity}) => {
      const key = norm(product.n);
      auditFlags[key] = {
        severity,
        reasons: reasons.map(r => `${r.type === 'missing' ? 'Falta' : 'Sobra'} ${r.allergen} (detectado: "${r.trigger}")`)
      };
    });

    // Build flags from AI results
    aiResults.forEach(r => {
      if(!r.idx && r.idx !== 0) return;
      const product = P[r.idx];
      if(!product) return;
      const key = norm(product.n);
      if(!auditFlags[key]){
        auditFlags[key] = {
          severity: r.confidence === 'high' ? 'high' : 'medium',
          reasons: []
        };
      }
      auditFlags[key].reasons.push(`${r.type === 'missing' ? 'Falta' : 'Sobra'} ${r.allergen}: ${r.reason}`);
    });

    saveAuditFlags();

    const total = Object.keys(auditFlags).length;
    logAuditEvent('run_finished',{audit_session_id:auditSessionId, total_flagged:total, keyword_hits:kwIssues.length, ai_checked:productsForAI.length, ai_hits:(aiResults||[]).length});
    
    // Update last run info
    const lastRunEl = document.getElementById('auditLastRun');
    if(lastRunEl){
      lastRunEl.style.display = 'block';
      lastRunEl.textContent = `√öltima revisi√≥n: ${new Date().toLocaleString('es-ES')} ¬∑ ${total} posible${total!==1?'s':''} incoherencia${total!==1?'s':''}`;
    }

    document.body.removeChild(overlay);
    closeSettings();
    
    // Go to product list and re-render
    render();
    ls.scrollTop = 0;

    if(total > 0){
      showToast(`üîç ${total} producto${total!==1?'s':''} para revisar`, 'info');
    } else {
      showToast('‚úì Sin incoherencias detectadas', 'update');
    }

  } catch(err) {
    document.body.removeChild(overlay);
    logAuditEvent('run_error',{audit_session_id:auditSessionId, error: err.message||'Error desconocido' });
    showToast('Error en la revisi√≥n: ' + (err.message||'Error desconocido'), 'error');
  }
}

// Wire up the audit button
document.getElementById('auditRunBtn').addEventListener('click', runAuditReview);

// Update last run text when settings opens
const origGearClick = document.getElementById('gearBtn').onclick;
document.getElementById('gearBtn').addEventListener('click', () => {
  const lastRunEl = document.getElementById('auditLastRun');
  if(lastRunEl){
    const total = Object.keys(auditFlags).length;
    if(total > 0){
      lastRunEl.style.display = 'block';
      lastRunEl.textContent = `${total} producto${total!==1?'s':''} pendiente${total!==1?'s':''} de revisi√≥n`;
    } else {
      lastRunEl.style.display = 'none';
    }
  }
});

// ============================================================
let af=new Set(),sinMode=false,lastSavedName=null;
const q=document.getElementById('q'),xb=document.getElementById('xb'),ls=document.getElementById('ls'),cnt=document.getElementById('cnt'),fl=document.getElementById('fl');

function norm(s){return s.normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').toLowerCase().replace(/[^a-z0-9 ]/g,'').replace(/\s+/g,' ').trim()}
function tokenize(s){return norm(s).split(' ').filter(w=>w.length>2)}
const PHOTO_KEYWORD_RULES=[
  {rx:[/crust/i,/gamb/i,/langost/i,/bogavant/i,/cigala/i,/marisc/i], allergen:'CRUST√ÅCEOS', level:'high'},
  {rx:[/lech/i,/lacte/i,/suero/i,/casein/i,/mantequill/i], allergen:'L√ÅCTEO', level:'high'},
  {rx:[/trig/i,/gluten/i,/cebad/i,/avena/i,/centen/i], allergen:'CEREALES', level:'high'},
  {rx:[/huev/i,/clara/i,/yema/i,/ovoalb/i], allergen:'HUEVO', level:'high'},
  {rx:[/almendr/i,/nuez/i,/avellan/i,/pistach/i,/anacard/i,/frutos?\s+secos?/i,/frutos?\s+de\s+cascara/i], allergen:'FRUTOS SECOS', level:'high'},
  {rx:[/sesam/i,/tahini/i,/tahina/i], allergen:'S√âSAMO', level:'high'},
  {rx:[/soja/i,/edamame/i,/miso/i,/tofu/i], allergen:'SOJA', level:'high'},
  {rx:[/mostaz/i], allergen:'MOSTAZA', level:'high'},
  {rx:[/sulfit/i,/anhidrido\s+sulfuroso/i,/e22[0-8]/i], allergen:'SULFITOS', level:'high'},
  {rx:[/apio/i], allergen:'APIO', level:'high'},
  {rx:[/cacahuet/i,/mani/i], allergen:'CACAHUETES', level:'high'},
  {rx:[/pescad/i,/atun/i,/salmon/i,/bacalao/i,/merluza/i], allergen:'PESCADO', level:'high'},
  {rx:[/calamar/i,/pulpo/i,/mejillon/i,/almeja/i,/molusc/i], allergen:'MOLUSCO', level:'high'},
  {rx:[/altramu/i,/lupino/i], allergen:'ALTRAMUZ', level:'high'},
  {rx:[/e322/i], allergen:'SOJA', level:'info'}
];

function normalizeAllergen(s){
  const t=String(s||'').trim();
  if(!t) return '';
  if(AL.includes(t)) return t;
  const n=norm(t);
  const found=AL.find(a=>norm(a)===n);
  return found||'';
}

function normalizeAIPhotoResult(obj){
  const out={...obj};
  out.nombre=(out.nombre||'').toString().trim();
  out.hallazgos_texto=Array.isArray(out.hallazgos_texto)?out.hallazgos_texto.map(x=>String(x||'').trim()).filter(Boolean):[];
  out.mapeo=Array.isArray(out.mapeo)?out.mapeo.map(m=>({texto:String((m&&m.texto)||'').trim(),alergeno:normalizeAllergen((m&&m.alergeno)||'')})).filter(m=>m.texto||m.alergeno):[];
  out.alergenos=[...new Set((Array.isArray(out.alergenos)?out.alergenos:[]).map(normalizeAllergen).filter(Boolean))];
  out.trazas=[...new Set((Array.isArray(out.trazas)?out.trazas:[]).map(normalizeAllergen).filter(Boolean))];
  out.notas=String(out.notas||'').trim();
  out.warning=String(out.warning||'').trim();
  return out;
}
function extractJsonFromAIResponse(rawText){
  let s=String(rawText||'').trim();
  s=s.replace(/^\s*```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/,'').trim();
  // Quitar frases t√≠picas de Gemini/IA antes del JSON (solo al inicio)
  const intro=/^(?:Aqu√≠ tienes el (?:JSON|resultado)[.:]?|Here is the (?:JSON|result)[.:]?|Aqu√≠ est√°[.:]?|El JSON es[.:]?)\s*/i;
  s=s.replace(intro,'').trim();
  s=s.replace(/,(\s*[}\]])/g,'$1');
  try{
    return JSON.parse(s);
  }catch(e1){
    const start=s.indexOf('{');
    if(start===-1)throw e1;
    let end=s.lastIndexOf('}');
    if(end<=start)throw e1;
    let chunk=s.substring(start,end+1);
    chunk=chunk.replace(/,(\s*[}\]])/g,'$1');
    try{
      return JSON.parse(chunk);
    }catch(e2){
      throw e1;
    }
  }
}
function parseAndValidateAI(rawText,source='photo'){
  const rawTruncated=String(rawText||'').slice(0,3000);
  addLog('INFO','PHOTO_RAW_RESPONSE','PHOTO_RAW_RESPONSE',{source,rawText:rawTruncated});
  let parsed;
  try{
    parsed=extractJsonFromAIResponse(rawText);
  }catch(e){
    addLog('WARN','PHOTO_PARSE_ERROR','PHOTO_PARSE_ERROR',{source,error:e.message});
    throw e;
  }
  const result=normalizeAIPhotoResult(parsed);
  addLog('INFO','PHOTO_PARSED_RESULT','PHOTO_PARSED_RESULT',{source,parsed:{nombre:result.nombre,hallazgos_texto:result.hallazgos_texto,mapeo:result.mapeo,alergenos:result.alergenos,trazas:result.trazas,warning:result.warning||''}});
  const alergSet=new Set([...(result.alergenos||[]),...(result.trazas||[])].map(normalizeAllergen));
  const mapeoDiff=[];
  result.hallazgos_texto.forEach(txt=>{
    const key=norm(txt);
    const exact=result.mapeo.filter(m=>norm(m.texto)===key).map(m=>m.alergeno).filter(Boolean);
    const byContains=result.mapeo.filter(m=>key.includes(norm(m.texto))||norm(m.texto).includes(key)).map(m=>m.alergeno).filter(Boolean);
    const mapped=[...new Set([...exact,...byContains])].filter(a=>OFFICIAL_ALLERGENS.includes(a));
    if(!mapped.length){mapeoDiff.push({texto:txt,motivo:'sin_mapeo'});return;}
    const miss=mapped.filter(a=>!alergSet.has(a));
    if(miss.length)mapeoDiff.push({texto:txt,mapeado:mapped,faltan_en_resultado:miss});
  });
  if(mapeoDiff.length) addLog('WARN','PHOTO_MAPEO_DIFF','PHOTO_MAPEO_DIFF',{source,diff:mapeoDiff});
  const textForCheck=(result.hallazgos_texto.join(' ')||String(rawText||''));
  const keywordAlerts=[];
  PHOTO_KEYWORD_RULES.forEach(rule=>{
    const hit=rule.rx.find(rx=>rx.test(textForCheck));
    if(hit && !alergSet.has(rule.allergen)) keywordAlerts.push({allergen:rule.allergen,level:rule.level,pattern:hit.toString()});
  });
  if(keywordAlerts.length) addLog('WARN','PHOTO_KEYWORD_ALERT','PHOTO_KEYWORD_ALERT',{source,alerts:keywordAlerts});
  result.review_alerts={mapeo:mapeoDiff,keywords:keywordAlerts};
  result.requires_review=!!(mapeoDiff.length || keywordAlerts.some(a=>a.level==='high'));
  return result;
}
function isAutoOk(result){
  if(!result)return false;
  if(result.requires_review)return false;
  if(String(result.warning||'').trim())return false;
  return true;
}
function buildReviewReason(result){
  const parts=[];
  if(result.warning)parts.push(result.warning);
  const ra=result.review_alerts||{};
  if(ra.keywords&&ra.keywords.length){
    ra.keywords.filter(k=>k.level==='high').forEach(k=>{
      parts.push(`Detectado texto relacionado con "${k.allergen}" pero no est√° marcado.`);
    });
  }
  if(ra.mapeo&&ra.mapeo.length){
    ra.mapeo.forEach(m=>{
      if(m.faltan_en_resultado&&m.faltan_en_resultado.length)
        parts.push(`"${m.texto}" deber√≠a incluir: ${m.faltan_en_resultado.join(', ')}`);
      else if(m.motivo==='sin_mapeo')
        parts.push(`Texto "${m.texto}" sin al√©rgeno asignado.`);
    });
  }
  return parts.length?parts.join(' '):'Revisi√≥n recomendada.';
}
function sortAllergens(arr){const uniq=[...new Set(arr)];return uniq.sort((a,b)=>AL.indexOf(a)-AL.indexOf(b) || a.localeCompare(b,'es'))}
function similarity(a,b){const na=norm(a),nb=norm(b);if(na===nb)return 1;const ta=tokenize(a),tb=tokenize(b);if(!ta.length||!tb.length)return 0;if(Math.abs(ta.length-tb.length)>3)return 0;const sa=new Set(ta),sb=new Set(tb);const inter=new Set([...sa].filter(x=>sb.has(x)));const union=new Set([...sa,...sb]);const jaccard=inter.size/union.size;let sub=0;const smaller=Math.min(sa.size,sb.size);if(smaller>=2){const ss=sa.size<=sb.size?sa:sb;const bs=sa.size<=sb.size?sb:sa;if([...ss].every(t=>bs.has(t)))sub=smaller/Math.max(sa.size,sb.size)}return Math.max(jaccard,sub)}
function findMatch(name,excludeIdx){let best=null,bs=0;for(let i=0;i<P.length;i++){if(i===excludeIdx)continue;const s=similarity(name,P[i].n);if(s>bs){bs=s;best={index:i,product:P[i],score:s}}}return(best&&bs>=0.70)?best:null}
function mergeProduct(idx,nn,na,opts){
  const ex=P[idx],os=new Set(ex.a);
  const m=sortAllergens([...new Set([...ex.a,...na])]);
  const added=m.filter(a=>!os.has(a));
  if(nn.length>ex.n.length)ex.n=nn;
  ex.a=m;
  if(opts&&opts.analysisId!= null){ ex.last_analysis_id=opts.analysisId; ex.last_analysis_timestamp=opts.analysisTimestamp||new Date().toISOString(); }
  saveDB();return{added}
}

const toastEl=document.getElementById('toast');let toastTimer;
function showToast(msg,type){toastEl.textContent=msg;toastEl.className='toast show toast-'+type;clearTimeout(toastTimer);toastTimer=setTimeout(()=>toastEl.classList.remove('show'),3500)}

function getPendingReviewCount(){
  try{
    if(!Array.isArray(P)) return 0;
    let n=0;
    for(const p of P) if(getFlag(p)) n++;
    return n;
  }catch(_){ return 0; }
}
function updateCancelReviewUI(){
  const btn=document.getElementById('cancelReviewBtn');
  if(!btn) return;
  const pending=getPendingReviewCount();
  btn.style.display = pending>0 ? 'flex' : 'none';
}

(function(){let h='<button class="ftag-sin" id="sinBtn">‚úì SIN</button>';AL.forEach(a=>{h+=`<button class="ftag" data-f="${a}" title="${a}"><img src="${IC[a]}" alt="${a}"></button>`});h+='<button class="ftag-clear" id="clearFilters">‚úï</button>';fl.innerHTML=h;const sinBtn=document.getElementById('sinBtn'),clearBtn=document.getElementById('clearFilters');fl.querySelectorAll('.ftag[data-f]').forEach(b=>{b.addEventListener('click',()=>{const a=b.dataset.f;if(af.has(a)){af.delete(a);b.classList.remove('active')}else{af.add(a);b.classList.add('active')}uc();render()})});sinBtn.addEventListener('click',()=>{sinMode=!sinMode;sinBtn.classList.toggle('active',sinMode);render()});clearBtn.addEventListener('click',()=>{af.clear();sinMode=false;fl.querySelectorAll('.ftag,.ftag-sin').forEach(b=>b.classList.remove('active'));uc();render()});function uc(){clearBtn.classList.toggle('show',af.size>0||sinMode)}})();

let renderLimit=150;
let currentFiltered=[];

function render(){const raw=q.value.trim(),query=norm(raw);xb.classList.toggle('on',raw.length>0);let f=P;if(query){const t=query.split(/\s+/);f=f.filter(p=>{const n=norm(p.n);return t.every(w=>n.includes(w))})}if(sinMode&&af.size>0)f=f.filter(p=>![...af].some(a=>p.a.includes(a)));else if(sinMode&&af.size===0)f=f.filter(p=>!p.a.length);else if(!sinMode&&af.size>0)f=f.filter(p=>[...af].some(a=>p.a.includes(a)));currentFiltered=f;renderLimit=150;cnt.textContent=f.length+' producto'+(f.length!==1?'s':'');if(!f.length){ls.innerHTML='<div class="empty">Sin resultados</div>';return}renderProducts()}

function renderProducts(){
  const f=currentFiltered;
  
  // Separate flagged vs normal (only when no search/filter active)
  const isFiltering = q.value.trim() || af.size > 0 || sinMode;
  const flagged = !isFiltering ? f.filter(p => getFlag(p)) : [];
  const normal = !isFiltering ? f.filter(p => !getFlag(p)) : f;
  
  let h='';
  
  // Pending section
  if(flagged.length > 0){
    h+=`<div class="audit-section-header">‚ö† Pendientes de revisi√≥n <span>${flagged.length}</span></div>`;
    flagged.forEach(p=>{
      const oi=P.indexOf(p);
      const flag=getFlag(p);
      const severity=flag?flag.severity:'medium';
      let nm=esc(p.n);
      let ic='';
      if(!p.a.length)ic='<span class="safe">‚úì Sin al√©rgenos</span>';
      else{ic='<div class="icons-row">';p.a.forEach(a=>{if(IC[a])ic+=`<img class="a-icon" src="${IC[a]}" alt="${a}" title="${a}">`});ic+='</div>'}
      const count=p.a.length?`<div class="a-count">${p.a.length} al√©rgeno${p.a.length>1?'s':''}</div>`:'';
      const badge=`<span class="audit-badge ${severity}">${severity==='high'?'Alta':'Media'}</span>`;
      const reviewBadge=p.requires_review?'<span class="audit-badge medium">Revisar IA</span>':'';
      h+=`<div class="card audit-${severity}" data-idx="${oi}"><div class="card-name">${nm}${badge}${reviewBadge}</div>${ic}${count}</div>`;
    });
    h+='<hr class="audit-separator">';
  }

  // Normal section
  const show=normal.slice(0,renderLimit);
  show.forEach(p=>{const oi=P.indexOf(p);let nm=esc(p.n);const query=norm(q.value.trim());if(query)nm=hi(nm,query);let ic='';if(!p.a.length)ic='<span class="safe">‚úì Sin al√©rgenos</span>';else{ic='<div class="icons-row">';p.a.forEach(a=>{if(IC[a])ic+=`<img class="a-icon" src="${IC[a]}" alt="${a}" title="${a}">`});ic+='</div>'}const isHL=lastSavedName&&norm(p.n)===norm(lastSavedName);const count=p.a.length?`<div class="a-count">${p.a.length} al√©rgeno${p.a.length>1?'s':''}</div>`:'';const reviewBadge=p.requires_review?'<span class="audit-badge medium">Revisar IA</span>':'';h+=`<div class="card${isHL?' highlight':''}" data-idx="${oi}"><div class="card-name">${nm}${reviewBadge}</div>${ic}${count}</div>`});
  if(normal.length>renderLimit)h+=`<div class="empty" id="loadMore">Mostrando ${renderLimit} de ${normal.length} ‚Äî Baja para cargar m√°s</div>`;
  ls.innerHTML=h;
  updateCancelReviewUI();
  if(lastSavedName){const el=ls.querySelector('.card.highlight');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});setTimeout(()=>el.classList.remove('highlight'),2500)}lastSavedName=null}else if(renderLimit===150)ls.scrollTop=0;
  ls.querySelectorAll('.card[data-idx]').forEach(c=>c.addEventListener('click',()=>openEdit(parseInt(c.dataset.idx))))
}

// Pull-to-refresh
let ptrStart=0,ptrDist=0,ptrActive=false;
const ptrIndicator=document.getElementById('ptrIndicator');
ls.addEventListener('touchstart',e=>{if(ls.scrollTop===0)ptrStart=e.touches[0].clientY});
ls.addEventListener('touchmove',e=>{
  if(ptrStart&&ls.scrollTop===0){
    ptrDist=e.touches[0].clientY-ptrStart;
    if(ptrDist>0){
      e.preventDefault();
      ptrIndicator.classList.toggle('active',ptrDist>60);
      ptrActive=ptrDist>60;
    }
  }
});
ls.addEventListener('touchend',async()=>{
  if(ptrActive&&gdriveToken){
    showToast('‚ü≥ Sincronizando...','info');
    try{
      await gdriveSmartSync('manual');
    }catch(e){showToast('Error al sincronizar','info')}
  }
  ptrStart=0;ptrDist=0;ptrActive=false;
  ptrIndicator.classList.remove('active');
});

// Scroll infinito
ls.addEventListener('scroll',()=>{
  if(currentFiltered.length<=renderLimit)return;
  const scrollBottom=ls.scrollHeight-ls.scrollTop-ls.clientHeight;
  if(scrollBottom<200){
    renderLimit=Math.min(renderLimit+150,currentFiltered.length);
    renderProducts();
  }
});
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;')}
function hi(original,query){
  const terms=query.split(/\s+/).filter(w=>w);
  if(!terms.length)return esc(original);
  
  const normalized=norm(original);
  const ranges=[];
  
  // Encontrar todas las posiciones en el string normalizado
  terms.forEach(term=>{
    let pos=0;
    while((pos=normalized.indexOf(term,pos))!==-1){
      ranges.push({start:pos,end:pos+term.length});
      pos+=term.length;
    }
  });
  
  if(!ranges.length)return esc(original);
  
  // Fusionar rangos superpuestos y ordenar
  ranges.sort((a,b)=>a.start-b.start);
  const merged=[];
  let current=ranges[0];
  for(let i=1;i<ranges.length;i++){
    if(ranges[i].start<=current.end){
      current.end=Math.max(current.end,ranges[i].end);
    }else{
      merged.push(current);
      current=ranges[i];
    }
  }
  merged.push(current);
  
  // Mapear posiciones del normalizado al original
  // Esto es necesario porque la normalizaci√≥n puede cambiar longitudes (tildes, etc)
  const posMap=[];
  let origPos=0,normPos=0;
  while(origPos<original.length){
    const origChar=original[origPos];
    const normChar=norm(origChar);
    posMap[normPos]=origPos;
    origPos++;
    normPos+=normChar.length;
  }
  posMap[normPos]=origPos; // fin del string
  
  // Construir resultado con marks insertados
  let result='';
  let lastEnd=0;
  merged.forEach(range=>{
    const realStart=posMap[range.start]||0;
    const realEnd=posMap[range.end]||original.length;
    
    result+=esc(original.slice(lastEnd,realStart));
    result+='<mark>';
    result+=esc(original.slice(realStart,realEnd));
    result+='</mark>';
    lastEnd=realEnd;
  });
  result+=esc(original.slice(lastEnd));
  
  return result;
}
let dt;q.addEventListener('input',()=>{clearTimeout(dt);dt=setTimeout(render,100)});xb.addEventListener('click',()=>{q.value='';q.focus();render()});

let analysisAborted=false;
const modalBg=document.getElementById('modalBg');let editMode=false,editIdx=-1;
document.getElementById('addBtn').addEventListener('click',()=>{editMode=false;editIdx=-1;openModal()});
document.getElementById('cancelReviewBtn').addEventListener('click',()=>{
  auditFlags = {};
  saveAuditFlags();
  render();
  showToast('Revisi√≥n cancelada','info');
});
document.getElementById('modalClose').addEventListener('click',closeModal);
modalBg.addEventListener('click',e=>{if(e.target===modalBg)closeModal()});
function closeModal(){
  analysisAborted=true;
  autoMode=false;
  if(typeof getNavStack==='function'&&getNavStack().length>1) navBack();
  else {
    modalBg.classList.remove('open');
    settingsBg.classList.remove('open');
    if(typeof photoWarningBg!=='undefined') photoWarningBg.classList.remove('open');
    if(typeof errorModalBg!=='undefined') errorModalBg.classList.remove('open');
    if(typeof batchSummaryBg!=='undefined') batchSummaryBg.classList.remove('open');
    if(typeof batchReviewModalBg!=='undefined') batchReviewModalBg.classList.remove('open');
    if(typeof confirmBg!=='undefined') confirmBg.classList.remove('open');
    if(typeof window.clearBatchPhotos==='function') window.clearBatchPhotos();
  }
  console.log('[CLOSE] Modal cerrado - an√°lisis abortado');
}
function openModal(){
  navPush('add');
  modalBg.classList.add('open');
  document.getElementById('modalTitle').innerHTML=(editMode?'Editar producto':'A√±adir producto')+' <button class="modal-close" id="mc2">&times;</button>';document.getElementById('mc2').addEventListener('click',closeModal);document.getElementById('methodsRow').style.display=editMode?'none':'grid';document.getElementById('editBtns').style.display=editMode?'flex':'none';document.getElementById('secManual').classList.add('show');document.getElementById('secCamera').classList.remove('show');document.querySelectorAll('.method-btn').forEach(b=>b.classList.toggle('active',b.dataset.method==='manual'));resetCameraUI();
  // Audit flag UI
  const dismissRow=document.getElementById('auditDismissRow');
  const dismissBtn=document.getElementById('auditDismissBtn');
  if(editMode&&editIdx>=0){
    const p=P[editIdx];
    document.getElementById('manualName').value=p.n;setSelected('manualAllergens',p.a);hideMatch('manualMatch');manualCurrentMatch=null;document.getElementById('manualSave').textContent='Guardar cambios';document.getElementById('manualSave').disabled=false;
    const flag=getFlag(p);
    if(flag){
      const reasons=flag.reasons||[];
      dismissRow.style.display='block';
      dismissBtn.title=reasons.join(' ¬∑ ');
      dismissBtn.onclick=()=>{dismissFlag(p);closeModal();render()};
      // Show reason as subtitle
      if(reasons.length>0){
        const existing=document.getElementById('auditFlagHint');
        if(existing)existing.remove();
        const hint=document.createElement('div');
        hint.id='auditFlagHint';
        hint.style.cssText='font-size:11px;color:#c53030;background:#fff5f5;border-radius:6px;padding:8px 10px;margin-bottom:10px;line-height:1.5';
        hint.textContent='‚ö† '+reasons.join(' ¬∑ ');
        document.getElementById('manualSave').insertAdjacentElement('beforebegin',hint);
      }
    } else {
      dismissRow.style.display='none';
      const existing=document.getElementById('auditFlagHint');
      if(existing)existing.remove();
    }
  }else{document.getElementById('manualName').value='';document.querySelectorAll('#manualAllergens .ag-item').forEach(i=>i.classList.remove('sel'));hideMatch('manualMatch');manualCurrentMatch=null;document.getElementById('manualSave').textContent='Guardar producto';document.getElementById('manualSave').disabled=true;dismissRow.style.display='none';const existing=document.getElementById('auditFlagHint');if(existing)existing.remove();}
}
function openEdit(idx){editMode=true;editIdx=idx;openModal()}
document.querySelectorAll('.method-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.method-btn').forEach(b=>b.classList.toggle('active',b===btn));document.getElementById('secManual').classList.toggle('show',btn.dataset.method==='manual');document.getElementById('secCamera').classList.toggle('show',btn.dataset.method==='camera')})});
function buildGrid(id){const c=document.getElementById(id);let h='';AL.forEach(a=>{h+=`<div class="ag-item" data-a="${a}" title="${a}"><img src="${IC[a]}" alt="${a}"></div>`});c.innerHTML=h;c.querySelectorAll('.ag-item').forEach(item=>item.addEventListener('click',()=>{item.classList.toggle('sel');updateSave(id)}))}
function getSelected(id){return[...document.getElementById(id).querySelectorAll('.ag-item.sel')].map(i=>i.dataset.a)}
function setSelected(id,arr){document.getElementById(id).querySelectorAll('.ag-item').forEach(i=>i.classList.toggle('sel',arr.includes(i.dataset.a)))}
function updateSave(gid){if(gid==='manualAllergens')document.getElementById('manualSave').disabled=!document.getElementById('manualName').value.trim();else document.getElementById('aiSave').disabled=!document.getElementById('aiName').value.trim()}
buildGrid('manualAllergens');buildGrid('aiAllergens');
function showMatch(boxId,match){document.getElementById(boxId+'Name').textContent=match.product.n;document.getElementById(boxId+'Detail').textContent=`Similitud: ${Math.round(match.score*100)}% ¬∑ ${match.product.a.length} al√©rgenos ¬∑ Se fusionar√°n`;document.getElementById(boxId).classList.add('show')}
function hideMatch(boxId){document.getElementById(boxId).classList.remove('show')}
let matchTimer,manualCurrentMatch=null;const manualNameInput=document.getElementById('manualName');
manualNameInput.addEventListener('input',()=>{updateSave('manualAllergens');clearTimeout(matchTimer);matchTimer=setTimeout(()=>{if(editMode)return;const name=manualNameInput.value.trim();if(name.length<3){hideMatch('manualMatch');manualCurrentMatch=null;document.getElementById('manualSave').textContent='Guardar producto';return}const match=findMatch(name);manualCurrentMatch=match;if(match){showMatch('manualMatch',match);document.getElementById('manualSave').textContent='Actualizar existente'}else{hideMatch('manualMatch');document.getElementById('manualSave').textContent='Guardar producto nuevo'}},300)});
manualNameInput.addEventListener('blur',()=>{const v=manualNameInput.value.trim();if(v){const c=autoCorrectName(v);if(c!==v){manualNameInput.value=c;showToast('Ortograf√≠a corregida','info')}}});

document.getElementById('manualSave').addEventListener('click',()=>{let name=manualNameInput.value.trim();if(!name)return;name=autoCorrectName(name);const al=sortAllergens(getSelected('manualAllergens'));if(editMode&&editIdx>=0){const before={n:P[editIdx].n,a:[...P[editIdx].a]};P[editIdx].n=name;P[editIdx].a=al;saveDB();clearFlagOnSave(name,before,{n:name,a:[...al]});lastSavedName=name;render();showToast(`‚úì "${name}" actualizado`,'update')}else if(manualCurrentMatch){const r=mergeProduct(manualCurrentMatch.index,name,al);logAuditEvent('merge_save',{target:manualCurrentMatch.product.n, merged_name:name, added_allergens:r.added});lastSavedName=manualCurrentMatch.product.n;render();showToast(r.added.length?`‚úì "${manualCurrentMatch.product.n}" ¬∑ +${r.added.length} al√©rgeno${r.added.length>1?'s':''}`:`‚úì "${manualCurrentMatch.product.n}" sin cambios`,'update')}else{addNewProduct(name,al);logAuditEvent('new_product',{product:name, allergens:al});lastSavedName=name;render();showToast(`‚úì "${name}" a√±adido`,'new')}closeModal();if(window.__batchReviewCorrecting){window.__batchReviewCorrecting=false;const p=window.__batchPendingReview||[];p.shift();if(p.length>0){if(typeof navPush==='function')navPush('batchReview');showNextBatchPending()}else closeModal();}});
function addNewProduct(name,al,opts){
  const nk=norm(name);
  let idx=P.findIndex(p=>norm(p.n)>nk);
  if(idx===-1)idx=P.length;
  const obj={n:name,a:sortAllergens(al)};
  if(opts&&opts.analysisId!=null){ obj.last_analysis_id=opts.analysisId; obj.last_analysis_timestamp=opts.analysisTimestamp||new Date().toISOString(); }
  P.splice(idx,0,obj);
  saveDB();updateAppStatus();
}
let deleteTarget=-1;const confirmBg=document.getElementById('confirmBg');
document.getElementById('deleteBtn').addEventListener('click',()=>{if(editIdx<0)return;deleteTarget=editIdx;document.getElementById('confirmText').textContent=`"${P[editIdx].n}" se eliminar√° permanentemente.`;navPush('confirm');confirmBg.classList.add('open')});
document.getElementById('confirmCancel').addEventListener('click',()=>{navBack()});
document.getElementById('confirmDelete').addEventListener('click',()=>{if(deleteTarget>=0){const n=P[deleteTarget].n;P.splice(deleteTarget,1);saveDB();render();showToast(`"${n}" eliminado`,'info')}navReplace(['main']);applyNavStack(['main'])});

// Warning modal
const photoWarningBg=document.getElementById('photoWarningBg');
document.getElementById('warningOk').addEventListener('click',()=>navBack());

// Error modal con miniatura
const errorModalBg=document.getElementById('errorModalBg');
const batchSummaryBg=document.getElementById('batchSummaryBg');

document.getElementById('errorModalOk').addEventListener('click',()=>navBack());
document.getElementById('batchSummaryOk').addEventListener('click',()=>{
  const pending=window.__batchPendingReview||[];
  batchSummaryBg.classList.remove('open');
  if(pending.length>0){
    const stack=getNavStack();
    navReplace(stack.slice(0,-1).concat('batchReview'));
    showNextBatchPending();
  }else{
    navBack();
  }
});

function showErrorModal(productName,errorReason,photoDataUrl,errorCode){
  navPush('errorModal');
  document.getElementById('errorThumbnail').style.backgroundImage=`url(${photoDataUrl})`;
  document.getElementById('errorProductName').textContent=productName||'No detectado';
  document.getElementById('errorReason').textContent=errorReason;
  errorModalBg.classList.add('open');
  addLog(LOG_LEVELS.ERROR,errorCode,`Error al procesar: ${productName||'Desconocido'}`,{reason:errorReason});
}

function showBatchSummary(total,successes,failures,pendingReview){
  const content=document.getElementById('batchSummaryContent');
  let html=`<div style="font-size:14px;font-weight:500;margin-bottom:16px">Procesadas ${total} fotos</div>`;
  
  if(successes.length>0){
    html+=`<div style="background:#f0fff4;border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid #9ae6b4">
      <div style="color:var(--green);font-weight:500;margin-bottom:8px">‚úÖ ${successes.length} autoguardado${successes.length>1?'s':''} (nombre y al√©rgenos):</div>
      <div style="font-size:12px;color:var(--text2);line-height:1.6">${successes.map(s=>`‚Ä¢ ${s}`).join('<br>')}</div>
    </div>`;
  }
  
  if(pendingReview&&pendingReview.length>0){
    html+=`<div style="background:#fff5f5;border-radius:8px;padding:12px;margin-bottom:12px;border:2px solid var(--red);box-shadow:0 0 0 2px rgba(197,48,48,.15)">
      <div style="color:var(--red);font-weight:600;margin-bottom:8px">‚ö†Ô∏è ${pendingReview.length} pendiente${pendingReview.length>1?'s':''} de revisi√≥n</div>
      <div style="font-size:12px;color:var(--text2);line-height:1.5">Revisar√°s una por una: nombre, al√©rgenos y podr√°s confirmar, corregir o saltar. Haz clic en Aceptar para empezar.</div>
    </div>`;
  }
  
  if(failures.length>0){
    html+=`<div style="background:#fff5f5;border-radius:8px;padding:12px;border:1px solid #fc8181">
      <div style="color:var(--red);font-weight:500;margin-bottom:12px">‚ùå ${failures.length} foto${failures.length>1?'s':''} fall√≥:</div>`;
    failures.forEach(f=>{
      html+=`<div style="border-top:1px solid var(--warm8-10);padding-top:12px;margin-top:12px">
        <div style="width:80px;height:80px;background-image:url(${f.photo});background-size:cover;background-position:center;border-radius:6px;margin-bottom:8px;border:2px solid var(--red)"></div>
        <div style="font-size:12px;color:var(--text);font-weight:500">Producto: ${f.name||'No detectado'}</div>
        <div style="font-size:11px;color:var(--red);margin-top:4px">Motivo: ${f.reason}</div>
      </div>`;
    });
    html+=`</div>`;
  }
  
  content.innerHTML=html;
  window.__batchPendingReview=pendingReview&&pendingReview.length?pendingReview:[];
  navPush('batchSummary');
  batchSummaryBg.classList.add('open');
}

const batchReviewModalBg=document.getElementById('batchReviewModalBg');
function showNextBatchPending(){
  const pending=window.__batchPendingReview||[];
  if(!pending.length){
    batchReviewModalBg.classList.remove('open');
    closeModal();
    return;
  }
  const item=pending[0];
  const r=item.result;
  const allA=item.allA;
  document.getElementById('batchReviewThumb').style.backgroundImage=`url(${item.dataUrl})`;
  document.getElementById('batchReviewName').textContent=r.nombre||'Sin nombre';
  document.getElementById('batchReviewReason').textContent=item.reason;
  document.getElementById('batchReviewAllergens').textContent=allA.length?`Al√©rgenos: ${allA.join(', ')}`:'Sin al√©rgenos marcados';
  document.getElementById('batchReviewCounter').textContent=`${pending.length} pendiente${pending.length>1?'s':''} de revisi√≥n`;
  batchReviewModalBg.classList.add('open');
}
function batchReviewConfirm(){
  const pending=window.__batchPendingReview||[];
  if(!pending.length)return;
  const item=pending.shift();
  const r=item.result;
  const allA=item.allA;
  const match=findMatch(r.nombre);
  if(match){
    mergeProduct(match.index,r.nombre,allA);
    showToast(`‚úì "${r.nombre}" guardado`,'update');
  }else{
    addNewProduct(r.nombre,allA);
    showToast(`‚úì "${r.nombre}" a√±adido`,'new');
  }
  save();render();updateAppStatus();
  if(pending.length===0){ navReplace(['main']); applyNavStack(['main']); return; }
  showNextBatchPending();
}
function batchReviewSkip(){
  const pending=window.__batchPendingReview||[];
  if(!pending.length)return;
  pending.shift();
  if(pending.length===0){ navReplace(['main']); applyNavStack(['main']); return; }
  showNextBatchPending();
}
function batchReviewCorrect(){
  const pending=window.__batchPendingReview||[];
  if(!pending.length)return;
  const item=pending[0];
  navReplace(['main','add']);
  applyNavStack(['main','add']);
  batchReviewModalBg.classList.remove('open');
  document.getElementById('manualName').value=item.result.nombre||'';
  setSelected('manualAllergens',item.allA);
  document.querySelectorAll('.method-btn').forEach(x=>x.classList.remove('active'));
  document.querySelector('.method-btn[data-method="manual"]').classList.add('active');
  document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('show'));
  document.getElementById('secManual').classList.add('show');
  document.getElementById('modalBg').classList.add('open');
  window.__batchReviewCorrecting=true;
}
document.getElementById('batchReviewConfirmBtn').addEventListener('click',batchReviewConfirm);
document.getElementById('batchReviewSkipBtn').addEventListener('click',batchReviewSkip);
document.getElementById('batchReviewCorrectBtn').addEventListener('click',batchReviewCorrect);
batchReviewModalBg.addEventListener('click',e=>{if(e.target===batchReviewModalBg){batchReviewSkip();}});

function showPhotoWarning(productName,warningMsg){
  if(!photoWarningsEnabled())return; // No mostrar si est√° desactivado
  navPush('photoWarning');
  document.getElementById('warningProduct').textContent=productName||'Producto desconocido';
  document.getElementById('warningText').textContent=warningMsg;
  photoWarningBg.classList.add('open');
}

let photos=[null,null],currentSlot=0;
const camInput=document.getElementById('camInput'),galInput=document.getElementById('galInput');
const slot1=document.getElementById('slot1'),slot2=document.getElementById('slot2');
const img1=document.getElementById('img1'),img2=document.getElementById('img2');
const analyzeBtn=document.getElementById('analyzeBtn');
function resetCameraUI(){photos=[null,null];currentSlot=0;img1.style.display='none';img2.style.display='none';slot1.classList.remove('filled');slot2.classList.remove('filled');analyzeBtn.style.display='none';document.getElementById('aiStatus').classList.remove('show');document.getElementById('aiResult').classList.remove('show');document.getElementById('aiWarn').textContent='';hideMatch('aiMatch')}
slot1.addEventListener('click',()=>{currentSlot=0;camInput.click()});
slot2.addEventListener('click',()=>{currentSlot=1;camInput.click()});
document.getElementById('btnCapture').addEventListener('click',()=>{currentSlot=photos[0]?1:0;camInput.click()});
document.getElementById('btnGallery').addEventListener('click',()=>{currentSlot=photos[0]?1:0;galInput.click()});
camInput.addEventListener('change',handleImg);galInput.addEventListener('change',handleImg);
function handleImg(e){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const du=ev.target.result;
    if(autoMode){
      autoProcessPhoto(du);
    }else{
      photos[currentSlot]=du;
      (currentSlot===0?img1:img2).src=du;
      (currentSlot===0?img1:img2).style.display='block';
      (currentSlot===0?slot1:slot2).classList.add('filled');
      if(photos[0]||photos[1])analyzeBtn.style.display='block';
      if(currentSlot===0&&!photos[1])currentSlot=1;
    }
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

analyzeBtn.addEventListener('click',()=>{
  const vKey=getVisionApiKey();
  if(!vKey){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Vision no configurada: falta API Key en ajustes',{service:'Cloud Vision',operation:'analyzeBtn'});
    showToast('Configura la API Key de Google (campo de Drive) en Ajustes (‚öô)','info');
    return;
  }
  const pl=photos.filter(Boolean);
  if(!pl.length){
    showToast('No hay ninguna foto cargada','info');
    return;
  }
  if(!navigator.onLine){
    const aiS=document.getElementById('aiStatus');
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.NETWORK_OFFLINE,'Sin conexion al iniciar analisis de foto',{service:'Cloud Vision',operation:'analyzeBtn'});
    aiS.innerHTML='Sin conexi√≥n ‚Äî la lectura de foto con Google Vision necesita internet.';
    aiS.classList.add('show');
    showToast('Sin conexi√≥n ‚Äî no se puede analizar la foto ahora','info');
    return;
  }
  analyzePhotos(pl);
});

let aiCurrentMatch=null;
const AI_PROMPT=`Eres un sistema de lectura de etiquetas alimentarias. Tu tarea es extraer TODOS los al√©rgenos presentes en la imagen.

IMPORTANTE: Si recibes 2 fotos, son del MISMO producto (envase + etiquetado). La segunda suele mostrar el etiquetado completo (ingredientes, "puede contener trazas de..."). Combina ambas y extrae TODOS los al√©rgenos y trazas que est√©n ESCRITOS.

PASO 1 ‚Äî LEE TODO EL TEXTO RELEVANTE
Lee la etiqueta completa, incluido el texto peque√±o. Busca en:
- Lista de ingredientes (negrita, may√∫sculas, subrayado)
- "Contiene", "Al√©rgenos"
- "Puede contener", "Trazas de", "PUEDE CONTENER TRAZAS DE"
- "Presencia fortuita de", "Elaborado en", "Fabricado en"

PASO 2 ‚Äî HALLAZGOS Y MAPEO
Extrae TODOS los t√©rminos detectados y mapea SIEMPRE a los 14 nombres oficiales:
ALTRAMUZ, APIO, CACAHUETES, CEREALES, CRUST√ÅCEOS, FRUTOS SECOS, HUEVO, L√ÅCTEO, MOLUSCO, MOSTAZA, PESCADO, S√âSAMO, SOJA, SULFITOS

Conversi√≥n obligatoria (ejemplos):
gluten/trigo/cebada/avena/centeno/s√©mola de trigo -> CEREALES
leche/l√°cteos/nata/suero/case√≠na/mantequilla -> L√ÅCTEO
huevo/huevos/clara/yema/ovoalb√∫mina -> HUEVO
gamba/langostino/cangrejo/crust√°ceo/marisco -> CRUST√ÅCEOS
almendra/nuez/avellana/pistacho/anacardo/frutos de c√°scara -> FRUTOS SECOS
calamar/pulpo/mejill√≥n/almeja/molusco -> MOLUSCO
cacahuete/man√≠ -> CACAHUETES
at√∫n/salm√≥n/bacalao/pescado -> PESCADO
s√©samo/tahini -> S√âSAMO
soja/miso/tofu/edamame -> SOJA
mostaza -> MOSTAZA
apio -> APIO
altramuz/lupino -> ALTRAMUZ
sulfitos/anh√≠drido sulfuroso/E220-E228 -> SULFITOS (SOLO si la etiqueta menciona expl√≠citamente sulfitos, sulphites, E220-E228 o anh√≠drido sulfuroso; si no aparece, NO incluyas SULFITOS)

MISMO AL√âRGENO EN VARIOS IDIOMAS: Si ves "apio", "celery", "c√©leri", "Sellerie" etc., es el mismo al√©rgeno (APIO). Incl√∫yelo UNA sola vez en trazas/alergenos. No cuentes cada idioma como al√©rgeno distinto ni a√±adas otros (ej. SULFITOS) que no est√©n escritos.

PASO 3 ‚Äî VERIFICACI√ìN
Revisa que no hayas omitido ning√∫n al√©rgeno o traza que S√ç aparezca escrito en la imagen. Incl√∫yelos todos en hallazgos_texto, mapeo, alergenos y/o trazas.

NOMBRE DEL PRODUCTO: Usa el nombre tal como aparece en el envase (t√≠tulo principal en espa√±ol). Respeta may√∫sculas de la primera letra de cada palabra significativa (ej.: "Salteado r√∫stico - Mezcla de verduras"). No inventes ni reordenes.

AL√âRGENOS Y TRAZAS ‚Äî REGLAS ESTRICTAS:
- Incluye SOLO lo que est√© EXPL√çCITAMENTE escrito (ingredientes, "puede contener", "presencia fortuita", etc.).
- Si en la etiqueta solo pone "Presencia fortuita de apio" (o apio/celery/c√©leri en varios idiomas), trazas debe contener SOLO APIO. No a√±adas SULFITOS, SOJA ni ning√∫n otro al√©rgeno que no aparezca escrito.
- Si en la etiqueta pone "trazas de HUEVO y SOJA", debes incluir HUEVO y SOJA en trazas. No dejes fuera lo que s√≠ est√° escrito.
- NUNCA inventes: si solo aparece "apio", no a√±adas "soja" ni "sulfitos". Si no ves claramente un al√©rgeno, no lo incluyas. En caso de duda, omite en lugar de a√±adir.

Si la zona de al√©rgenos est√° cortada o la imagen est√° muy borrosa y no puedes leer el texto peque√±o, indica "warning" y lista solo lo que s√≠ puedas leer.

Responde SOLO JSON (sin markdown ni bloques \`\`\`json). No incluyas texto antes o despu√©s del objeto.
{"nombre":"...","hallazgos_texto":["..."],"mapeo":[{"texto":"...","alergeno":"..."}],"alergenos":["..."],"trazas":["..."],"notas":"","warning":""}`;

const AI_PROMPT_FROM_OCR=`Eres un sistema de lectura de etiquetas alimentarias. A continuaci√≥n se te da el TEXTO EXTRA√çDO de una etiqueta (OCR). No tienes imagen; solo este texto. Tu tarea es extraer el nombre del producto y TODOS los al√©rgenos presentes en el texto, con las MISMAS reglas que si tuvieras la imagen.

PASO 1 ‚Äî LEE TODO EL TEXTO RELEVANTE
Lee el texto completo. Busca en:
- Lista de ingredientes (negrita, may√∫sculas, subrayado)
- "Contiene", "Al√©rgenos"
- "Puede contener", "Trazas de", "PUEDE CONTENER TRAZAS DE"
- "Presencia fortuita de", "Elaborado en", "Fabricado en"

PASO 2 ‚Äî HALLAZGOS Y MAPEO
Extrae TODOS los t√©rminos detectados y mapea SIEMPRE a los 14 nombres oficiales:
ALTRAMUZ, APIO, CACAHUETES, CEREALES, CRUST√ÅCEOS, FRUTOS SECOS, HUEVO, L√ÅCTEO, MOLUSCO, MOSTAZA, PESCADO, S√âSAMO, SOJA, SULFITOS

Conversi√≥n obligatoria (ejemplos):
gluten/trigo/cebada/avena/centeno/s√©mola de trigo -> CEREALES
leche/l√°cteos/nata/suero/case√≠na/mantequilla -> L√ÅCTEO
huevo/huevos/clara/yema/ovoalb√∫mina -> HUEVO
gamba/langostino/cangrejo/crust√°ceo/marisco -> CRUST√ÅCEOS
almendra/nuez/avellana/pistacho/anacardo/frutos de c√°scara -> FRUTOS SECOS
calamar/pulpo/mejill√≥n/almeja/molusco -> MOLUSCO
cacahuete/man√≠ -> CACAHUETES
at√∫n/salm√≥n/bacalao/pescado -> PESCADO
s√©samo/tahini -> S√âSAMO
soja/miso/tofu/edamame -> SOJA
mostaza -> MOSTAZA
apio -> APIO
altramuz/lupino -> ALTRAMUZ
sulfitos/anh√≠drido sulfuroso/E220-E228 -> SULFITOS (SOLO si la etiqueta menciona expl√≠citamente sulfitos, sulphites, E220-E228 o anh√≠drido sulfuroso; si no aparece, NO incluyas SULFITOS)

MISMO AL√âRGENO EN VARIOS IDIOMAS: Si ves "apio", "celery", "c√©leri", "Sellerie" etc., es el mismo al√©rgeno (APIO). Incl√∫yelo UNA sola vez en trazas/alergenos. No cuentes cada idioma como al√©rgeno distinto ni a√±adas otros (ej. SULFITOS) que no est√©n escritos.

PASO 3 ‚Äî VERIFICACI√ìN
Revisa que no hayas omitido ning√∫n al√©rgeno o traza que S√ç aparezca escrito en el texto. Incl√∫yelos todos en hallazgos_texto, mapeo, alergenos y/o trazas.

NOMBRE DEL PRODUCTO: Usa el nombre tal como aparece en el envase (t√≠tulo principal en espa√±ol). Respeta may√∫sculas de la primera letra de cada palabra significativa (ej.: "Salteado r√∫stico - Mezcla de verduras"). No inventes ni reordenes.

AL√âRGENOS Y TRAZAS ‚Äî REGLAS ESTRICTAS:
- Incluye SOLO lo que est√© EXPL√çCITAMENTE escrito (ingredientes, "puede contener", "presencia fortuita", etc.).
- Si en la etiqueta solo pone "Presencia fortuita de apio" (o apio/celery/c√©leri en varios idiomas), trazas debe contener SOLO APIO. No a√±adas SULFITOS, SOJA ni ning√∫n otro al√©rgeno que no aparezca escrito.
- Si en la etiqueta pone "trazas de HUEVO y SOJA", debes incluir HUEVO y SOJA en trazas. No dejes fuera lo que s√≠ est√° escrito.
- NUNCA inventes: si solo aparece "apio", no a√±adas "soja" ni "sulfitos". Si no ves claramente un al√©rgeno, no lo incluyas. En caso de duda, omite en lugar de a√±adir.

Si el texto est√° incompleto o no se ve la zona de al√©rgenos, indica "warning" y lista solo lo que s√≠ puedas leer.

Responde SOLO JSON (sin markdown ni bloques \`\`\`json). No incluyas texto antes o despu√©s del objeto.
{"nombre":"...","hallazgos_texto":["..."],"mapeo":[{"texto":"...","alergeno":"..."}],"alergenos":["..."],"trazas":["..."],"notas":"","warning":""}`;

async function apiCall(content, options){
  const key=getApiKey();
  if(!key){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Gemini no configurada: falta API Key',{service:'Gemini',operation:'apiCall'});
    return new Response(JSON.stringify({error:{message:'Clave API no configurada'}}),{status:401,statusText:'Unauthorized'});
  }
  const imageParts=[];
  let textPrompt='';
  content.forEach(item=>{
    if(item.type==='image'&&item.source){
      imageParts.push({
        inline_data:{
          mime_type:item.source.media_type||'image/jpeg',
          data:item.source.data
        }
      });
    }else if(item.type==='text'){
      textPrompt=item.text||'';
    }
  });
  // Instrucciones primero, luego im√°genes (Gemini sigue mejor el formato as√≠)
  const parts=textPrompt?[{text:textPrompt},...imageParts]:imageParts;

  // Con GPT las instrucciones iban en "system" y se cumpl√≠an bien. Con Gemini hay que poner
  // TODO el prompt en systemInstruction; si no, el modelo no sigue bien las reglas.
  const systemText=(options&&options.systemInstruction)
    ?options.systemInstruction
    :'Responde √öNICAMENTE con un objeto JSON v√°lido en el formato exacto que te pida el usuario. No incluyas texto antes ni despu√©s del JSON, ni bloques de markdown (```). Sin explicaciones. En ese JSON, el campo "nombre" es SIEMPRE el t√≠tulo del producto (el que aparece al inicio de la etiqueta o del texto), nunca un fragmento de la lista de ingredientes.';

  const url=GEMINI_GENERATE_URL;
  const body=JSON.stringify({
    systemInstruction:{ parts:[{ text: systemText }] },
    contents:[{role:'user',parts}],
    generationConfig:{maxOutputTokens:3000,temperature:0}
  });
  let lastResp=null;
  for(let attempt=0;attempt<=2;attempt++){
    const ac=new AbortController();
    const t=setTimeout(()=>ac.abort(),60000);
    try{
      lastResp=await fetchWithDiagnostics(url,{method:'POST',headers:buildGeminiHeaders(key),body,signal:ac.signal},{
        service:'Gemini',
        operation:'analisis de etiqueta',
        requestTag:'apiCall_attempt_'+(attempt+1),
        requireOnline:true
      });
      clearTimeout(t);
      const json=await lastResp.json().catch(()=>({}));
      const text=(json.candidates&&json.candidates[0]&&json.candidates[0].content&&json.candidates[0].content.parts&&json.candidates[0].content.parts[0])?json.candidates[0].content.parts[0].text||'':'';
      if(lastResp.ok){
        return new Response(JSON.stringify({choices:[{message:{content:text}}]}),{status:200,headers:{'Content-Type':'application/json'}});
      }
      const errMsg=json.error&&json.error.message?json.error.message:'Error Gemini';
      const errorCode=mapHttpStatusToErrorCode(lastResp.status,errMsg);
      const normalizedStatus=errorCode===ERROR_CODES.API_AUTH_FAILED?401:lastResp.status;
      const hint=buildGeminiTroubleshootingHint(errMsg,lastResp.status);
      if((errorCode===ERROR_CODES.API_RATE_LIMIT||errorCode===ERROR_CODES.API_SERVER_ERROR)&&attempt<2){
        await new Promise(r=>setTimeout(r,attempt===0?2000:5000));
        continue;
      }
      return new Response(JSON.stringify({error:{message:errMsg,code:errorCode,hint}}),{status:normalizedStatus,statusText:lastResp.statusText,headers:{'Content-Type':'application/json'}});
    }catch(err){
      clearTimeout(t);
      if(err.code===ERROR_CODES.NETWORK_OFFLINE){
        return new Response(JSON.stringify({error:{message:'Sin conexion a internet'}}),{status:503,headers:{'Content-Type':'application/json'}});
      }
      if(err.name==='AbortError'){
        return new Response(JSON.stringify({error:{message:'Timeout'}}),{status:408,headers:{'Content-Type':'application/json'}});
      }
      if(attempt<2) await new Promise(r=>setTimeout(r,attempt===0?2000:5000));
      else return new Response(JSON.stringify({error:{message:err.message||'Error de red'}}),{status:500,headers:{'Content-Type':'application/json'}});
    }
  }
  return lastResp?new Response(JSON.stringify({error:{message:'Error'}}),{status:lastResp.status,headers:{'Content-Type':'application/json'}}):new Response(JSON.stringify({error:{message:'Error'}}),{status:500,headers:{'Content-Type':'application/json'}});
}

const PHOTO_MAX_SIZE=1120;
const PHOTO_JPEG_QUALITY=0.85;
function compressPhotoForAI(dataUrl){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.width,h=img.height;
      const needsResize=w>PHOTO_MAX_SIZE||h>PHOTO_MAX_SIZE;
      if(needsResize){
        const r=Math.min(PHOTO_MAX_SIZE/w,PHOTO_MAX_SIZE/h);
        w=Math.round(w*r);h=Math.round(h*r);
      }
      const canvas=document.createElement('canvas');
      canvas.width=w;canvas.height=h;
      const ctx=canvas.getContext('2d');
      if(!ctx){resolve({dataUrl,width:img.width,height:img.height});return;}
      ctx.drawImage(img,0,0,w,h);
      try{
        const jpeg=canvas.toDataURL('image/jpeg',PHOTO_JPEG_QUALITY);
        resolve({dataUrl:jpeg,width:w,height:h,originalWidth:img.width,originalHeight:img.height,resized:needsResize});
      }catch(e){
        resolve({dataUrl,width:img.width,height:img.height});
      }
    };
    img.onerror=()=>resolve({dataUrl,width:0,height:0});
    img.src=dataUrl;
  });
}
async function buildPhotoRequest(photoList){
  const list=Array.isArray(photoList)?photoList:[photoList].filter(Boolean);
  const compressed=await Promise.all(list.map(du=>compressPhotoForAI(du)));
  const content=compressed.map(c=>{
    const dataUrl=typeof c==='object'&&c.dataUrl!=null?c.dataUrl:c;
    const mediaType=dataUrl.split(';')[0].split(':')[1]||'image/jpeg';
    const data=(dataUrl.split(',')[1]||'');
    return {type:'image',source:{type:'base64',media_type:mediaType,data:data}};
  });
  // Las instrucciones completas (AI_PROMPT) se env√≠an como systemInstruction en apiCall, no aqu√≠.
  // As√≠ Gemini las cumple igual que GPT cumpl√≠a el "system" message.
  const dimensions=(compressed||[]).map(c=>typeof c==='object'&&c.width!=null?{w:c.width,h:c.height}:null).filter(Boolean);
  const metadata={ n_photos: list.length, dimensions, max_size: PHOTO_MAX_SIZE, quality: PHOTO_JPEG_QUALITY };
  return { content, metadata, systemPrompt: AI_PROMPT };
}

async function analyzePhotos(photoList){
  analysisAborted=false;
  const aiS=document.getElementById('aiStatus'),aiR=document.getElementById('aiResult');
  aiS.innerHTML='<span class="spinner"></span> Preparando imagen‚Ä¶';aiS.classList.add('show');aiR.classList.remove('show');hideMatch('aiMatch');aiCurrentMatch=null;
  let analysisId=null;

  const list=Array.isArray(photoList)?photoList.filter(Boolean):[photoList].filter(Boolean);
  if(!list.length){aiS.innerHTML='No hay fotos para analizar';return;}

  const visionKey=getVisionApiKey();
  if(!visionKey){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Vision sin API Key configurada',{service:'Cloud Vision',operation:'analyzePhotos'});
    aiS.innerHTML='Configura la API Key de Google (campo de Drive) en Ajustes.';
    return;
  }

  try{
    const compressed=await Promise.all(list.map(du=>compressPhotoForAI(du)));
    if(analysisAborted){aiS.innerHTML='‚ùå An√°lisis cancelado';return;}

    const metadata={ dimensions: compressed.map(c=>c&&typeof c==='object'&&c.width!=null?{w:c.width,h:c.height}:null).filter(Boolean) };
    const started=startPhotoAnalysis('vision',list.length,metadata);
    analysisId=started.analysisId;

    aiS.innerHTML='<span class="spinner"></span> Enviando y analizando‚Ä¶';

    const images=compressed.map(c=>{
      const dataUrl=typeof c==='object'&&c.dataUrl!=null?c.dataUrl:c;
      return (String(dataUrl||'').split(',')[1]||'').trim();
    }).filter(Boolean);

    if(!images.length){
      addAnalysisSection(analysisId,'F_decision',{decision:'error',error:'No se pudo preparar la imagen'});
      finishPhotoAnalysis(analysisId,new Error('No se pudo preparar la imagen'));
      addLog(LOG_LEVELS.ERROR,ERROR_CODES.PHOTO_UNREADABLE,'No se pudo codificar la imagen para Vision',{service:'Cloud Vision',operation:'analyzePhotos',analysis_id:analysisId});
      aiS.innerHTML='No se pudo preparar la imagen para analizar';
      return;
    }

    const body={
      requests:images.map(img=>({
        image:{content:img},
        features:[{type:'DOCUMENT_TEXT_DETECTION'}],
        imageContext:{languageHints:['es','en','fr','de']}
      }))
    };

    const resp=await fetchWithDiagnostics('https://vision.googleapis.com/v1/images:annotate?key='+encodeURIComponent(visionKey),{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    },{
      service:'Cloud Vision',
      operation:'ocr de etiqueta',
      requestTag:'analyzePhotos',
      requireOnline:true
    });

    if(analysisAborted){
      if(analysisId){
        addAnalysisSection(analysisId,'F_decision',{decision:'cancelado',motivo:'usuario'});
        finishPhotoAnalysis(analysisId);
      }
      aiS.innerHTML='‚ùå An√°lisis cancelado';
      return;
    }

    if(!resp.ok){
      let msg='Error Vision ('+resp.status+')';
      try{
        const errBody=await resp.json();
        if(errBody&&errBody.error&&errBody.error.message){
          msg=errBody.error.message;
        }
      }catch(_){}
      addAnalysisSection(analysisId,'F_decision',{decision:'error',error:msg});
      finishPhotoAnalysis(analysisId,new Error(msg));
      aiS.innerHTML='Error: '+msg;
      return;
    }

    const data=await resp.json();
    const ocrText=extractTextFromVisionResponse(data);
    if(!ocrText){
      addLog(LOG_LEVELS.WARN,ERROR_CODES.PHOTO_UNREADABLE,'Vision no detecto texto en la etiqueta',{service:'Cloud Vision',operation:'ocr de etiqueta',analysis_id:analysisId});
      addAnalysisSection(analysisId,'F_decision',{decision:'no_guardar',motivo:'ocr_sin_texto'});
      finishPhotoAnalysis(analysisId);
      aiS.innerHTML='No se pudo leer texto en la etiqueta';
      return;
    }

    addAnalysisSection(analysisId,'C_raw_output',{ raw_text: String(ocrText).slice(0,5000), length: ocrText.length });
    let result;
    const geminiKey=getApiKey();
    if(geminiKey){
      aiS.innerHTML='<span class="spinner"></span> Interpretando con IA (nombre y al√©rgenos)‚Ä¶';
      try{
        // Instrucciones completas en systemInstruction (como el "system" de GPT); solo el texto OCR en el user.
        const userText='--- TEXTO DE LA ETIQUETA ---\n'+String(ocrText).slice(0,12000);
        const content=[{ type:'text', text: userText }];
        const iaResp=await apiCall(content,{ systemInstruction: AI_PROMPT_FROM_OCR });
        if(iaResp&&iaResp.ok){
          const iaData=await iaResp.json();
          const text=iaData.choices?.[0]?.message?.content||'';
          result=parseAndValidateAI(text,'vision');
          result.nombre=fixNombreFromOcr(result.nombre,ocrText);
          result=normalizeAIPhotoResult(result);
        }else{
          const errBody=await iaResp.json().catch(()=>null);
          const providerMessage=extractProviderErrorMessage(errBody)||`HTTP ${iaResp.status}`;
          result=normalizeAIPhotoResult(buildResultFromOcrText(ocrText));
          const hint=buildGeminiTroubleshootingHint(providerMessage,iaResp.status);
          if(typeof showToast==='function') showToast('La IA no respondi√≥; se us√≥ interpretaci√≥n local.'+(hint?` ${hint}`:''),'info');
        }
      }catch(e){
        result=normalizeAIPhotoResult(buildResultFromOcrText(ocrText));
        const hint=buildGeminiTroubleshootingHint((e&&e.message)||'',(e&&e.status)||0);
        if(typeof showToast==='function') showToast('Error al interpretar con IA; se us√≥ interpretaci√≥n local.'+(hint?` ${hint}`:''),'info');
      }
    }else{
      result=normalizeAIPhotoResult(buildResultFromOcrText(ocrText));
    }

    result.nombre=fixNombreFromOcr(result.nombre||'',ocrText);
    addAnalysisSection(analysisId,'D_interpretation',{ nombre: result.nombre, alergenos: result.alergenos||[], trazas: result.trazas||[] });
    window.__lastAnalysisId=analysisId;

    aiS.innerHTML='‚úì An√°lisis completado';
    window.__lastAIPhotoAnalysis=result;

    const allA=sortAllergens([...new Set([...(result.alergenos||[]),...(result.trazas||[])])].filter(a=>AL.includes(a)));
    document.getElementById('aiName').value=result.nombre||'';
    setSelected('aiAllergens',allA);

    let warn='';
    if(result.trazas&&result.trazas.length)warn='Trazas incluidas: '+result.trazas.join(', ');
    if(result.notas)warn+=(warn?' ¬∑ ':'')+result.notas;
    document.getElementById('aiWarn').textContent=warn;

    if(result.warning){
      showPhotoWarning(result.nombre||'Producto desconocido',result.warning);
    }

    if(result.nombre){
      const match=findMatch(result.nombre);
      aiCurrentMatch=match;
      if(match){
        showMatch('aiMatch',match);
        document.getElementById('aiSave').textContent='Actualizar existente';
      }else{
        document.getElementById('aiSave').textContent='Guardar producto nuevo';
      }
    }

    aiR.classList.add('show');
    const saveBtn=document.getElementById('aiSave');
    if(saveBtn){saveBtn.disabled=false;}
    updateSave('aiAllergens');
  }catch(err){
    if(analysisAborted){
      if(analysisId){
        addAnalysisSection(analysisId,'F_decision',{decision:'cancelado',motivo:'usuario'});
        finishPhotoAnalysis(analysisId);
      }
      return;
    }
    if(analysisId){
      addAnalysisSection(analysisId,'F_decision',{decision:'error',error:err.message||'Error desconocido'});
      finishPhotoAnalysis(analysisId,err);
    }
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.API_INVALID_RESPONSE,'Error en flujo de analisis de foto',{
      service:'Vision+Gemini',
      operation:'analyzePhotos',
      error:err&&err.message?err.message:String(err),
      probable_cause: classifyHttpFailure((err&&err.status)||0, (err&&err.message)||'')
    });
    aiS.innerHTML='Error: '+err.message;
  }
}

document.getElementById('aiName').addEventListener('input',()=>{updateSave('aiAllergens');const name=document.getElementById('aiName').value.trim();if(name.length<3){hideMatch('aiMatch');aiCurrentMatch=null;document.getElementById('aiSave').textContent='Guardar producto';return}const match=findMatch(name);aiCurrentMatch=match;if(match){showMatch('aiMatch',match);document.getElementById('aiSave').textContent='Actualizar existente'}else{hideMatch('aiMatch');document.getElementById('aiSave').textContent='Guardar producto nuevo'}});
document.getElementById('aiName').addEventListener('blur',()=>{const v=document.getElementById('aiName').value.trim();if(v){const c=autoCorrectName(v);if(c!==v){document.getElementById('aiName').value=c;showToast('Ortograf√≠a corregida','info')}}});
document.getElementById('aiCancel').addEventListener('click',()=>{resetCameraUI();document.getElementById('aiResult').classList.remove('show');document.getElementById('secCamera').classList.add('show');document.querySelectorAll('.method-btn').forEach(b=>b.classList.toggle('active',b.dataset.method==='camera'));});
document.getElementById('aiSave').addEventListener('click',()=>{
  let name=document.getElementById('aiName').value.trim();if(!name)return;
  name=autoCorrectName(name);
  const al=getSelected('aiAllergens');
  const aiMeta=window.__lastAIPhotoAnalysis||null;
  const analysisId=window.__lastAnalysisId||null;
  const analysisTimestamp=new Date().toISOString();
  if(aiMeta && aiMeta.requires_review){
    const ok=confirm('La IA detect√≥ posibles omisiones de al√©rgenos. Revisa la etiqueta antes de guardar. ¬øConfirmas guardar igualmente?');
    if(!ok) return;
  }
  if(aiCurrentMatch){
    const prev=P[aiCurrentMatch.index]||{};
    const r=mergeProduct(aiCurrentMatch.index,name,al,analysisId?{analysisId,analysisTimestamp}:undefined);
    if(P[aiCurrentMatch.index]){
      P[aiCurrentMatch.index].requires_review=!!(aiMeta&&aiMeta.requires_review);
      P[aiCurrentMatch.index].review_alerts=(aiMeta&&aiMeta.review_alerts)||prev.review_alerts||null;
      P[aiCurrentMatch.index].warning=(aiMeta&&aiMeta.warning)||prev.warning||'';
      P[aiCurrentMatch.index].notes=(aiMeta&&aiMeta.notas)||prev.notes||'';
    }
    if(analysisId&&typeof addAnalysisSection==='function'){
      addAnalysisSection(analysisId,'F_decision',{decision:'actualizar',motivo:'usuario_guardar',product_id:aiCurrentMatch.index,product_name:name});
      addAnalysisSection(analysisId,'G_saved_result',{product_index:aiCurrentMatch.index,product_name:name,alergenos:P[aiCurrentMatch.index].a,trazas:[],timestamp:analysisTimestamp,declarable:true});
      finishPhotoAnalysis(analysisId);
    }
    save(); lastSavedName=aiCurrentMatch.product.n;render();
    showToast(r.added.length?`‚úì "${aiCurrentMatch.product.n}" ¬∑ +${r.added.length} al√©rgeno${r.added.length>1?'s':''}`:`‚úì "${aiCurrentMatch.product.n}" verificado`,'update')
  }else{
    addNewProduct(name,al,analysisId?{analysisId,analysisTimestamp}:undefined);
    const idx=P.findIndex(x=>norm(x.n)===norm(name));
    if(idx>=0){
      P[idx].requires_review=!!(aiMeta&&aiMeta.requires_review);
      P[idx].review_alerts=(aiMeta&&aiMeta.review_alerts)||null;
      P[idx].warning=(aiMeta&&aiMeta.warning)||'';
      P[idx].notes=(aiMeta&&aiMeta.notas)||'';
      if(analysisId&&typeof addAnalysisSection==='function'){
        addAnalysisSection(analysisId,'F_decision',{decision:'crear',motivo:'usuario_guardar',product_name:name});
        addAnalysisSection(analysisId,'G_saved_result',{product_index:idx,product_name:name,alergenos:P[idx].a,trazas:[],timestamp:analysisTimestamp,declarable:true});
        finishPhotoAnalysis(analysisId);
      }
      save();
    }
    lastSavedName=name;render();showToast(`‚úì "${name}" a√±adido`,'new')
  }
  window.__lastAnalysisId=null;
  closeModal()
});

const queueBar=document.getElementById('queueBar'),queueText=document.getElementById('queueText'),queueDot=document.getElementById('queueDot');
function updateQueueBar(){if(!photoQueue.length){queueBar.classList.remove('show');return}queueBar.classList.add('show');queueText.textContent=isProcessing?`Procesando‚Ä¶ ${photoQueue.length} restante${photoQueue.length>1?'s':''}`:`${photoQueue.length} foto${photoQueue.length>1?'s':''} en cola`;queueDot.classList.toggle('pulse',isProcessing)}
async function processQueue(){
  if(isProcessing||!photoQueue.length)return;
  if(!navigator.onLine){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.NETWORK_OFFLINE,'Cola IA detenida: sin conexion',{service:'Gemini',operation:'processQueue'});
    return;
  }
  if(!getApiKey()){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Cola IA detenida: falta API Key Gemini',{service:'Gemini',operation:'processQueue'});
    return;
  }
  isProcessing=true;updateQueueBar();
  while(photoQueue.length>0&&navigator.onLine){
    const item=photoQueue[0];const pl=item.photos||[item.dataUrl].filter(Boolean);
    let queueAnalysisId=null;
    let retries=0,success=false;
    while(retries<3&&!success){
      try{
        const { content, metadata }=await buildPhotoRequest(pl);
        const { analysisId }=startPhotoAnalysis('autom√°tico',pl.length,metadata);
        queueAnalysisId=analysisId;
        addAnalysisSection(analysisId,'B_input',{ dimensions: metadata.dimensions });
        const resp=await apiCall(content,{ systemInstruction: metadata.systemPrompt || AI_PROMPT });
        if(!resp.ok){
          const errBody=await resp.json().catch(()=>null);
          const providerMessage=extractProviderErrorMessage(errBody);
          const errorCode=mapHttpStatusToErrorCode(resp.status,providerMessage);
          const errorMsgByCode={
            [ERROR_CODES.API_AUTH_FAILED]:'Clave API inv√°lida o no autorizada',
            [ERROR_CODES.API_REFERRER_BLOCKED]:'Dominio no autorizado en la API key',
            [ERROR_CODES.API_DISABLED]:'Generative Language API deshabilitada',
            [ERROR_CODES.API_BILLING_REQUIRED]:'Falta facturaci√≥n activa en Google Cloud',
            [ERROR_CODES.API_RATE_LIMIT]:'L√≠mite de cuota alcanzado',
            [ERROR_CODES.API_SERVER_ERROR]:'Error temporal del servidor Gemini',
            [ERROR_CODES.API_TIMEOUT]:'Timeout de Gemini'
          };
          const errorMsg=errorMsgByCode[errorCode]||providerMessage||`HTTP ${resp.status}`;
          addAnalysisSection(analysisId,'F_decision',{decision:'error',error:errorMsg});
          finishPhotoAnalysis(analysisId,new Error(errorMsg));
          throw new Error(errorMsg);
        }
        const data=await resp.json();const text=data.choices?.[0]?.message?.content||'';
        const possibleTruncated=String(text).length>=2990;
        addAnalysisSection(analysisId,'C_raw_output',{ raw_text: String(text).slice(0,5000), length: text.length, markdown_like: /```/.test(text), possible_truncated: possibleTruncated });
        let result;try{result=parseAndValidateAI(text,'photo_queue_batch')}catch(e){
          addAnalysisSection(analysisId,'F_decision',{decision:'error',error:'parse'}); finishPhotoAnalysis(analysisId,e);
          throw new Error('parse');
        }
        addAnalysisSection(analysisId,'D_interpretation',{ nombre: result.nombre, alergenos: result.alergenos||[], trazas: result.trazas||[], normalizado_app: { alergenos: result.alergenos||[], trazas: result.trazas||[] } });
        addAnalysisSection(analysisId,'E_validations',{ review_alerts: result.review_alerts||null, requires_review: !!result.requires_review });
        if(result.nombre)result.nombre=autoCorrectName(result.nombre);
        if(result.warning){
          showPhotoWarning(result.nombre||'Producto en cola',result.warning);
          addLog(LOG_LEVELS.WARN,ERROR_CODES.PHOTO_QUALITY,`Cola - Calidad: ${result.nombre||'Desconocido'}`,{warning:result.warning});
        }
        if(result.nombre){
          const allA=sortAllergens([...new Set([...(result.alergenos||[]),...(result.trazas||[])])].filter(a=>AL.includes(a)));
          const ts=new Date().toISOString();
          if(isAutoOk(result)){
            const match=findMatch(result.nombre);
            if(match){
              const r=mergeProduct(match.index,result.nombre,allA,{analysisId,analysisTimestamp:ts});
              addAnalysisSection(analysisId,'F_decision',{decision:'actualizar',motivo:'auto_guardar',product_name:result.nombre});
              addAnalysisSection(analysisId,'G_saved_result',{product_index:match.index,product_name:result.nombre,alergenos:P[match.index].a,timestamp:ts,declarable:true});
              finishPhotoAnalysis(analysisId);
              if(match.index>=0&&match.index<P.length){
                P[match.index].requires_review=!!result.requires_review;
                P[match.index].review_alerts=result.review_alerts||null;
                P[match.index].warning=result.warning||P[match.index].warning||'';
              }
              saveDB();
              if(result.requires_review) showToast('‚ö† Revisar IA: posible omisi√≥n','info');
              showToast(r.added.length?`‚úì Cola: "${match.product.n}" +${r.added.length}`:`‚úì Cola: "${match.product.n}" verificado`,'update');
              addLog(LOG_LEVELS.INFO,'QUEUE_UPDATED',`Cola - Actualizado: ${match.product.n}`,{added:r.added.length});
            }else{
              addNewProduct(result.nombre,allA,{analysisId,analysisTimestamp:ts});
              const idx=P.findIndex(x=>norm(x.n)===norm(result.nombre));
              if(idx>=0){
                addAnalysisSection(analysisId,'F_decision',{decision:'crear',motivo:'auto_guardar',product_name:result.nombre});
                addAnalysisSection(analysisId,'G_saved_result',{product_index:idx,product_name:result.nombre,alergenos:P[idx].a,timestamp:ts,declarable:true});
                finishPhotoAnalysis(analysisId);
                P[idx].requires_review=!!result.requires_review;
                P[idx].review_alerts=result.review_alerts||null;
                P[idx].warning=result.warning||'';
                saveDB();
              }
              if(result.requires_review) showToast('‚ö† Revisar IA: posible omisi√≥n','info');
              showToast(`‚úì Cola: "${result.nombre}" a√±adido`,'new');
              addLog(LOG_LEVELS.INFO,'QUEUE_SAVED',`Cola - Guardado: ${result.nombre}`,{allergens:allA.length});
            }
          }else{
            addAnalysisSection(analysisId,'F_decision',{decision:'bloquear_revision',motivo:buildReviewReason(result)});
            finishPhotoAnalysis(analysisId);
            queuePendingReview.push({ result, allA, dataUrl: pl[0], reason: buildReviewReason(result) });
            showToast('‚ö† Pendiente de revisi√≥n: '+result.nombre,'info');
            addLog(LOG_LEVELS.INFO,'QUEUE_PENDING_REVIEW',`Cola - Pendiente: ${result.nombre}`,{reason:buildReviewReason(result)});
          }
        }else{
          addAnalysisSection(analysisId,'F_decision',{decision:'no_guardar',motivo:'sin_nombre'});
          finishPhotoAnalysis(analysisId);
          addLog(LOG_LEVELS.WARN,ERROR_CODES.PHOTO_NO_NAME,'Cola - Sin nombre detectado',{});
        }
        success=true;
      }catch(err){
        if(queueAnalysisId){
          const ax=(typeof diagnosticAnalyses!=='undefined'&&diagnosticAnalyses||[]).find(x=>x.analysis_id===queueAnalysisId);
          if(ax&&!ax.finished_at){ addAnalysisSection(queueAnalysisId,'F_decision',{decision:'error',error:err.message}); finishPhotoAnalysis(queueAnalysisId,err); }
        }
        if(!navigator.onLine){
          addLog(LOG_LEVELS.ERROR,ERROR_CODES.NETWORK_OFFLINE,'Sin conexi√≥n - Cola pausada',{});
          isProcessing=false;updateQueueBar();return;
        }
        retries++;
        addLog(LOG_LEVELS.WARN,'QUEUE_RETRY',`Cola - Reintento ${retries}/3`,{error:err.message});
        if(retries<3)await new Promise(r=>setTimeout(r,1000*retries));
      }
    }
    if(!success){
      showToast('Error procesando foto (3 intentos)','info');
      addLog(LOG_LEVELS.ERROR,'QUEUE_FAILED','Cola - Fallo tras 3 intentos',{});
    }
    photoQueue.shift();saveQueue();updateQueueBar();if(photoQueue.length)await new Promise(r=>setTimeout(r,800));
  }
  isProcessing=false;updateQueueBar();render();updateAppStatus();
  if(queuePendingReview.length>0){
    window.__batchPendingReview=queuePendingReview.slice();
    queuePendingReview=[];
    showNextBatchPending();
  }
}
document.getElementById('queueAction').addEventListener('click',processQueue);
window.addEventListener('online',()=>{document.getElementById('offlineBanner').classList.remove('show');if(photoQueue.length&&getApiKey())processQueue(); if(gdriveToken && (pendingChanges || localStorage.getItem('pending_changes')==='1')) setTimeout(()=>gdriveSmartSync('online_reconnect'),800);});
window.addEventListener('offline',()=>{document.getElementById('offlineBanner').classList.add('show')});
if(!navigator.onLine)document.getElementById('offlineBanner').classList.add('show');
updateQueueBar();

// ‚îÄ‚îÄ‚îÄ FLUJO AUTOM√ÅTICO C√ÅMARA ‚îÄ‚îÄ‚îÄ
let autoMode=false;
const btnAutoFlow=document.createElement('button');
btnAutoFlow.className='cam-btn';
btnAutoFlow.innerHTML='‚ö° Modo autom√°tico<div style="font-size:10px;margin-top:4px;opacity:0.8;font-weight:400">Foto ‚Üí Auto-guardar ‚Üí Foto (r√°pido)</div>';
btnAutoFlow.style.gridColumn='1 / -1';
btnAutoFlow.style.background='var(--green)';
btnAutoFlow.style.color='#fff';
document.querySelector('.cam-btns').after(btnAutoFlow);

btnAutoFlow.addEventListener('click',async()=>{
  if(!getApiKey()){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Modo automatico no disponible: falta API Key Gemini',{service:'Gemini',operation:'autoModeStart'});
    showToast('Configura la clave API en Ajustes (‚öô)','info');
    return;
  }
  autoMode=true;btnAutoFlow.style.display='none';
  document.getElementById('aiStatus').innerHTML='<span class="spinner"></span> Modo autom√°tico activo ‚Äî Haz una foto';
  document.getElementById('aiStatus').classList.add('show');
  camInput.click();
});

async function autoProcessPhoto(dataUrl){
  if(!autoMode)return;
  const aiS=document.getElementById('aiStatus');
  aiS.innerHTML='<span class="spinner"></span> Analizando autom√°ticamente‚Ä¶';
  const { content, metadata }=await buildPhotoRequest([dataUrl]);
  const { analysisId }=startPhotoAnalysis('autom√°tico',1,metadata);
  addAnalysisSection(analysisId,'B_input',{ dimensions: metadata.dimensions });
  try{
    const resp=await apiCall(content,{ systemInstruction: metadata.systemPrompt || AI_PROMPT });
    if(!resp.ok){
      let errorCode,errorMsg;
      if(resp.status===401){
        errorCode=ERROR_CODES.API_AUTH_FAILED;
        errorMsg='Clave API inv√°lida';
      }else if(resp.status===429){
        errorCode=ERROR_CODES.API_RATE_LIMIT;
        errorMsg='L√≠mite de llamadas alcanzado';
      }else if(resp.status>=500){
        errorCode=ERROR_CODES.API_SERVER_ERROR;
        errorMsg=`Error del servidor (${resp.status})`;
      }else{
        errorCode=ERROR_CODES.API_INVALID_RESPONSE;
        errorMsg=`Error HTTP ${resp.status}`;
      }
      addAnalysisSection(analysisId,'F_decision',{decision:'error',error:errorMsg});
      finishPhotoAnalysis(analysisId,new Error(errorMsg));
      showErrorModal('Autom√°tico',errorMsg,dataUrl,errorCode);
      const err=await resp.json().catch(()=>({}));
      throw new Error(err.error?.message||errorMsg);
    }
    const data=await resp.json();const text=data.choices?.[0]?.message?.content||'';
    const possibleTruncated=String(text).length>=2990;
    addAnalysisSection(analysisId,'C_raw_output',{ raw_text: String(text).slice(0,5000), length: text.length, markdown_like: /```/.test(text), possible_truncated: possibleTruncated });
    let result;
    try{
      result=parseAndValidateAI(text,'auto_flow');
    }catch(e){
      addAnalysisSection(analysisId,'F_decision',{decision:'error',error:'Respuesta no interpretable'});
      finishPhotoAnalysis(analysisId,e);
      showErrorModal('Autom√°tico','Respuesta de IA no v√°lida',dataUrl,ERROR_CODES.JSON_PARSE_ERROR);
      throw new Error('parse');
    }
    addAnalysisSection(analysisId,'D_interpretation',{ nombre: result.nombre, alergenos: result.alergenos||[], trazas: result.trazas||[], normalizado_app: { alergenos: result.alergenos||[], trazas: result.trazas||[] } });
    addAnalysisSection(analysisId,'E_validations',{ review_alerts: result.review_alerts||null, requires_review: !!result.requires_review });
    if(result.nombre)result.nombre=autoCorrectName(result.nombre);
    const allA=sortAllergens([...new Set([...(result.alergenos||[]),...(result.trazas||[])])].filter(a=>AL.includes(a)));
    if(result.warning){
      showPhotoWarning(result.nombre||'Producto autom√°tico',result.warning);
      addLog(LOG_LEVELS.WARN,ERROR_CODES.PHOTO_QUALITY,`Auto - Calidad: ${result.nombre||'Desconocido'}`,{warning:result.warning});
    }
    if(result.nombre){
      if(isAutoOk(result)){
        const match=findMatch(result.nombre);
        const ts=new Date().toISOString();
        if(match){
          const r=mergeProduct(match.index,result.nombre,allA,{analysisId,analysisTimestamp:ts});
          addAnalysisSection(analysisId,'F_decision',{decision:'actualizar',motivo:'auto_guardar',product_name:result.nombre});
          addAnalysisSection(analysisId,'G_saved_result',{product_index:match.index,product_name:result.nombre,alergenos:P[match.index].a,timestamp:ts,declarable:true});
          finishPhotoAnalysis(analysisId);
          render();updateAppStatus();
          showToast(r.added.length?`‚ö° \"${match.product.n}\" actualizado +${r.added.length}`:`‚ö° \"${match.product.n}\" verificado`,'update');
          addLog(LOG_LEVELS.INFO,'AUTO_UPDATED',`Auto - Actualizado: ${match.product.n}`,{added:r.added.length});
        }else{
          addNewProduct(result.nombre,allA,{analysisId,analysisTimestamp:ts});
          const idx=P.findIndex(x=>norm(x.n)===norm(result.nombre));
          if(idx>=0){
            addAnalysisSection(analysisId,'F_decision',{decision:'crear',motivo:'auto_guardar',product_name:result.nombre});
            addAnalysisSection(analysisId,'G_saved_result',{product_index:idx,product_name:result.nombre,alergenos:P[idx].a,timestamp:ts,declarable:true});
            finishPhotoAnalysis(analysisId);
          }
          render();updateAppStatus();
          showToast(`‚ö° \"${result.nombre}\" a√±adido`,'new');
          addLog(LOG_LEVELS.INFO,'AUTO_SAVED',`Auto - Guardado: ${result.nombre}`,{allergens:allA.length});
        }
        aiS.innerHTML='‚úì Guardado ‚Äî Puedes hacer otra foto';
        setTimeout(()=>camInput.click(),1500);
      }else{
        addAnalysisSection(analysisId,'F_decision',{decision:'bloquear_revision',motivo:buildReviewReason(result)});
        finishPhotoAnalysis(analysisId);
        aiS.innerHTML='‚ö†Ô∏è Revisi√≥n necesaria: '+buildReviewReason(result);
        aiS.style.color='#c05621';
        window.__lastAIPhotoAnalysis=result;
        document.getElementById('aiName').value=result.nombre||'';
        setSelected('aiAllergens',allA);
        let warn='';if(result.trazas&&result.trazas.length)warn='Trazas: '+result.trazas.join(', ');if(result.notas)warn+=(warn?' ¬∑ ':'')+result.notas;
        document.getElementById('aiWarn').textContent=warn;
        if(result.nombre){const match=findMatch(result.nombre);aiCurrentMatch=match;if(match){showMatch('aiMatch',match);document.getElementById('aiSave').textContent='Actualizar existente'}else document.getElementById('aiSave').textContent='Guardar producto nuevo'}
        document.getElementById('aiResult').classList.add('show');
        document.getElementById('aiSave').disabled=false;
        updateSave('aiAllergens');
      }
    }else{
      addAnalysisSection(analysisId,'F_decision',{decision:'no_guardar',motivo:'sin_nombre'});
      finishPhotoAnalysis(analysisId);
      showErrorModal('Autom√°tico','No se detect√≥ nombre del producto',dataUrl,ERROR_CODES.PHOTO_NO_NAME);
    }
  }catch(err){
    aiS.innerHTML='Error: '+err.message+' ‚Äî Haz clic para reintentar';
    aiS.style.cursor='pointer';
    aiS.onclick=()=>camInput.click();
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.API_INVALID_RESPONSE,`Auto - Error: ${err.message}`,{});
    const ax=(typeof diagnosticAnalyses!=='undefined'&&diagnosticAnalyses||[]).find(x=>x.analysis_id===analysisId);
    if(ax&&!ax.finished_at){ addAnalysisSection(analysisId,'F_decision',{decision:'error',error:err.message}); finishPhotoAnalysis(analysisId,err); }
  }
}

// ‚îÄ‚îÄ‚îÄ EXPORT EXCEL ‚îÄ‚îÄ‚îÄ
const AL_SORTED=[...AL].sort();
document.getElementById('exportExcelBtn').addEventListener('click',async()=>{
  try{
    if(!window.XLSX){
      const script=document.createElement('script');
      script.src='https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
      document.head.appendChild(script);
      await new Promise((resolve,reject)=>{
        script.onload=resolve;
        script.onerror=reject;
      });
    }
    const header=['Producto',...AL_SORTED];
    const ws_data=[header];
    P.forEach(p=>{
      const row=[p.n];
      AL_SORTED.forEach(al=>{
        row.push(p.a.includes(al)?'X':'');
      });
      ws_data.push(row);
    });
    const ws=XLSX.utils.aoa_to_sheet(ws_data);
    const cols=[{wch:50}];
    AL_SORTED.forEach(()=>cols.push({wch:12}));
    ws['!cols']=cols;
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Al√©rgenos');
    const d=new Date();
    const fname=`alergenos_melia_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.xlsx`;
    
    // Generar el archivo como Blob y descargarlo
    const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
    const blob=new Blob([wbout],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=fname;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Excel exportado correctamente','info');
  }catch(err){
    showToast('Error al exportar: '+err.message,'info');
  }
});

// ‚îÄ‚îÄ‚îÄ IMPORT EXCEL ‚îÄ‚îÄ‚îÄ
const importBtn=document.createElement('button');
importBtn.className='save-btn';
importBtn.textContent='Importar Excel';
importBtn.style.marginTop='8px';
importBtn.style.background='var(--warm8-60)';
document.getElementById('exportExcelBtn').after(importBtn);

const importInput=document.createElement('input');
importInput.type='file';
importInput.accept='.xlsx,.xls';
importInput.style.display='none';
document.body.appendChild(importInput);

importBtn.addEventListener('click',()=>importInput.click());

importInput.addEventListener('change',async(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  try{
    if(!window.XLSX){
      const script=document.createElement('script');
      script.src='https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
      document.head.appendChild(script);
      await new Promise((resolve,reject)=>{ script.onload=resolve; script.onerror=reject; });
    }
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=new Uint8Array(ev.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{header:1});
        if(rows.length<2){showToast('Excel vac√≠o o sin datos','info');return}
        const header=(rows[0]||[]).map(h=>String(h||'').trim());
        const productCol=header.findIndex(h=>norm(h)==='producto');
        if(productCol===-1){showToast('No se encontr√≥ columna "Producto"','info');return}

        let imported=0,updated=0,ignored=0;
        const map = new Map(P.map(p=>[norm(p.n), {n:p.n,a:[...p.a]}]));

        for(let i=1;i<rows.length;i++){
          const row=rows[i]||[];
          const rawName=row[productCol];
          const name=canonicalizeProductName(rawName);
          if(!name){continue;}

          const alergenos=[];
          AL.forEach(al=>{
            const colIdx=header.findIndex(h=>norm(h)===norm(al));
            if(colIdx!==-1){
              const v = String(row[colIdx] ?? '').trim().toLowerCase();
              if(['x','s√≠','si','1','true','ok'].includes(v)) alergenos.push(al);
            }
          });
          const cleanAl = sanitizeAllergenList(alergenos);
          const key = norm(name);

          if(map.has(key)){
            const prev = map.get(key);
            const before = JSON.stringify(prev.a);
            prev.n = name.length > prev.n.length ? name : prev.n;
            prev.a = cleanAl;
            if(JSON.stringify(prev.a)!==before) updated++;
            else ignored++;
          }else{
            map.set(key,{n:name,a:cleanAl});
            imported++;
          }
        }

        P = sanitizeProductList([...map.values()]);
        saveDB();
        render();
        logAuditEvent('import_excel',{ imported, updated, ignored, total_after:P.length, file_name:file.name });
        addLog('IMPORT_EXCEL',{ imported, updated, ignored, total_after:P.length, file:file.name });
        showToast(`Excel importado: ${imported} nuevos, ${updated} actualizados`, 'info');
        closeSettings();
      }catch(innerErr){
        showToast('Error leyendo Excel: '+innerErr.message,'info');
      }
    };
    reader.readAsArrayBuffer(file);
  }catch(err){
    showToast('Error al importar: '+err.message,'info');
  }
  e.target.value='';
});

// ‚îÄ‚îÄ‚îÄ MODO LOTE ‚îÄ‚îÄ‚îÄ
let batchPhotos=[];
const batchInput=document.getElementById('batchInput');
const batchSelectBtn=document.getElementById('batchSelectBtn');
const batchStatus=document.getElementById('batchStatus');
const batchPreview=document.getElementById('batchPreview');

batchSelectBtn.addEventListener('click',()=>batchInput.click());

batchInput.addEventListener('change',async(e)=>{
  const files=Array.from(e.target.files).slice(0,10);
  if(!files.length)return;
  batchPhotos=[];
  batchPreview.innerHTML='';
  batchStatus.innerHTML=`<span class="spinner"></span> Cargando ${files.length} foto${files.length>1?'s':''}‚Ä¶`;
  batchStatus.classList.add('show');
  for(const file of files){
    const reader=new FileReader();
    await new Promise(resolve=>{
      reader.onload=ev=>{
        const dataUrl=ev.target.result;
        batchPhotos.push(dataUrl);
        const div=document.createElement('div');
        div.style.cssText='aspect-ratio:1;background-size:cover;background-position:center;border-radius:var(--radius);border:1px solid var(--warm8-40);position:relative';
        div.style.backgroundImage=`url(${dataUrl})`;
        const removeBtn=document.createElement('button');
        removeBtn.type='button';
        removeBtn.setAttribute('aria-label','Quitar foto');
        removeBtn.innerHTML='√ó';
        removeBtn.style.cssText='position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;border:none;background:rgba(0,0,0,.6);color:#fff;font-size:18px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0';
        removeBtn.onclick=()=>{
          const i=Array.from(batchPreview.children).indexOf(div);
          if(i>=0){ batchPhotos.splice(i,1); div.remove(); updateBatchUIAfterChange(); }
        };
        div.appendChild(removeBtn);
        batchPreview.appendChild(div);
        resolve();
      };
      reader.readAsDataURL(file);
    });
  }
  batchStatus.innerHTML=`${files.length} foto${files.length>1?'s':''} listas`;
  const row=document.createElement('div');
  row.className='batch-actions';
  row.style.cssText='display:flex;gap:10px;flex-wrap:wrap;margin-top:14px';
  const cancelBtn=document.createElement('button');
  cancelBtn.className='save-btn';
  cancelBtn.textContent='Cancelar ¬∑ No procesar';
  cancelBtn.style.cssText='background:var(--warm8-20);color:var(--text);flex:1;min-width:120px';
  cancelBtn.onclick=cancelBatchAndReturnToAdd;
  const processBtn=document.createElement('button');
  processBtn.className='save-btn';
  processBtn.textContent='Procesar todas autom√°ticamente';
  processBtn.style.cssText='flex:1;min-width:120px';
  processBtn.onclick=()=>processBatch();
  row.appendChild(cancelBtn);
  row.appendChild(processBtn);
  const oldRow=batchStatus.nextElementSibling;
  if(oldRow&&oldRow.classList.contains('batch-actions'))oldRow.remove();
  batchStatus.after(row);
  e.target.value='';
});

function clearBatchPhotos(){
  batchPhotos=[];
  batchPreview.innerHTML='';
  batchStatus.innerHTML='';
  batchStatus.classList.remove('show');
  const row=batchStatus.nextElementSibling;
  if(row&&row.classList.contains('batch-actions'))row.remove();
}
if(typeof window!=='undefined')window.clearBatchPhotos=clearBatchPhotos;

function cancelBatchAndReturnToAdd(){
  clearBatchPhotos();
  document.querySelectorAll('.method-btn').forEach(b=>b.classList.toggle('active',b.dataset.method==='manual'));
  document.getElementById('secManual').classList.add('show');
  document.getElementById('secCamera').classList.remove('show');
  document.getElementById('secBatch').classList.remove('show');
}

function updateBatchUIAfterChange(){
  const n=batchPhotos.length;
  if(n===0){
    clearBatchPhotos();
    return;
  }
  batchStatus.innerHTML=`${n} foto${n!==1?'s':''} lista${n!==1?'s':''}`;
}

async function processBatch(){
  if(!getApiKey()){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Lote no iniciado: falta API Key Gemini',{service:'Gemini',operation:'processBatch'});
    showToast('Configura la clave API en Ajustes (‚öô)','info');
    return;
  }
  batchStatus.innerHTML=`<span class="spinner"></span> Procesando 0/${batchPhotos.length}‚Ä¶`;
  let processed=0,successes=[],failures=[],pendingReview=[];
  const photoResults=[];
  
  for(let i=0;i<batchPhotos.length;i++){
    const dataUrl=batchPhotos[i];
    const { content, metadata }=await buildPhotoRequest([dataUrl]);
    const { analysisId }=startPhotoAnalysis('lote',1,metadata);
    addAnalysisSection(analysisId,'B_input',{ dimensions: metadata.dimensions });
    let errorOccurred=false;
    let errorMsg='';
    let errorCode='';
    let productName='';

    try{
      const resp=await apiCall(content,{ systemInstruction: metadata.systemPrompt || AI_PROMPT });
      if(!resp.ok){
        if(resp.status===401){
          errorCode=ERROR_CODES.API_AUTH_FAILED;
          errorMsg='Clave API inv√°lida o expirada';
        }else if(resp.status===429){
          errorCode=ERROR_CODES.API_RATE_LIMIT;
          errorMsg='L√≠mite de llamadas alcanzado';
        }else if(resp.status>=500){
          errorCode=ERROR_CODES.API_SERVER_ERROR;
          errorMsg=`Error del servidor Gemini (${resp.status})`;
        }else{
          errorCode=ERROR_CODES.API_INVALID_RESPONSE;
          errorMsg=`Error HTTP ${resp.status}`;
        }
        addAnalysisSection(analysisId,'F_decision',{decision:'error',error:errorMsg});
        finishPhotoAnalysis(analysisId,new Error(errorMsg));
        throw new Error(errorMsg);
      }

      const data=await resp.json();
      const text=data.choices?.[0]?.message?.content||'';
      const possibleTruncated=String(text).length>=2990;
      addAnalysisSection(analysisId,'C_raw_output',{ raw_text: String(text).slice(0,5000), length: text.length, markdown_like: /```/.test(text), possible_truncated: possibleTruncated });
      let result;
      try{
        result=parseAndValidateAI(text,'lote');
      }catch(e){
        errorCode=ERROR_CODES.JSON_PARSE_ERROR;
        errorMsg='Respuesta de IA no v√°lida';
        addAnalysisSection(analysisId,'F_decision',{decision:'error',error:errorMsg});
        finishPhotoAnalysis(analysisId,e);
        throw new Error(errorMsg);
      }

      addAnalysisSection(analysisId,'D_interpretation',{ nombre: result.nombre, alergenos: result.alergenos||[], trazas: result.trazas||[], normalizado_app: { alergenos: result.alergenos||[], trazas: result.trazas||[] } });
      addAnalysisSection(analysisId,'E_validations',{ review_alerts: result.review_alerts||null, requires_review: !!result.requires_review });

      if(result.nombre){
        result.nombre=autoCorrectName(result.nombre);
        productName=result.nombre;
      }else{
        errorCode=ERROR_CODES.PHOTO_NO_NAME;
        errorMsg='No se detect√≥ nombre del producto';
        addAnalysisSection(analysisId,'F_decision',{decision:'no_guardar',motivo:'sin_nombre'});
        finishPhotoAnalysis(analysisId);
        throw new Error(errorMsg);
      }

      const allA=sortAllergens([...new Set([...(result.alergenos||[]),...(result.trazas||[])])].filter(a=>AL.includes(a)));

      if(result.warning){
        addLog(LOG_LEVELS.WARN,ERROR_CODES.PHOTO_QUALITY,`Calidad de foto: ${productName}`,{warning:result.warning});
      }

      if(isAutoOk(result)){
        const match=findMatch(result.nombre);
        const ts=new Date().toISOString();
        if(match){
          const r=mergeProduct(match.index,result.nombre,allA,{analysisId,analysisTimestamp:ts});
          addAnalysisSection(analysisId,'F_decision',{decision:'actualizar',motivo:'lote_auto',product_name:result.nombre});
          addAnalysisSection(analysisId,'G_saved_result',{product_index:match.index,product_name:result.nombre,alergenos:P[match.index].a,timestamp:ts,declarable:true});
          finishPhotoAnalysis(analysisId);
          if(r.added.length){
            successes.push(`${match.product.n} ‚Äî +${r.added.join(', ')} ¬∑ actualizado`);
          }else{
            successes.push(`${match.product.n} ‚Äî ${allA.length?allA.join(', ')+' ¬∑ ':''}verificado`);
          }
        }else{
          addNewProduct(result.nombre,allA,{analysisId,analysisTimestamp:ts});
          const idx=P.findIndex(x=>norm(x.n)===norm(result.nombre));
          if(idx>=0){
            addAnalysisSection(analysisId,'F_decision',{decision:'crear',motivo:'lote_auto',product_name:result.nombre});
            addAnalysisSection(analysisId,'G_saved_result',{product_index:idx,product_name:result.nombre,alergenos:P[idx].a,timestamp:ts,declarable:true});
            finishPhotoAnalysis(analysisId);
          }
          successes.push(`${result.nombre} ‚Äî ${allA.length?allA.join(', ')+' ¬∑ ':''}a√±adido`);
        }
        addLog(LOG_LEVELS.INFO,'PRODUCT_SAVED',`Producto guardado: ${result.nombre}`,{allergens:allA.length});
      }else{
        addAnalysisSection(analysisId,'F_decision',{decision:'bloquear_revision',motivo:buildReviewReason(result)});
        finishPhotoAnalysis(analysisId);
        pendingReview.push({
          result,
          allA,
          dataUrl,
          reason:buildReviewReason(result)
        });
        addLog(LOG_LEVELS.INFO,'BATCH_PENDING_REVIEW',`Pendiente de revisi√≥n: ${result.nombre}`,{reason:buildReviewReason(result)});
      }

    }catch(err){
      errorOccurred=true;
      if(!errorMsg)errorMsg=err.message||'Error desconocido';
      if(!errorCode)errorCode=ERROR_CODES.API_INVALID_RESPONSE;
      const ax=(typeof diagnosticAnalyses!=='undefined'&&diagnosticAnalyses||[]).find(x=>x.analysis_id===analysisId);
      if(ax&&!ax.finished_at){ addAnalysisSection(analysisId,'F_decision',{decision:'error',error:errorMsg}); finishPhotoAnalysis(analysisId,err); }

      failures.push({
        name:productName||'No detectado',
        reason:errorMsg,
        photo:dataUrl
      });

      addLog(LOG_LEVELS.ERROR,errorCode,`Error en lote: ${productName||'Foto #'+(i+1)}`,{error:errorMsg});
    }
    
    processed++;
    batchStatus.innerHTML=`<span class="spinner"></span> Procesando ${processed}/${batchPhotos.length}‚Ä¶`;
    await new Promise(r=>setTimeout(r,800));
  }
  
  render();
  updateAppStatus();
  
  showBatchSummary(batchPhotos.length,successes,failures,pendingReview);
  
  batchPhotos=[];
  batchPreview.innerHTML='';
}

// Modificar m√©todo de tabs para incluir batch
document.querySelectorAll('.method-btn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.method-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const m=b.dataset.method;
  document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('show'));
  if(m==='manual'){document.getElementById('secManual').classList.add('show');autoMode=false;btnAutoFlow.style.display=''}
  else if(m==='camera'){document.getElementById('secCamera').classList.add('show');autoMode=false;btnAutoFlow.style.display=''}
  else if(m==='batch'){document.getElementById('secBatch').classList.add('show');autoMode=false;btnAutoFlow.style.display='none'}
}));

// ‚îÄ‚îÄ‚îÄ GOOGLE DRIVE SYNC ‚îÄ‚îÄ‚îÄ
// Claves: Client ID por defecto = OAuth del proyecto APP ALERGENOS (fenixsn369). API Key se introduce en Ajustes.
function getGdriveConfig(){
  return {
    clientId: (localStorage.getItem('gdrive_client_id')||'929480709549-uqrrp0qb3l12tkp3j5eodkfnnfb1jjv5.apps.googleusercontent.com').trim(),
    apiKey: (localStorage.getItem('gdrive_api_key')||'').trim(),
    scopes:'https://www.googleapis.com/auth/drive.file',
    folderName:'BaseDatos_Israel_NoEliminar_Sincronizacion',
    fileName:'productos.json'
  };
}
const GDRIVE_CONFIG = { get clientId(){ return getGdriveConfig().clientId; }, get apiKey(){ return getGdriveConfig().apiKey; }, get scopes(){ return getGdriveConfig().scopes; }, get folderName(){ return getGdriveConfig().folderName; }, get fileName(){ return getGdriveConfig().fileName; } };

let gdriveToken=localStorage.getItem('gdrive_token');
let gdriveFolderId=localStorage.getItem('gdrive_folder_id');
let gdriveFileId=localStorage.getItem('gdrive_file_id');
let syncInProgress=false;
let gapiLoaded=false;
let gisLoaded=false;
let tokenClient;

// Cargar Google APIs
function loadGoogleAPIs(){
  if(gapiLoaded&&gisLoaded)return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const script1=document.createElement('script');
    script1.src='https://apis.google.com/js/api.js';
    script1.onload=()=>{
      gapi.load('client',()=>{
        gapi.client.init({
          apiKey:GDRIVE_CONFIG.apiKey
        }).then(()=>{
          return gapi.client.load('drive','v3');
        }).then(()=>{
          gapiLoaded=true;
          if(gisLoaded)resolve();
        }).catch((err)=>{
          console.error('Error loading Drive API:',err);
          addLog(LOG_LEVELS.ERROR,'GDRIVE_API_LOAD_FAILED','Error cargando SDK de Google Drive',{
            service:'Google Drive',
            operation:'loadGoogleAPIs',
            error:err&&err.message?err.message:String(err),
            probable_cause:'Client ID/API Key invalidos, API de Drive deshabilitada o bloqueo de red.'
          });
          showToast('Error cargando Google Drive API','info');
          reject(err);
        });
      });
    };
    script1.onerror=(e)=>{
      addLog(LOG_LEVELS.ERROR,'GDRIVE_SCRIPT_LOAD_FAILED','No se pudo cargar https://apis.google.com/js/api.js',{
        service:'Google Drive',
        operation:'loadGoogleAPIs',
        error:e&&e.message?e.message:'script_onerror',
        probable_cause:'Bloqueo de red, adblock, CSP o fallo temporal de Google.'
      });
      reject(new Error('No se pudo cargar api.js'));
    };
    document.head.appendChild(script1);
    
    const script2=document.createElement('script');
    script2.src='https://accounts.google.com/gsi/client';
    script2.onload=()=>{
      tokenClient=google.accounts.oauth2.initTokenClient({
        client_id:GDRIVE_CONFIG.clientId,
        scope:GDRIVE_CONFIG.scopes,
        callback:(response)=>{
          if(response.access_token){
            gdriveToken=response.access_token;
            localStorage.setItem('gdrive_token',gdriveToken);
            gapi.client.setToken({access_token:gdriveToken});
            showToast('Google Drive conectado','info');
            updateGDriveUI();
            setTimeout(()=>gdriveSmartSync('startup'),1000);
          }else if(response && (response.error || response.error_description)){
            addLog(LOG_LEVELS.ERROR,ERROR_CODES.GDRIVE_AUTH_FAILED,'OAuth de Google Drive rechazado',{
              service:'Google Drive',
              operation:'oauth_token_callback',
              error:response.error||'oauth_error',
              provider_message:response.error_description||null
            });
          }
        }
      });
      gisLoaded=true;
      if(gapiLoaded)resolve();
    };
    script2.onerror=(e)=>{
      addLog(LOG_LEVELS.ERROR,'GDRIVE_GIS_LOAD_FAILED','No se pudo cargar https://accounts.google.com/gsi/client',{
        service:'Google Drive',
        operation:'loadGoogleAPIs',
        error:e&&e.message?e.message:'script_onerror',
        probable_cause:'Bloqueo de red, adblock, CSP o fallo temporal de Google.'
      });
      reject(new Error('No se pudo cargar gsi/client'));
    };
    document.head.appendChild(script2);
  });
}

function updateGDriveUI(){
  const connectBtn=document.getElementById('gdriveConnectBtn');
  const disconnectBtn=document.getElementById('gdriveDisconnectBtn');
  const syncManualBtn=document.getElementById('gdriveSyncManualBtn');
  const statusRow=document.getElementById('gdriveStatus');
  const statusText=document.getElementById('gdriveStatusText');
  const lastSyncDiv=document.getElementById('gdriveLastSync');
  const syncStatusPanel=document.getElementById('syncStatusPanel');
  
  if(gdriveToken){
    connectBtn.style.display='none';
    disconnectBtn.style.display='block';
    if(syncManualBtn)syncManualBtn.style.display='block';
    statusRow.style.display='flex';
    statusText.textContent='‚úì Conectado';
    statusText.style.color='var(--green,#2e7d32)';
    const lastSync=localStorage.getItem('gdrive_last_sync');
    if(lastSync){
      const d=new Date(parseInt(lastSync));
      lastSyncDiv.textContent='√öltima sincronizaci√≥n: '+d.toLocaleString('es-ES');
      lastSyncDiv.style.display='block';
    }
    if(syncStatusPanel) syncStatusPanel.style.display='block';
  }else{
    connectBtn.style.display='block';
    disconnectBtn.style.display='none';
    if(syncManualBtn)syncManualBtn.style.display='none';
    statusRow.style.display='none';
    lastSyncDiv.style.display='none';
    if(syncStatusPanel) syncStatusPanel.style.display='none';
  }
  updateSyncStatusUI();
}

document.getElementById('gdriveConnectBtn').addEventListener('click',async()=>{
  const cfg=getGdriveConfig();
  if(!cfg.clientId||!cfg.apiKey){
    addLog(LOG_LEVELS.ERROR,ERROR_CODES.CONFIG_MISSING,'Google Drive sin configurar (Client ID/API Key)',{
      service:'Google Drive',
      operation:'connect',
      client_id_configured:!!cfg.clientId,
      api_key_configured:!!cfg.apiKey
    });
    showToast('Configura Client ID y API Key de Google en Ajustes','info');
    return;
  }
  try{
    await loadGoogleAPIs();
  }catch(err){
    addLog(LOG_LEVELS.ERROR,'GDRIVE_CONNECT_PRECHECK_FAILED','No se pudo inicializar Google Drive antes de conectar',{
      service:'Google Drive',
      operation:'connect',
      error:err&&err.message?err.message:String(err)
    });
    showToast('Error cargando servicios de Google. Revisa red/configuraci√≥n.','info');
    return;
  }
  tokenClient=google.accounts.oauth2.initTokenClient({
    client_id:cfg.clientId,
    scope:cfg.scopes,
    callback:(response)=>{
      if(response.access_token){
        gdriveToken=response.access_token;
        localStorage.setItem('gdrive_token',gdriveToken);
        gapi.client.setToken({access_token:gdriveToken});
        showToast('Google Drive conectado','info');
        updateGDriveUI();
        setTimeout(()=>gdriveSmartSync('startup'),1000);
      }else if(response && (response.error || response.error_description)){
        addLog(LOG_LEVELS.ERROR,ERROR_CODES.GDRIVE_AUTH_FAILED,'No se pudo autorizar Google Drive',{
          service:'Google Drive',
          operation:'connect_oauth',
          error:response.error||'oauth_error',
          provider_message:response.error_description||null
        });
        showToast('Autorizaci√≥n de Google Drive cancelada o rechazada','info');
      }
    }
  });
  tokenClient.requestAccessToken();
});

document.getElementById('gdriveConfigSave').addEventListener('click',()=>{
  const cid=(document.getElementById('gdriveClientIdInput').value||'').trim();
  const rawAk=document.getElementById('gdriveApiKeyInput').value;
  const ak=normalizeApiKey(rawAk);
  if(cid)localStorage.setItem('gdrive_client_id',cid); else localStorage.removeItem('gdrive_client_id');
  if(ak){localStorage.setItem('gdrive_api_key',ak);document.getElementById('gdriveApiKeyInput').value=ak;} else localStorage.removeItem('gdrive_api_key');
  showToast('Configuraci√≥n Google guardada','info');
});

document.getElementById('gdriveDisconnectBtn').addEventListener('click',()=>{
  if(confirm('¬øDesconectar Google Drive? Los datos locales se mantendr√°n.')){
    localStorage.removeItem('gdrive_token');
    localStorage.removeItem('gdrive_folder_id');
    localStorage.removeItem('gdrive_file_id');
    localStorage.removeItem('gdrive_last_sync');
    gdriveToken=null;
    gdriveFolderId=null;
    gdriveFileId=null;
    if(gapiLoaded)gapi.client.setToken(null);
    updateGDriveUI();
    showToast('Google Drive desconectado','info');
  }
});

// SINCRONIZACI√ìN MANUAL CON FEEDBACK VISUAL
document.getElementById('gdriveSyncManualBtn').addEventListener('click',async()=>{
  const btn=document.getElementById('gdriveSyncManualBtn');
  const status=document.getElementById('syncManualStatus');
  
  btn.disabled=true;
  btn.innerHTML='<span class="spinner"></span> Sincronizando...';
  if(status) { status.style.display='block'; status.innerHTML='üîÑ Comparando con Drive...'; }
  
  try{
    await gdriveSmartSync('manual');
    if(status) {
      status.innerHTML='‚úÖ Sincronizaci√≥n completada';
      status.style.background='var(--green-10,#e8f5e9)';
      status.style.color='var(--green,#2e7d32)';
    }
    btn.innerHTML='‚úì Sincronizado';
    
    setTimeout(()=>{
      btn.disabled=false;
      btn.innerHTML='üîÑ Sincronizar ahora';
      if(status) status.style.display='none';
    },2000);
    
  }catch(err){
    console.error('[SYNC] Error:',err);
    if(status) { status.innerHTML='‚ùå Error: '+err.message; status.style.background='rgba(180,0,0,0.1)'; status.style.color='red'; }
    btn.disabled=false;
    btn.innerHTML='üîÑ Reintentar';
    addLog('SYNC_ERROR',{
      trigger:'manual',
      error:err.message,
      status: err && err.status ? err.status : null,
      probable_cause: classifyHttpFailure((err&&err.status)||0, (err&&err.message)||'')
    });
  }
});

// ============================================================
// SYNC INTELIGENTE: siempre compara antes de actuar
// ============================================================

async function gdriveConsolidateProductosJson(folderId) {
  const response = await gapi.client.drive.files.list({
    q: `name='${GDRIVE_CONFIG.fileName}' and '${folderId}' in parents and trashed=false`,
    fields: 'files(id,name,modifiedTime,ownedByMe,capabilities(canEdit))',
    spaces: 'drive',
    orderBy: 'modifiedTime desc',
    pageSize: 50
  });

  const files = (response.result && response.result.files) ? response.result.files : [];
  if(files.length === 0) return { found:false, selected:null, all:[], valid:[] };

  const inspected = [];
  for(const f of files){
    let parsed = null, valid = false, count = 0, ts = 0, readError = null;
    try{
      const r = await gapi.client.drive.files.get({ fileId: f.id, alt:'media' });
      parsed = r.result;
      valid = !!(parsed && Array.isArray(parsed.products));
      count = valid ? parsed.products.length : 0;
      ts = valid ? parseInt(parsed.lastUpdate || 0) : 0;
    }catch(e){
      readError = e && (e.message || String(e));
    }
    inspected.push({ ...f, valid, count, ts, parsed, readError });
  }

  const sortable = inspected.slice().sort((a,b)=>{
    const scoreA = (a.valid?1:0);
    const scoreB = (b.valid?1:0);
    if(scoreB !== scoreA) return scoreB-scoreA;
    if((b.ts||0)!==(a.ts||0)) return (b.ts||0)-(a.ts||0);
    const ma = a.modifiedTime ? new Date(a.modifiedTime).getTime() : 0;
    const mb = b.modifiedTime ? new Date(b.modifiedTime).getTime() : 0;
    if(mb!==ma) return mb-ma;
    const ea = (a.ownedByMe || (a.capabilities && a.capabilities.canEdit)) ? 1 : 0;
    const eb = (b.ownedByMe || (b.capabilities && b.capabilities.canEdit)) ? 1 : 0;
    return eb-ea;
  });

  const selected = sortable[0];
  const duplicateCount = Math.max(0, inspected.length - 1);

  if(selected){
    addLog('SYNC_REMOTE_FILE_SELECTED', {
      remote_file_id: selected.id,
      remote_file_name: selected.name || GDRIVE_CONFIG.fileName,
      duplicate_candidates: inspected.length,
      selected_modified_time: selected.modifiedTime || null,
      selected_valid: !!selected.valid,
      selected_count: selected.count || 0,
      selected_ts: selected.ts || 0
    });
  }

  // Consolidaci√≥n autom√°tica: enviar a papelera duplicados editables.
  // Solo si el seleccionado es v√°lido; as√≠ no destruimos nada si todo est√° corrupto.
  let trashed = 0;
  let trashErrors = 0;
  if(selected && selected.valid && duplicateCount > 0){
    for(const f of inspected){
      if(f.id === selected.id) continue;
      const canEdit = !!(f.ownedByMe || (f.capabilities && f.capabilities.canEdit));
      if(!canEdit) continue;
      try{
        await gapi.client.drive.files.update({ fileId: f.id, resource: { trashed: true } });
        trashed++;
      }catch(e){
        trashErrors++;
      }
    }
    if(trashed || trashErrors){
      addLog('SYNC_REMOTE_FILE_CONSOLIDATED', {
        selected_file_id: selected.id,
        detected_files: inspected.length,
        trashed_duplicates: trashed,
        trash_errors: trashErrors
      });
    }
  }

  return {
    found: true,
    selected,
    all: inspected,
    valid: inspected.filter(x=>x.valid),
    products: selected && selected.valid ? selected.parsed.products : null,
    remoteLastUpdate: selected && selected.valid ? (parseInt(selected.ts||0)) : 0,
    remoteCount: selected && selected.valid ? (selected.count||0) : 0
  };
}

async function gdriveReadRemoteState() {
  // Lee estado remoto sin aplicarlo. Devuelve { found, fileId, remoteCount, remoteLastUpdate, products }
  const folderId = await gdriveFindOrCreateFolder();
  const consolidated = await gdriveConsolidateProductosJson(folderId);

  if(!consolidated.found || !consolidated.selected) {
    return { found: false, fileId: null, remoteCount: 0, remoteLastUpdate: 0, products: null };
  }

  const fileId = consolidated.selected.id;
  gdriveFileId = fileId;
  localStorage.setItem('gdrive_file_id', fileId);
  localStorage.setItem('remote_file_id', fileId);

  if(!consolidated.products) {
    return { found: true, fileId, remoteCount: 0, remoteLastUpdate: 0, products: null };
  }

  const remoteLastUpdate = consolidated.remoteLastUpdate || 0;
  const remoteCount = consolidated.remoteCount || 0;

  // Guardar estado remoto para mostrar en UI
  localStorage.setItem('remote_last_count', remoteCount.toString());
  localStorage.setItem('remote_last_update_read', remoteLastUpdate.toString());

  return { found: true, fileId, remoteCount, remoteLastUpdate, products: consolidated.products };
}

async function gdriveSmartSync(trigger = 'manual') {
  if(!gdriveToken || syncInProgress) return;
  syncInProgress = true;

  const session = createSyncSession(trigger);
  addLog('SYNC_STARTED', {
    sync_session_id: session.sync_session_id,
    trigger,
    local_count: session.local_count_before,
    local_last_update: session.local_last_update_before
  });

  try {
    await loadGoogleAPIs();
    gapi.client.setToken({ access_token: gdriveToken });

    // PASO 1: leer estado local
    const localLastUpdate = parseInt(localStorage.getItem('local_last_update') || '0');
    const localCount = P ? P.length : 0;

    // PASO 2: leer estado remoto sin aplicar
    let remoteState;
    try {
      remoteState = await gdriveReadRemoteState();
    } catch(err) {
      addLog('SYNC_ERROR', {
        sync_session_id: session.sync_session_id,
        trigger,
        reason: 'Error leyendo remoto',
        error: err.message,
        status: err && err.status ? err.status : null,
        probable_cause: classifyHttpFailure((err&&err.status)||0, (err&&err.message)||'')
      });
      finishSyncSession(session, 'error', 'error', 'Error leyendo estado remoto: ' + err.message, err.message);
      showToast('Error al leer Google Drive', 'info');
      return;
    }

    session.remote_count_before = remoteState.remoteCount;
    session.remote_last_update_before = remoteState.remoteLastUpdate ? new Date(remoteState.remoteLastUpdate).toISOString() : null;

    addLog(remoteState.found ? 'SYNC_REMOTE_FILE_FOUND' : 'SYNC_REMOTE_FILE_NOT_FOUND', {
      sync_session_id: session.sync_session_id,
      trigger,
      remote_count: remoteState.remoteCount,
      remote_last_update: remoteState.remoteLastUpdate
    });

    // PASO 3: comparar y decidir
    let decision;
    let reason;

    if(!remoteState.found || !remoteState.products) {
      decision = 'upload';
      reason = 'No existe archivo remoto';
    } else if(remoteState.remoteLastUpdate > localLastUpdate) {
      // Protecci√≥n: no sobrescribir m√°s datos locales con menos datos remotos (evitar p√©rdida de registros)
      if(remoteState.remoteCount < localCount) {
        decision = 'upload';
        reason = `Remoto m√°s nuevo pero tiene menos productos (${remoteState.remoteCount}) que local (${localCount}). Se sube local para no perder registros.`;
      } else {
        decision = 'download';
        reason = `Remoto m√°s nuevo: ${new Date(remoteState.remoteLastUpdate).toLocaleString('es-ES')} vs local: ${new Date(localLastUpdate).toLocaleString('es-ES')}`;
      }
    } else if(localLastUpdate > remoteState.remoteLastUpdate) {
      decision = 'upload';
      reason = `Local m√°s nuevo: ${new Date(localLastUpdate).toLocaleString('es-ES')} vs remoto: ${new Date(remoteState.remoteLastUpdate).toLocaleString('es-ES')}`;
    } else {
      decision = 'none';
      reason = 'Mismo timestamp. Sin cambios.';
    }

    addLog('SYNC_COMPARE', {
      sync_session_id: session.sync_session_id,
      trigger,
      local_count: localCount,
      remote_count: remoteState.remoteCount,
      local_last_update: localLastUpdate,
      remote_last_update: remoteState.remoteLastUpdate,
      decision,
      reason
    });

    // PASO 4: aplicar
    if(decision === 'upload') {
      const uploadMeta = await gdriveUpload();
      let verifyState = null;
      let verified = false;
      let verifyError = null;

      for(let attempt = 1; attempt <= 3; attempt++) {
        try {
          if(attempt > 1) await new Promise(r => setTimeout(r, 500 * attempt));
          verifyState = await gdriveReadRemoteState();
          const sameFile = !!(uploadMeta && uploadMeta.fileId && verifyState && verifyState.fileId === uploadMeta.fileId);
          const sameCount = !!(verifyState && verifyState.remoteCount === localCount);
          const remoteTs = parseInt(verifyState && verifyState.remoteLastUpdate || 0);
          const uploadTs = parseInt(uploadMeta && uploadMeta.uploadedTs || 0);
          const tsOk = remoteTs >= uploadTs;
          addLog('SYNC_UPLOAD_VERIFY_ATTEMPT', {
            sync_session_id: session.sync_session_id,
            trigger,
            attempt,
            expected_file_id: uploadMeta ? uploadMeta.fileId : null,
            remote_file_id: verifyState ? verifyState.fileId : null,
            expected_count: localCount,
            remote_count: verifyState ? verifyState.remoteCount : null,
            expected_ts: uploadTs,
            remote_ts: remoteTs,
            same_file: sameFile,
            same_count: sameCount,
            ts_ok: tsOk
          });
          if(sameFile && sameCount && tsOk) {
            verified = true;
            break;
          }
        } catch(verr) {
          verifyError = verr;
          addLog('SYNC_UPLOAD_VERIFY_ERROR', {
            sync_session_id: session.sync_session_id,
            trigger,
            attempt,
            error: verr.message
          });
        }
      }

      if(!verified) {
        const msg = 'Upload no verificado: el remoto no coincide tras subir';
        pendingChanges = true;
        localStorage.setItem('pending_changes','1');
        session.remote_count_after = verifyState ? verifyState.remoteCount : null;
        session.remote_last_update_before = session.remote_last_update_before || null;
        addLog('SYNC_UPLOAD_VERIFY_FAILED', {
          sync_session_id: session.sync_session_id,
          trigger,
          expected_count: localCount,
          remote_count_after: verifyState ? verifyState.remoteCount : null,
          expected_file_id: uploadMeta ? uploadMeta.fileId : null,
          remote_file_id: verifyState ? verifyState.fileId : null,
          verify_error: verifyError ? verifyError.message : null
        });
        localStorage.setItem('last_sync_decision', 'upload_unverified');
        showToast('‚ö† Subida no confirmada. Revisa historial de sync.', 'info');
        finishSyncSession(session, 'upload', 'error', msg, msg);
      } else {
        pendingChanges = false;
        localStorage.setItem('pending_changes','0');
        session.remote_count_after = verifyState.remoteCount;
        session.remote_last_update_before = session.remote_last_update_before || null;
        addLog('SYNC_UPLOAD_APPLIED', {
          sync_session_id: session.sync_session_id,
          trigger,
          local_count: localCount,
          reason,
          remote_file_id: verifyState.fileId,
          remote_count_after: verifyState.remoteCount,
          remote_last_update_after: verifyState.remoteLastUpdate
        });
        showToast('‚úì Datos subidos a Google Drive', 'info');
        finishSyncSession(session, 'upload', 'ok', `Subido y verificado: ${localCount} productos`);
      }

    } else if(decision === 'download') {
      P = sanitizeProductList(remoteState.products);
      saveDB({ skipAutoSync: true });
      render();
      pendingChanges = false;
      localStorage.setItem('pending_changes','0');
      addLog('SYNC_DOWNLOAD_APPLIED', { sync_session_id: session.sync_session_id, trigger, remote_count: remoteState.remoteCount, reason });
      showToast(`‚úì Descargado desde Drive: ${remoteState.remoteCount} productos`, 'info');
      session.remote_count_after = remoteState.remoteCount;
      finishSyncSession(session, 'download', 'ok', `Descargado: ${remoteState.remoteCount} productos`);

    } else {
      addLog('SYNC_NO_CHANGES', { sync_session_id: session.sync_session_id, trigger, reason });
      if(trigger === 'manual') showToast('‚úì Sin cambios. Todo actualizado.', 'info');
      pendingChanges = false;
      localStorage.setItem('pending_changes','0');
      finishSyncSession(session, 'none', 'ok', 'Sin cambios necesarios');
    }

    if(!(decision === 'upload' && session.status === 'error')) {
      localStorage.setItem('last_sync_decision', decision);
    }
    localStorage.setItem('gdrive_last_sync', Date.now().toString());
    updateGDriveUI();

  } catch(err) {
    console.error('Error sync:', err);
    addLog('SYNC_ERROR', {
      sync_session_id: session.sync_session_id,
      trigger,
      error: err.message,
      status: err && err.status ? err.status : null,
      probable_cause: classifyHttpFailure((err&&err.status)||0, (err&&err.message)||'')
    });
    finishSyncSession(session, 'error', 'error', 'Error: ' + err.message, err.message);
    if(err.status === 401 || err.status === 403) {
      localStorage.removeItem('gdrive_token');
      gdriveToken = null;
      updateGDriveUI();
      showToast('Sesi√≥n Google Drive expirada. Reconecta.', 'info');
    } else {
      showToast('Error sincronizando: ' + err.message, 'info');
    }
  } finally {
    syncInProgress = false;
    updateSyncStatusUI();
  }
}

// Mantener gdriveSync como alias para compatibilidad interna
async function gdriveSync(direction = 'both') {
  return gdriveSmartSync('manual');
}

async function gdriveFindOrCreateFolder(){
  // Auto-healing: validar cach√© antes de reutilizarla
  if(gdriveFolderId){
    try{
      const check = await gapi.client.drive.files.get({
        fileId: gdriveFolderId,
        fields: 'id,trashed,ownedByMe,capabilities(canEdit)'
      });
      const ok = check?.result && !check.result.trashed && (check.result.ownedByMe || (check.result.capabilities && check.result.capabilities.canEdit));
      if(ok) return gdriveFolderId;
    }catch(_e){}
    gdriveFolderId = null;
    localStorage.removeItem('gdrive_folder_id');
  }

  const response=await gapi.client.drive.files.list({
    q:`name='${GDRIVE_CONFIG.folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
    fields:'files(id,name,modifiedTime,ownedByMe,capabilities(canEdit))',
    spaces:'drive',
    orderBy:'modifiedTime desc',
    pageSize:20
  });

  if(response.result.files&&response.result.files.length>0){
    const folders = response.result.files;
    const selected = folders.find(f => f.ownedByMe && f.capabilities && f.capabilities.canEdit) ||
                     folders.find(f => f.capabilities && f.capabilities.canEdit) ||
                     folders[0];
    gdriveFolderId=selected.id;
    localStorage.setItem('gdrive_folder_id',gdriveFolderId);
    return gdriveFolderId;
  }

  const folder=await gapi.client.drive.files.create({
    resource:{
      name:GDRIVE_CONFIG.folderName,
      mimeType:'application/vnd.google-apps.folder'
    },
    fields:'id'
  });

  gdriveFolderId=folder.result.id;
  localStorage.setItem('gdrive_folder_id',gdriveFolderId);
  return gdriveFolderId;
}

async function gdriveUpload(){
  const folderId=await gdriveFindOrCreateFolder();
  P = sanitizeProductList(P);
  const nowTs = Date.now();
  const data={products:P,version:'1.0',lastUpdate:nowTs};
  const content=JSON.stringify(data,null,2);

  const boundary='-------314159265358979323846';
  const delimiter="\r\n--"+boundary+"\r\n";
  const close_delim="\r\n--"+boundary+"--";

  const metadata={
    name:GDRIVE_CONFIG.fileName,
    mimeType:'application/json',
    parents:[folderId]
  };

  const multipartRequestBody=
    delimiter+
    'Content-Type: application/json\r\n\r\n'+
    JSON.stringify(metadata)+
    delimiter+
    'Content-Type: application/json\r\n\r\n'+
    content+
    close_delim;

  async function patchFile(targetFileId){
    const upResp = await fetchWithDiagnostics(`https://www.googleapis.com/upload/drive/v3/files/${targetFileId}?uploadType=multipart`,{
      method:'PATCH',
      headers:{
        'Authorization':`Bearer ${gdriveToken}`,
        'Content-Type':`multipart/related; boundary="${boundary}"`
      },
      body:multipartRequestBody
    },{
      service:'Google Drive',
      operation:'subida PATCH productos.json',
      requestTag:'gdriveUpload_patch',
      requireOnline:true
    });
    if(!upResp.ok){
      const bodyText = await upResp.text().catch(()=> '');
      const err = new Error('Upload Drive fall√≥ ('+upResp.status+')');
      err.status = upResp.status;
      err.responseText = bodyText;
      throw err;
    }
    return true;
  }

  async function createFile(){
    const resp=await fetchWithDiagnostics('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{
      method:'POST',
      headers:{
        'Authorization':`Bearer ${gdriveToken}`,
        'Content-Type':`multipart/related; boundary="${boundary}"`
      },
      body:multipartRequestBody
    },{
      service:'Google Drive',
      operation:'creacion archivo productos.json',
      requestTag:'gdriveUpload_create',
      requireOnline:true
    });
    if(!resp.ok){
      const bodyText = await resp.text().catch(()=> '');
      const err = new Error('Creaci√≥n archivo Drive fall√≥ ('+resp.status+')');
      err.status = resp.status;
      err.responseText = bodyText;
      throw err;
    }
    const result=await resp.json();
    return result.id;
  }

  if(gdriveFileId){
    localStorage.setItem('remote_file_id',gdriveFileId);
    try{
      await patchFile(gdriveFileId);
    }catch(e){
      if(e.status===403 || e.status===404){
        addLog('SYNC_UPLOAD_RECOVER_STALE_FILE', { cached_file_id: gdriveFileId, status: e.status, message: e.message });
        gdriveFileId = null;
        localStorage.removeItem('gdrive_file_id');
        localStorage.removeItem('remote_file_id');
      }else{
        throw e;
      }
    }
  }

  if(!gdriveFileId){
    const consolidated = await gdriveConsolidateProductosJson(folderId);

    if(consolidated.found && consolidated.selected){
      gdriveFileId=consolidated.selected.id;
      localStorage.setItem('gdrive_file_id',gdriveFileId);
      localStorage.setItem('remote_file_id',gdriveFileId);

      try{
        await patchFile(gdriveFileId);
      }catch(e){
        if(e.status===403 || e.status===404){
          addLog('SYNC_UPLOAD_RECOVER_PATCH_FORBIDDEN', { selected_file_id: gdriveFileId, status: e.status, message: e.message });
          const newId = await createFile();
          gdriveFileId=newId;
          localStorage.setItem('gdrive_file_id',gdriveFileId);
          localStorage.setItem('remote_file_id',gdriveFileId);
        }else{
          throw e;
        }
      }
    }else{
      const newId = await createFile();
      gdriveFileId=newId;
      localStorage.setItem('gdrive_file_id',gdriveFileId);
      localStorage.setItem('remote_file_id',gdriveFileId);
    }
  }

  localStorage.setItem('remote_last_count', String(P.length));
  localStorage.setItem('remote_last_update_read', String(nowTs));
  localStorage.setItem('gdrive_last_sync', String(nowTs));
  return { fileId: gdriveFileId, uploadedTs: nowTs, uploadedCount: P.length };
}

async function gdriveDownload(){
  const folderId=await gdriveFindOrCreateFolder();
  
  const response=await gapi.client.drive.files.list({
    q:`name='${GDRIVE_CONFIG.fileName}' and '${folderId}' in parents and trashed=false`,
    fields:'files(id,modifiedTime)',
    spaces:'drive',
    orderBy:'modifiedTime desc',
    pageSize:10
  });
  
  if(!response.result.files||response.result.files.length===0)return;
  
  const fileId=response.result.files[0].id;
  gdriveFileId=fileId;
  localStorage.setItem('gdrive_file_id',fileId);
  localStorage.setItem('remote_file_id',fileId);
  
  const fileResponse=await gapi.client.drive.files.get({
    fileId:fileId,
    alt:'media'
  });
  
  const data=fileResponse.result;
  if(data.products&&Array.isArray(data.products)){
    const remoteTime=data.lastUpdate||0;
    const localUpdate=localStorage.getItem('local_last_update')||0;
    
    if(remoteTime>parseInt(localUpdate)){
      P=sanitizeProductList(data.products);
      saveDB({ skipAutoSync: true });  // NO lanzar upload tras descarga
      render();
      showToast('Datos sincronizados desde Google Drive','info');
    }
  }
}

// Auto-sync al cargar
if(gdriveToken&&checkSession()){
  loadGoogleAPIs().then(()=>{
    if(gdriveToken){
      gapi.client.setToken({access_token:gdriveToken});
      setTimeout(()=>gdriveSmartSync('startup'),2000);
    }
  }).catch(err=>{
    addLog(LOG_LEVELS.ERROR,'GDRIVE_AUTOSTART_FAILED','No se pudo iniciar Google Drive al cargar la app',{
      service:'Google Drive',
      operation:'autostart',
      error:err&&err.message?err.message:String(err)
    });
  });
}

// Init
if(checkSession()){render();updateGDriveUI();updateSyncStatusUI();if(photoQueue.length&&navigator.onLine&&getApiKey())setTimeout(processQueue,1000)}
</script>
</body>
</html>
